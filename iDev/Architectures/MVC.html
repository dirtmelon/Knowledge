<!DOCTYPE HTML>
<html lang="zh-CN" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>MVC - Knowledge</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../About.html">关于</a></li><li class="chapter-item expanded "><a href="../../programming-languages/programming-languages.html">编程语言</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../programming-languages/Swift/Swift.html">Swift</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Objective-C.html">Objective-C</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Objective-C.html">Runtime</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/associated-objects.html">Associated Objects</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/initialize.html">initialize</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/load.html">load</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Block.html">Block</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Category.html">Category</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Message-Sending-And-Forwarding.html">Message Sending And Forwarding</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/KVO.html">KVO</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/KVC.html">KVC</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/AutoreleasePool.html">AutoreleasePool</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/dealloc.html">dealloc</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Tagged-Pointer.html">Tagged Pointer</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/weak.html">weak</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Object.html">Object</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/reference-counting.html">Reference Counting</a></li></ol></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Objective-C.html">Tips</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/getting-subclasses-of-objective-c-class.html">如何获取某个类的全部子类</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/objective-c-class-properties.html">Objective-C 类属性</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../iDev/iDev.html">iDev</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../iDev/Multithreading/Introduction.html">多线程</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../iDev/Multithreading/NSOperation.html">NSOperation</a></li><li class="chapter-item expanded "><a href="../../iDev/Multithreading/Grand-Central-Dispatch.html">Grand Central Dispatch</a></li><li class="chapter-item expanded "><a href="../../iDev/Multithreading/thread.html">pthread 和 NSThread</a></li><li class="chapter-item expanded "><a href="../../iDev/Multithreading/locks.html">Locks</a></li><li class="chapter-item expanded "><a href="../../iDev/Multithreading/RunLoop.html">RunLoop</a></li></ol></li><li class="chapter-item expanded "><a href="../../iDev/UIKit/UIKit.html">UIKit</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../iDev/UIKit/touches_presses_and_gestures.html">点击，按压与手势</a></li></ol></li><li class="chapter-item expanded "><a href="../../iDev/Architectures/Architectures.html">Architectures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../iDev/Architectures/MVC.html" class="active">MVC</a></li><li class="chapter-item expanded "><a href="../../iDev/Architectures/MVVM.html">MVVM</a></li></ol></li><li class="chapter-item expanded "><a href="../../iDev/Performance/Performance.html">性能优化</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../iDev/Performance/FPS.html">FPS</a></li><li class="chapter-item expanded "><a href="../../iDev/Performance/Size.html">包大小</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../books/books.html">阅读</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../books/Homo-Deus-A-Brief-History-of-Tomorrow.html">未来简史</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Knowledge</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/dirtmelon/Knowledge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="mvc"><a class="header" href="#mvc">MVC</a></h1>
<h2 id="苹果关于-mvc-的介绍"><a class="header" href="#苹果关于-mvc-的介绍">苹果关于 MVC 的介绍</a></h2>
<p><a href="https://developer.apple.com/library/archive/featuredarticles/ViewControllerPGforiPhoneOS/">The Role of View Controllers</a></p>
<h2 id="如何使-uiviewcontroller-更整洁"><a class="header" href="#如何使-uiviewcontroller-更整洁">如何使 UIViewController 更整洁</a></h2>
<p><a href="https://objccn.io/issue-1-1/">ObjC 中国 - 更轻量的 View Controllers</a></p>
<p><a href="https://objccn.io/issue-1-2/">ObjC 中国 - 整洁的 Table View 代码</a></p>
<h2 id="如何写出更好的-mvc"><a class="header" href="#如何写出更好的-mvc">如何写出更好的 MVC</a></h2>
<p><a href="https://davedelong.com/blog/2017/11/06/a-better-mvc-part-1-the-problems/">A Better MVC, Part 1: The Problems</a></p>
<p>问题：</p>
<ol>
<li>违反封装，充斥着大量面条代码</li>
<li>Massview View Controller</li>
</ol>
<p>解决办法：
开发者为了解决上面两个问题通常会使用其它架构方式。但是会增加团队成员的学习成本。系统更新时也有可能需要更多时间来进行适配，同样地，如果你依赖了其它第三库，还需要等得第三库的更新。</p>
<p><a href="https://davedelong.com/blog/2017/11/06/a-better-mvc-part-2-fixing-encapsulation/">A Better MVC, Part 2: Fixing Encapsulation</a></p>
<p>对 View Controller 进行解耦，View Controller 不需要知道其它 View Controller ，做法是生成一个更高层 View Controller，这个 View Controller 不包含其它逻辑，只负责对 View Controller 的跳转进行处理。所有子 View Controller 都通过它来进行跳转。</p>
<p><a href="https://davedelong.com/blog/2017/11/06/a-better-mvc-part-3-fixing-massive-view-controller/">A Better MVC, Part 3: Fixing Massive View Controller</a></p>
<p>1 View Controller ≠ 1 screen of content</p>
<p>开始写 app 时，我们都会使用一个 View Controller 来表示一个屏幕的内容，但是当 app 变得复杂时，我们可以将某些比较复杂的界面分成多个小的 View Controller。</p>
<p><a href="https://davedelong.com/blog/2017/11/06/a-better-mvc-part-4-future-directions/">A Better MVC, Part 4: Future Directions</a></p>
<p>承接上面所说的 1 View Controller ≠ 1 screen of content，单个 cell 也可以使用单个 ViewController 来管理，将 cell 中的逻辑分离出来。
总结：</p>
<ul>
<li>使用 View Controllers 来分解 UI</li>
<li>使用 View Controllers 来管理列表控件</li>
<li>View Controllers 不一定要填充屏幕</li>
</ul>
<p><a href="https://davedelong.com/blog/2018/04/24/a-better-mvc-part-5-an-evolution/">A Better MVC, Part 5: An Evolution</a></p>
<p>作者在五个月后又写了一篇关于 MVC 的文章。</p>
<p>MVC 不是一种设计模式，是一种思想，它追求封装，将不同的东西分隔开来。
View Controller 其实不是 Controller，而是 View，它负责的其实是 View 相关的逻辑。
View Controller 应该只负责处理业务逻辑或者传递数据给它包含的 UIViews，不应该两者都包含。
UIViewControllers 应该只负责下面的其中一个部分：</p>
<ol>
<li>组合 Child View Controller</li>
<li>给自己拥有的 UIViews 填充数据</li>
</ol>
<blockquote>
<p>So instead of saying a UIViewController should “manage either sequence or UI”, perhaps a better way of saying it would be that a UIViewController should either compose children or put stuff in to UIViews (with the understanding that this is a guideline, and not a rule).</p>
</blockquote>
<h2 id="关于-mvc-的一个常见的误用"><a class="header" href="#关于-mvc-的一个常见的误用">关于 MVC 的一个常见的误用</a></h2>
<p><a href="https://onevcat.com/2018/05/mvc-wrong-use/">关于 MVC 的一个常见的误用</a></p>
<p>传统 MVC 由于自由度非常大，没有规则显示，在经过业务迭代后，稍不注意 ViewController 就会膨胀为 Massive View Controller ，一些潜在问题：</p>
<ol>
<li>包含 Model 层；</li>
<li>违反数据流动规则和单一职责。</li>
</ol>
<p><img src="media/16324010421073.jpg" alt="" /></p>
<p>作者通过将 Model 层抽出和借助 KVO 简单录了一个单向流的 MVC ，意在说明即使没有借用其他结构（比如说 MVVM 和 RxSwift ），也可以写出一个符合规范和易维护的 ViewController 。</p>
<h2 id="单向流数据流动"><a class="header" href="#单向流数据流动">单向流数据流动</a></h2>
<p><a href="https://onevcat.com/2017/07/state-based-viewcontroller/">单向数据流动的函数式 View Controller</a></p>
<p>传统 MVC 的问题：</p>
<ol>
<li>修改 UI 的代码到处散落，随着逻辑变得复杂， UI 的状态将难以追踪；</li>
<li>难以测试；</li>
<li>无法重构。</li>
</ol>
<p>结合纯函数将其重构为单向流：</p>
<pre><code class="language-swift">func reducer(state: State, userAction: Action) -&gt; State
</code></pre>
<p>输出结果 <code>State</code> 只受输入 <code>state</code> 和 <code>userAction</code> 影响，在两者相同的情况下，输出 <code>state</code> 永远相同，其原理与 Swift 中的 <code>reduce</code> 函数类似：</p>
<pre><code class="language-swift">func reduce&lt;Result&gt;(_ initialResult: Result, 
                    _ nextPartialResult: (Result, Element) throws -&gt; Result) rethrows -&gt; Result
</code></pre>
<p>在实际使用中，仅仅靠纯函数可能无法满足我们的需求，有时候还希望有“副作用”选项，希望在完成异步操作后可以执行对应的 <code>command</code> ：</p>
<pre><code class="language-swift">func reducer(state: State, userAction: Action) -&gt; (State, Command?)
</code></pre>
<p>整体的架构图</p>
<p><img src="media/16324010666112.jpg" alt="" /></p>
<p>使用一个 <code>Store</code> 来存储 <code>subscriber</code> 和相关数据：</p>
<pre><code class="language-swift">protocol ActionType {}
protocol StateType {}
protocol CommandType {}

class Store&lt;A: ActionType, S: StateType, C: CommandType&gt; {
    let reducer: (_ state: S, _ action: A) -&gt; (S, C?)
    var subscriber: ((_ state: S, _ previousState: S, _ command: C?) -&gt; Void)?
    var state: S
    
    init(reducer: @escaping (S, A) -&gt; (S, C?), initialState: S) {
        self.reducer = reducer
        self.state = initialState
    }
    
    func subscribe(_ handler: @escaping (S, S, C?) -&gt; Void) {
        self.subscriber = handler
    }
    
    func unsubscribe() {
        self.subscriber = nil
    }
    
    func dispatch(_ action: A) {
        let previousState = state
        let (nextState, command) = reducer(state, action)
        state = nextState
        subscriber?(state, previousState, command)
    }
}
</code></pre>
<p>ViewController 通过 <code>subscribe</code> 方法来订阅数据源的改动进行 UI 调整， 通过 <code>dispatch</code> 传递 <code>action</code> 。同时也编写了一些单元测试来证明其可测试性。</p>
<p>这里在没有接入三方库的情况实现了单向数据流，如果想要尝试，也可试一下 </p>
<p><a href="https://github.com/ReSwift/ReSwift">ReSwift/ReSwift</a></p>
<p>Objective-C 版本在这里：</p>
<p><a href="https://wereadteam.github.io/2017/09/30/reflow/">Objective-C单向数据流方案</a></p>
<p>提供了一个 <code>RFStore</code> 的 <code>Store</code> 基类，内部做了一些 <code>hook</code> 处理，对于 <code>action</code> 开头的 <code>selector</code> 调用，都会调用 <code>listeners</code>  的 <code>block</code> ：</p>
<pre><code class="language-objectivec">+ (void)hookActionMethodsIfNeededForClass:(Class)class {
    static const void * const kHasHookedKey = &amp;kHasHookedKey;
    @synchronized(class) {
        id hasHooked = objc_getAssociatedObject(class, kHasHookedKey);
        if (!hasHooked) {
            unsigned int outCount = 0;
            Method *methods = class_copyMethodList(class, &amp;outCount);
            for (unsigned int i = 0; i &lt; outCount; ++i) {
                Method method = methods[i];
                SEL selector = method_getName(method);
                NSString *methodName = NSStringFromSelector(selector);
                if (![methodName hasPrefix:@&quot;action&quot;]) {
                    continue;
                }
                
                [RFStore registerActionForClass:class selector:selector];
            }
            objc_setAssociatedObject(class, kHasHookedKey, @YES, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
        }
    }
}

+ (void)registerActionForClass:(Class)class selector:(SEL)selector {
    [class rfaspect_hookSelector:selector
                     withOptions:AspectPositionAfter
                      usingBlock:^(id&lt;RFAspectInfo&gt; aspectInfo) {
                          RFAction *action = [[RFAction alloc] initWithObject:aspectInfo.instance
                                                                     selector:selector
                                                                    arguments:aspectInfo.arguments];
                          
                          NSArray *globalListeners = [objc_getAssociatedObject([RFStore class], kListernersKey) allObjects];
                          NSArray *listeners = [objc_getAssociatedObject(action.object, kListernersKey) allObjects];
                          dispatch_async(dispatch_get_main_queue(), ^{
                              for (RFSubscription *subscription in globalListeners) {
                                  subscription.block(action);
                              }
                              for (RFSubscription *subscription in listeners) {
                                  subscription.block(action);
                              }
                          });
                      }
                           error:nil];
}
</code></pre>
<p><code>listeners</code> 使用 <code>weak</code> 的 <code>NSPointerArray</code> 进行存储，所以当 ViewController 释放后， <code>RFStore</code> 也会释放掉：</p>
<pre><code class="language-objectivec">+ (void)associateObject:(id)object withSubscription:(RFSubscription *)subscription {
    @synchronized(object) {
        NSPointerArray *listeners = objc_getAssociatedObject(object, kListernersKey);
        if (!listeners) {
            listeners = [NSPointerArray weakObjectsPointerArray];
            objc_setAssociatedObject(object, kListernersKey, listeners, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
        }
        [listeners compact];
        [listeners addPointer:(void *)subscription];
    }
}
</code></pre>
<p>作者在最后提到对于 Reflow ，更重要的是其架构设计和规范：</p>
<ul>
<li>model 对象不可变；</li>
<li>整个 app 的数据存于 store 层；</li>
<li>更新和通知也收拢于 store 层。</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../iDev/Architectures/Architectures.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../iDev/Architectures/MVVM.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../iDev/Architectures/Architectures.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../iDev/Architectures/MVVM.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
