<!DOCTYPE HTML>
<html lang="zh-CN" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>多线程 - Knowledge</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../About.html">关于</a></li><li class="chapter-item "><a href="../../programming-languages/programming-languages.html">编程语言</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../programming-languages/Swift/Swift.html">Swift</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/Objective-C.html">Objective-C</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../programming-languages/Objective-C/Objective-C.html">Runtime</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../programming-languages/Objective-C/associated-objects.html">Associated Objects</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/initialize.html">initialize</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/load.html">load</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/Block.html">Block</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/Category.html">Category</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/Message-Sending-And-Forwarding.html">Message Sending And Forwarding</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/KVO.html">KVO</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/KVC.html">KVC</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/AutoreleasePool.html">AutoreleasePool</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/dealloc.html">dealloc</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/Tagged-Pointer.html">Tagged Pointer</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/weak.html">weak</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/Object.html">Object</a></li></ol></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/Objective-C.html">Tips</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../programming-languages/Objective-C/getting-subclasses-of-objective-c-class.html">如何获取某个类的全部子类</a></li><li class="chapter-item "><a href="../../programming-languages/Objective-C/objective-c-class-properties.html">Objective-C 类属性</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../iDev/iDev.html">iDev</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../iDev/Multithreading/Introduction.html" class="active">多线程</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../iDev/Multithreading/NSOperation.html">NSOperation</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../books/books.html">阅读</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../books/Homo-Deus-A-Brief-History-of-Tomorrow.html">未来简史</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Knowledge</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/dirtmelon/Knowledge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="多线程导读"><a class="header" href="#多线程导读">多线程导读</a></h1>
<h2 id="官方文档"><a class="header" href="#官方文档">官方文档</a></h2>
<p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/Introduction/Introduction.html">Introduction</a></p>
<p>中文版本：</p>
<p><a href="http://yulingtianxia.com/blog/2017/08/28/Threading-Programming-Guide-1/">Threading Programming Guide(1)</a></p>
<p><a href="http://yulingtianxia.com/blog/2017/09/17/Threading-Programming-Guide-2/">Threading Programming Guide(2)</a></p>
<p><a href="http://yulingtianxia.com/blog/2017/10/08/Threading-Programming-Guide-3/">Threading Programming Guide(3)</a></p>
<h2 id="官方的并行编程指南"><a class="header" href="#官方的并行编程指南">官方的并行编程指南</a></h2>
<p><a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/ConcurrencyandApplicationDesign/ConcurrencyandApplicationDesign.html">Concurrency and Application Design</a></p>
<h3 id="远离线程"><a class="header" href="#远离线程">远离线程</a></h3>
<h3 id="为什么要使用并行编程"><a class="header" href="#为什么要使用并行编程">为什么要使用并行编程</a></h3>
<ol>
<li>充分利用计算机的多核；</li>
<li>更好的用户体验。</li>
</ol>
<h3 id="为什么避免使用线程nsthread"><a class="header" href="#为什么避免使用线程nsthread">为什么避免使用线程（<code>NSThread</code>）</a></h3>
<ol>
<li>使用 <code>NSThread</code> 你需要自己管理线程池；</li>
<li>需要根据系统的状态调整线程的数量；</li>
<li>需要保持线程的高效运行，避免互相干扰。</li>
</ol>
<h3 id="dispatch-queues"><a class="header" href="#dispatch-queues">Dispatch Queues</a></h3>
<p>Dispatch Queues 是一种基于 C 的机制，可执行自定义任务，支持串行和并行，任务按照 FIFO 顺序执行。
优点：</p>
<ul>
<li>提供直观简单的接口；</li>
<li>提供自动和全面的线程池管理；</li>
<li>提供了优化后的速度；</li>
<li>更高效率的内存占用（线程栈帧不需要常驻内存）；</li>
<li>不需要与内核交互；</li>
<li>分发到异步队列的任务不会造成队列死锁；</li>
<li>优雅的扩展；</li>
<li>串行队列提供了一个比锁或者其它原始的同步方案更高效的替代品。</li>
</ul>
<h3 id="dispatch-sources"><a class="header" href="#dispatch-sources">Dispatch Sources</a></h3>
<p>Dispatch Sources 是一种基于 C 的机制，用于异步处理特定类型的系统。 Dispatch Source 会包含有关特定类型系统事件的信息，在事件发生时将特定的 block 提交给 Dispatch Queue 。你可以使用 Dispatch Sources 来监听以下几种类型的系统事件：</p>
<ul>
<li>Timer 定时器；</li>
<li>Signal 监听UNIX信号；</li>
<li>Descriptor-related events 监听文件和 Socket 相关操作；</li>
<li>Process-related events 监听进程相关状态；</li>
<li>Mach port events 监听 Mach 相关事件；</li>
<li>Custom events that you trigger 监听自定义事件；</li>
</ul>
<p>Dispatch sources 是 GCD 的一部分。</p>
<h3 id="operation-queues"><a class="header" href="#operation-queues">Operation Queues</a></h3>
<p>Operation Queue 是 Cocoa 提供的，和并行的 Dispatch Queue 是相同概念的东西，具体类型为 <code>NSOperationQueue</code> 类。跟 Dispatch Queue 保持 FIFO 的执行顺序不同， Operation Queue 支持自定义的执行顺序。你可以在定义任务时设置相关的依赖，以此来创造一个复杂的执行顺序图。</p>
<p>Operation Queue 中任务对应的类型为 <code>NSOperation</code> 类。<code>NSOperation</code> 封装了你需要执行的任务和所有相关的数据。 <code>NSOperation</code> 是一个抽象的基类，你可以自定义一些子类来执行自己的任务。系统也提供了一些特定的子类。</p>
<p><code>NSOperation</code> 提供了 KVO 通知，可用于监听任务的进度。Operation Queue 通常会并发执行任务，你可以通过设置依赖来保证它们按照所计划的顺序执行。</p>
<h3 id="asynchronous-design-techniques"><a class="header" href="#asynchronous-design-techniques">Asynchronous Design Techniques</a></h3>
<h3 id="define-your-applications-expected-behavior"><a class="header" href="#define-your-applications-expected-behavior">Define Your Application’s Expected Behavior</a></h3>
<p>当你想要给自己的应用添加并发代码时，你应该先定义好应用的预期行为，以此来验证接入并发编程后的行为是否正确以及测试性能收益。</p>
<p>定义相关任务和数据结构。理清各个任务间的依赖关系。</p>
<h3 id="factor-out-executable-units-of-work"><a class="header" href="#factor-out-executable-units-of-work">Factor Out Executable Units of Work</a></h3>
<p>找出任务的最小执行单元，将其封装进 <code>block</code> 或者 <code>NSOperation</code> ，然后派发到适当的队列中。不用担心任务分得太细而影响性能。队列会帮你处理好这一切，当然了，最好还是通过性能测试来调整任务大小。</p>
<h3 id="identify-the-queues-you-need"><a class="header" href="#identify-the-queues-you-need">Identify the Queues You Need</a></h3>
<p>确定好队列的属性。
当使用 GCD 时，如果需要特定的执行顺序，使用串行队列，如果不需要特定的执行队列，可使用并发队列或者多个队列。
当使用 <code>NSOperation</code> 时，可通过设置各个 <code>NSOperation</code> 之间的依赖来调整它们之间的执行顺序。</p>
<h3 id="tips-for-improving-efficiency"><a class="header" href="#tips-for-improving-efficiency">Tips for Improving Efficiency</a></h3>
<ul>
<li>如果你的应用已经受内存限制，那么现在直接使用计算值可能比从主内存加载缓存的值要快。 计算值直接使用处理器核心的寄存器和缓存，这比主内存快得多。 当然了，还是需要性能测试来确定是否有利于性能优化；</li>
<li>找出串行任务，尽力把它们变得更加并发。 如果由于某个任务依赖某些共享资源而必须串行执行该任务，请考虑更改架构以删除该共享资源。 可以考虑为每个需要共享资源的用户拷贝一份对应的资源，或者完全清除共享资源；</li>
<li>避免使用锁。Dispatch queue 和 Operation Queue 在大多数情况下都不需要使用锁。避免使用锁来保护共享资源，使用串行队列或者设置 NSOperation 间的依赖来确保以正确的顺序执行任务；</li>
<li>尽量使用系统框架。实现功能时优先考虑现有的系统 API 是否可以满足需求。</li>
</ul>
<h2 id="相关分类"><a class="header" href="#相关分类">相关分类</a></h2>
<p><a href="./NSOperation.html">NSOperation</a> </p>
<p><a href="https://www.notion.so/Grand-Central-Dispatch-a0f552b226b44f3fb8f6cdbc7a8d73fe">Grand Central Dispatch</a> </p>
<p><a href="https://www.notion.so/pthread-NSThread-c2839897019440aba14acdae51166ce5">pthread 和 NSThread</a> </p>
<p><a href="https://www.notion.so/Lock-794065e788bb4741a870c4434323de5b">Lock</a> </p>
<h2 id="相关文章"><a class="header" href="#相关文章">相关文章</a></h2>
<h3 id="objc-专题"><a class="header" href="#objc-专题">ObjC 专题</a></h3>
<p><a href="https://objccn.io/issue-2-1/">ObjC 中国 - 并发编程：API 及挑战</a></p>
<p><a href="https://objccn.io/issue-2-3/">ObjC 中国 - 底层并发 API</a></p>
<p><a href="https://objccn.io/issue-2-4/">ObjC 中国 - 线程安全类的设计</a></p>
<p><a href="https://objccn.io/issue-2-5/">ObjC 中国 - 测试并发程序</a></p>
<p><img src="media/16296020555796.jpg" alt="" /></p>
<h3 id="sindrilin-关于多线程的文章"><a class="header" href="#sindrilin-关于多线程的文章">Sindrilin 关于多线程的文章</a></h3>
<p><a href="http://sindrilin.com/2017/09/09/thread_safe.html"></a></p>
<p>如何保证线程安全，从原子性到线程锁（互斥，自旋，信号量），也说到了 <code>barrier</code> 操作。</p>
<p><a href="http://sindrilin.com/2017/09/27/producers_consumers.html"></a></p>
<h3 id="swift-专题"><a class="header" href="#swift-专题">Swift 专题</a></h3>
<p><a href="https://swift.gg/2017/09/04/all-about-concurrency-in-swift-1-the-present/">Swift 中的并发编程(第一部分：现状）</a></p>
<p>这篇文章介绍了 Swift 未支持协程 ( <code>async/await</code> )前的并发编程模式，很好地总结了 Swift 中目前可用的外部并发框架，包括锁类型， GCD 和操作队列。</p>
<p>Swift 3 中已经去掉了 <code>dispatch_once</code> ， <code>dispatch_once</code> 在 Objective-C 中常用于构建线程安全的单例。在 Swift 中可以通过全局常量来初始化单例，Swift 确保使用原子化的方式来进行初始化：</p>
<pre><code class="language-swift">final class Singleton {

    public static let sharedInstance: Singleton = Singleton()

    private init() { }

    ...
}
</code></pre>
<p>也可以通过串行队列加 token 实现类似 <code>dispatch_once</code> 功能：</p>
<pre><code class="language-swift">import Foundation

public extension DispatchQueue {
    
    private static var onceTokens = [Int]()
    private static var internalQueue = DispatchQueue(label: &quot;dispatchqueue.once&quot;)
    
    public class func once(token: Int, closure: (Void)-&gt;Void) {
        internalQueue.sync {
            if onceTokens.contains(token) {
                return
            }else{
                onceTokens.append(token)
            }
            closure()
        }
    }
}

let t = 1
DispatchQueue.once(token: t) {
    print(&quot;only once!&quot;)
}
DispatchQueue.once(token: t) {
    print(&quot;Two times!?&quot;)
}
DispatchQueue.once(token: t) {
    print(&quot;Three times!!?&quot;)
}
</code></pre>
<p>Swift 3 新增了一个函数，可用于判断任务是否在预期的队列中执行， <code>DispatchPredicate</code> 提供了三个枚举值：</p>
<ul>
<li><code>onQueue</code> ：验证任务是否在指定队列中执行；</li>
<li><code>notOnQueue</code> ：与 <code>onQueue</code> 情况相反；</li>
<li><code>onQueueAsBarrier</code> ：验证当前任务是否作为一个队列的屏障。</li>
</ul>
<pre><code class="language-swift">dispatchPrecondition(condition: .notOnQueue(mainQueue))
dispatchPrecondition(condition: .onQueue(queue))
</code></pre>
<h3 id="重点"><a class="header" href="#重点">重点</a></h3>
<p><a href="https://juejin.im/post/6844904138623418376">iOS探索 多线程面试题分析</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../iDev/iDev.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../iDev/Multithreading/NSOperation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../iDev/iDev.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../iDev/Multithreading/NSOperation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
