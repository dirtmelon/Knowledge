<!DOCTYPE HTML>
<html lang="zh-CN" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Knowledge</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="programming-languages/programming-languages.html"><strong aria-hidden="true">1.</strong> ç¼–ç¨‹è¯­è¨€</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="programming-languages/Objective-C/Objective-C.html"><strong aria-hidden="true">1.1.</strong> Objective-C</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="programming-languages/Objective-C/associated-objects.html"><strong aria-hidden="true">1.1.1.</strong> Associated Objects</a></li><li class="chapter-item expanded "><a href="programming-languages/Objective-C/initialize.html"><strong aria-hidden="true">1.1.2.</strong> initialize</a></li><li class="chapter-item expanded "><a href="programming-languages/Objective-C/load.html"><strong aria-hidden="true">1.1.3.</strong> load</a></li><li class="chapter-item expanded "><a href="programming-languages/Objective-C/Block.html"><strong aria-hidden="true">1.1.4.</strong> Block</a></li><li class="chapter-item expanded "><a href="programming-languages/Objective-C/Category.html"><strong aria-hidden="true">1.1.5.</strong> Category</a></li><li class="chapter-item expanded "><a href="programming-languages/Objective-C/Message-Sending-And-Forwarding.html"><strong aria-hidden="true">1.1.6.</strong> Message Sending And Forwarding</a></li><li class="chapter-item expanded "><a href="programming-languages/Objective-C/KVO.html"><strong aria-hidden="true">1.1.7.</strong> KVO</a></li><li class="chapter-item expanded "><a href="programming-languages/Objective-C/KVC.html"><strong aria-hidden="true">1.1.8.</strong> KVC</a></li><li class="chapter-item expanded "><a href="programming-languages/Objective-C/AutoreleasePool.html"><strong aria-hidden="true">1.1.9.</strong> AutoreleasePool</a></li><li class="chapter-item expanded "><a href="programming-languages/Objective-C/dealloc.html"><strong aria-hidden="true">1.1.10.</strong> dealloc</a></li><li class="chapter-item expanded "><a href="programming-languages/Objective-C/Tagged-Pointer.html"><strong aria-hidden="true">1.1.11.</strong> Tagged Pointer</a></li><li class="chapter-item expanded "><a href="programming-languages/Objective-C/weak.html"><strong aria-hidden="true">1.1.12.</strong> weak</a></li><li class="chapter-item expanded "><a href="programming-languages/Objective-C/Object.html"><strong aria-hidden="true">1.1.13.</strong> Object</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Knowledge</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/dirtmelon/Knowledge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ç¼–ç¨‹è¯­è¨€"><a class="header" href="#ç¼–ç¨‹è¯­è¨€">ç¼–ç¨‹è¯­è¨€</a></h1>
<ul>
<li><a href="programming-languages/./Objective-C/Objective-C.html">Objective-C</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="objective-c"><a class="header" href="#objective-c">Objective-C</a></h1>
<h2 id="runtime"><a class="header" href="#runtime">Runtime</a></h2>
<p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008048-CH1-SW1">Runtime å®˜æ–¹æ–‡æ¡£</a></p>
<ul>
<li><a href="programming-languages/Objective-C/./associated-objects.html">Associated Objects</a></li>
<li><a href="programming-languages/Objective-C/./initialize.html">initialize</a></li>
<li><a href="programming-languages/Objective-C/./load.html">load</a></li>
<li><a href="programming-languages/Objective-C/./Block.html">Block</a></li>
<li><a href="programming-languages/Objective-C/./Category.html">Category</a></li>
<li><a href="programming-languages/Objective-C/./Message-Sending-And-Forwarding.html">Message Sending And Forwarding</a></li>
<li><a href="programming-languages/Objective-C/./KVO.html">KVO</a></li>
<li><a href="programming-languages/Objective-C/./KVC.html">KVC</a></li>
<li><a href="programming-languages/Objective-C/./AutoreleasePool.html">AutoreleasePool</a></li>
<li><a href="programming-languages/Objective-C/./dealloc.html">dealloc</a></li>
<li><a href="programming-languages/Objective-C/./Tagged-Pointer.html">Tagged Pointer</a></li>
<li><a href="programming-languages/Objective-C/./weak.html">weak</a></li>
<li><a href="programming-languages/Objective-C/./Object.html">Object</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="associated-objects"><a class="header" href="#associated-objects">Associated Objects</a></h1>
<p><a href="https://nshipster.com/associated-objects/">Associated Objects</a></p>
<p>é€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªå‡½æ•°å¯ä»¥è¿›è¡Œå…³è”å¯¹è±¡çš„ç›¸å…³æ“ä½œï¼š</p>
<pre><code class="language-objectivec">void objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy);
id objc_getAssociatedObject(id object, const void *key);
void objc_removeAssociatedObjects(id object);
</code></pre>
<p><code>key</code> åº”è¯¥æ˜¯å¸¸é‡çš„ï¼Œå”¯ä¸€çš„ï¼Œåœ¨ <code>setter</code> å’Œ <code>getter</code> æ–¹æ³•ä¸­å¯ä»¥è¿›è¡Œè®¿é—®ï¼š</p>
<pre><code class="language-objectivec">static char kAssociatedObjectKey;

objc_getAssociatedObject(self, &amp;kAssociatedObjectKey);
</code></pre>
<p>ä½†æ˜¯ç”±äº <code>selector</code> æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>selector</code> ï¼š</p>
<p><a href="https://twitter.com/bbum/status/3609098005">https://twitter.com/bbum/status/3609098005</a></p>
<p>ä¸è¦è°ƒç”¨ <code>objc_removeAssociatedObjects</code> æ¥ç§»é™¤å…³è”å¯¹è±¡ï¼Œå› ä¸ºä¼šç§»é™¤æ‰€æœ‰å…³è”å¯¹è±¡ã€‚æ­£ç¡®çš„åšæ³•æ˜¯è°ƒç”¨ <code>objc_setAssociatedObject</code> æ–¹æ³•å¹¶ä¼ å…¥ <code>nil</code> æ¥æ¸…é™¤å…³è”ã€‚</p>
<blockquote>
<p>æ¯”èµ·å…¶ä»–è§£å†³é—®é¢˜çš„æ–¹æ³•ï¼Œå…³è”å¯¹è±¡åº”è¯¥è¢«è§†ä¸ºæœ€åçš„é€‰æ‹©ï¼ˆäº‹å®ä¸Šå…³è”å¯¹è±¡ä¹Ÿä¸åº”è¯¥ä½œä¸ºé¦–é€‰æ–¹æ³•ï¼‰ã€‚</p>
</blockquote>
<h2 id="associatedobject-è§£æ"><a class="header" href="#associatedobject-è§£æ">AssociatedObject è§£æ</a></h2>
<p><a href="https://draveness.me/ao/">å…³è”å¯¹è±¡ AssociatedObject å®Œå…¨è§£æ - é¢å‘ä¿¡ä»°ç¼–ç¨‹</a></p>
<ul>
<li>å…³è”å¯¹è±¡å…¶å®å°±æ˜¯Â <code>ObjcAssociation</code>Â å¯¹è±¡</li>
<li>å…³è”å¯¹è±¡ç”±Â <code>AssociationsManager</code>Â ç®¡ç†å¹¶åœ¨Â <code>AssociationsHashMap</code>Â å­˜å‚¨</li>
<li>å¯¹è±¡çš„æŒ‡é’ˆä»¥åŠå…¶å¯¹åº”Â <code>ObjectAssociationMap</code>Â ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨åœ¨Â <code>AssociationsHashMap</code>Â ä¸­</li>
<li><code>ObjectAssociationMap</code>Â åˆ™æ˜¯ç”¨äºå­˜å‚¨å…³è”å¯¹è±¡çš„æ•°æ®ç»“æ„</li>
<li>æ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªæ ‡è®°ä½Â <code>has_assoc</code>Â æŒ‡ç¤ºå¯¹è±¡æ˜¯å¦å«æœ‰å…³è”å¯¹è±¡</li>
</ul>
<h2 id="ios-ä¸­çš„å…³è”å¯¹è±¡"><a class="header" href="#ios-ä¸­çš„å…³è”å¯¹è±¡">iOS ä¸­çš„å…³è”å¯¹è±¡</a></h2>
<p><a href="https://kingcos.me/posts/2019/associated_objects_in_ios/">iOS ä¸­çš„å…³è”å¯¹è±¡</a></p>
<p><img src="programming-languages/Objective-C/media/16295230050442.jpg" alt="" /></p>
<h2 id="åº”ç”¨"><a class="header" href="#åº”ç”¨">åº”ç”¨</a></h2>
<p><a href="https://github.com/ChenYilong/CYLDeallocBlockExecutor">ChenYilong/CYLDeallocBlockExecutor</a></p>
<p>é€šè¿‡ <code>Associated Objects</code> åœ¨å¯¹è±¡ <code>dealloc</code> ä¼šé‡Šæ”¾çš„åŸç†ï¼Œå¯ä»¥ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå±æ€§ï¼Œç„¶ååœ¨è¿™ä¸ªå±æ€§ <code>dealloc</code> æ—¶è¿›è¡Œç›¸å…³æ“ä½œï¼Œå¯ä»¥è¾¾åˆ°å¯¹è±¡ <code>dealloc</code> è¿›è¡Œå¯¹åº”æ“ä½œçš„ç›®çš„ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="initialize"><a class="header" href="#initialize">initialize</a></h1>
<h2 id="å®˜æ–¹æ–‡æ¡£"><a class="header" href="#å®˜æ–¹æ–‡æ¡£">å®˜æ–¹æ–‡æ¡£</a></h2>
<p><a href="https://developer.apple.com/documentation/objectivec/nsobject/1418639-initialize">Apple Developer Documentation</a></p>
<ol>
<li><code>initialize</code> ä¼šåœ¨ç¬¬ä¸€æ¬¡ç»™å½“å‰ç±»å‘é€æ¶ˆæ¯ï¼ˆå³è°ƒç”¨æ–¹æ³•ï¼‰æ—¶è°ƒç”¨ï¼›</li>
<li>å…ˆè°ƒç”¨çˆ¶ç±»çš„ï¼Œå†è°ƒç”¨å­ç±»çš„ï¼›</li>
<li><code>initialize</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒä¼šåœ¨ç¬¬ä¸€æ¬¡ç»™ç±»å‘é€æ¶ˆæ¯çš„å½“å‰çº¿ç¨‹ä¸­è¿è¡Œï¼Œè€Œå…¶å®ƒçº¿ç¨‹å°è¯•ç»™ç±»å‘é€æ¶ˆæ¯çš„çº¿ç¨‹åˆ™éœ€è¦ç­‰å¾… <code>initialize</code> æ‰§è¡Œå®Œæ¯•ï¼›</li>
<li>å¦‚æœå­ç±»æ²¡æœ‰å®ç° <code>initialize</code> æ–¹æ³•ï¼Œåˆ™ä¼šè°ƒç”¨çˆ¶ç±»çš„ï¼Œæ‰€ä»¥ä¸€ä¸ª <code>initialize</code> æœ‰å¯èƒ½ä¼šå¤šæ¬¡è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹å½“å‰ç±»è¿›è¡Œåˆ¤æ–­æ¥é˜²æ­¢å¤šæ¬¡è°ƒç”¨ï¼›</li>
<li>å› ä¸º <code>initialize</code> æœ‰é˜»å¡æœºåˆ¶ï¼Œæ‰€ä»¥å°½é‡ä¸è¦æ‰§è¡Œå¤æ‚çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œä¸ç„¶æœ‰å¯èƒ½ä¼šé€ æˆæ­»é”ï¼›</li>
<li>æ¯ä¸ªç±»çš„ <code>initialize</code> æ–¹æ³•åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœéœ€è¦åˆ†ç±»å’Œç±»çš„åˆå§‹åŒ–æ–¹æ³•éƒ½æ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨ <code>load</code> æ–¹æ³•ã€‚</li>
</ol>
<p>å¦‚ä½•é˜²æ­¢ <code>initialize</code> æ–¹æ³•å¤šæ¬¡è°ƒç”¨ï¼š</p>
<pre><code class="language-objectivec">+ (void)initialize {
  if (self == [ClassName self]) {
    // ... do the initialization ...
  }
}
</code></pre>
<h2 id="æºç è§£æ"><a class="header" href="#æºç è§£æ">æºç è§£æ</a></h2>
<p><a href="https://github.com/draveness/analyze/blob/master/contents/objc/%E6%87%92%E6%83%B0%E7%9A%84%20initialize%20%E6%96%B9%E6%B3%95.md">draveness/analyze</a></p>
<p><code>initialize</code> çš„æºç è§£æï¼Œä¸Â <code>load</code>Â ä¸åŒï¼Œ<code>initialize</code>Â æ–¹æ³•è°ƒç”¨æ—¶ï¼Œæ‰€æœ‰çš„ç±»éƒ½<strong>å·²ç»åŠ è½½</strong>åˆ°äº†å†…å­˜ä¸­ã€‚</p>
<h2 id="å¦‚ä½•åœ¨-swift-ä¸­ä½¿ç”¨-initialize"><a class="header" href="#å¦‚ä½•åœ¨-swift-ä¸­ä½¿ç”¨-initialize">å¦‚ä½•åœ¨ Swift ä¸­ä½¿ç”¨ <code>initialize</code></a></h2>
<p><a href="http://jordansmith.io/handling-the-deprecation-of-initialize/">Handling the Deprecation of initialize()</a></p>
<p><code>load</code> å’Œ <code>initialize</code> æ–¹æ³•åœ¨ Swift ä¸­éƒ½ä¸ä¼šè°ƒç”¨ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªæ›¿ä»£çš„æ–¹æ¡ˆï¼Œåœ¨ Swift ä¸­ä¹Ÿå¯ä»¥èµ·åˆ° <code>load</code> æˆ–è€… <code>initialize</code> çš„ä½œç”¨ã€‚</p>
<p>ä¸€ä¸ªç®€å•çš„æ›¿ä»£æ–¹æ¡ˆï¼š</p>
<p>ç›´æ¥åœ¨ <code>delegate</code> çš„ <code>application(_:didFinishLaunchingWithOptions:)</code> çš„æ–¹æ³•ä¸­è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼Œä½†æ˜¯è¿™æ ·ä¼šæœ‰ä¸å°‘ç¼ºç‚¹ï¼š</p>
<ul>
<li>å¯èƒ½æœ‰å¤§é‡çš„ç±»éœ€è¦å¤„ç†ï¼Œè¿™ä¼šä½¿å¾— <code>delegate</code> å˜å¾—ç¬¨é‡ï¼Œå› ä¸ºå®ƒç›´æ¥ä¾èµ–äº†è¿™äº›ç±»ï¼Œå³ä½¿è¯´æŠŠè¿™éƒ¨åˆ†çš„æ–¹æ³•è°ƒç”¨æŒªè‡³å•ç‹¬çš„åŠŸèƒ½æ¨¡å—ä¸­ï¼Œè¿™ä¸ªæ¨¡å—ä¹Ÿæ˜¯ç›´æ¥ä¾èµ–è¿™äº›ç±»ï¼›</li>
<li>å¯èƒ½è¯´æ²¡æœ‰æƒé™æ¥è·å– <code>delegate</code> ï¼Œåœ¨åªæ˜¯è´Ÿè´£å¼€å‘å…¶ä¸­ä¸€å°éƒ¨åˆ†æˆ–è€…åªæ˜¯ä¸€ä¸ª SDK æ—¶ä¼šæœ‰è¿™ç§æƒ…å†µå‘ç”Ÿã€‚</li>
</ul>
<p>ä¸€ä¸ªä¸ç®€å•çš„æ›¿ä»£æ–¹æ¡ˆï¼š</p>
<p>è¿™ä¸ªæ–¹æ¡ˆå’Œ <code>load</code> æˆ–è€… <code>initialize</code> æ–¹æ³•ç±»ä¼¼ï¼Œä¸éœ€è¦ä¸»åŠ¨è°ƒç”¨ï¼Œä¹Ÿä¸ä¼šå½±å“ <code>delegate</code> ã€‚</p>
<p>é¦–å…ˆå®šä¹‰ä»¥ä¸‹ç±»å’Œåè®®ï¼š</p>
<pre><code class="language-swift">protocol SelfAware: class {
    static func awake()
}

class NothingToSeeHere {

    static func harmlessFunction() {

        let typeCount = Int(objc_getClassList(nil, 0))
        let types = UnsafeMutablePointer&lt;AnyClass?&gt;.allocate(capacity: typeCount)
        let safeTypes = AutoreleasingUnsafeMutablePointer&lt;AnyClass?&gt;(types)
        objc_getClassList(safeTypes, Int32(typeCount))
        for index in 0 ..&lt; typeCount { (types[index] as? SelfAware.Type)?.awake() }
        types.deallocate(capacity: typeCount)

    }

}
</code></pre>
<p>å¯ä»¥çœ‹åˆ° <code>harmlessFunction</code> æ–¹æ³•é€šè¿‡ <code>objc_getClassList</code> æ¥è·å–æ‰€æœ‰çš„ç±»ï¼Œå¦‚æœç±»æ”¯æŒ <code>SelfAware</code> çš„ <code>awake</code> æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œè°ƒç”¨ï¼Œæ¥ä¸‹æ¥éœ€è¦æ— ä¾µå…¥åœ°è°ƒç”¨ <code>harmlessFunction</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-swift">extension UIApplication {

    private static let runOnce: Void = {
        NothingToSeeHere.harmlessFunction()
    }()

    override open var next: UIResponder? {
        // Called before applicationDidFinishLaunching
        UIApplication.runOnce
        return super.next
    }

} 
</code></pre>
<p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªä¸å¥½çš„åœ°æ–¹ï¼Œå°±æ˜¯éœ€è¦é€šè¿‡ <code>objc_getClassList</code> æ¥è·å–æ‰€æœ‰çš„ç±»ï¼Œä¹Ÿå°±æ˜¯åªèƒ½æ˜¯ <code>Objective-C</code> çš„ç±»ï¼Œå¦‚æœæ˜¯çº¯ Swift çš„ç±»ï¼Œæ˜¯ä¸æ”¯æŒçš„ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="load"><a class="header" href="#load">load</a></h1>
<h2 id="åŸç†"><a class="header" href="#åŸç†">åŸç†</a></h2>
<p>å®˜æ–¹æ–‡æ¡£ï¼š</p>
<p><a href="https://developer.apple.com/documentation/objectivec/nsobject/1418815-load?language=objc">Apple Developer Documentation</a></p>
<p>The order of initialization is as follows:</p>
<ol>
<li>All initializers in any framework you link to.</li>
<li>AllÂ <code>+load</code>Â methods in your image.</li>
<li>All C++ static initializers and C/C++Â <code>__attribute__(constructor)</code>Â functions in your image.</li>
<li>All initializers in frameworks that link to you.</li>
</ol>
<p>In addition:</p>
<ul>
<li>A classâ€™sÂ <code>+load</code>Â method is called after all of its superclassesâ€™Â <code>+load</code>Â methods.</li>
<li>A categoryÂ <code>+load</code>Â method is called after the classâ€™s ownÂ <code>+load</code>Â method.</li>
</ul>
<p>è¿è¡Œæ—¶æœºï¼š Objective-C è¿è¡Œæ—¶ä¼šæ”¶é›†æ‰€æœ‰ <code>+load</code> æ–¹æ³•çš„ç±»ï¼Œç„¶ååœ¨é•œåƒåŠ è½½å®Œæˆåè°ƒç”¨ï¼Œæ—¶æœºåœ¨ä¸»å‡½æ•°è¿è¡Œå‰ã€‚</p>
<p>åˆå§‹åŒ–é¡ºåºï¼š</p>
<ol>
<li>æ‰§è¡Œå…¨éƒ¨é“¾æ¥åˆ°çš„æ¡†æ¶ä¸­çš„æ‰€æœ‰æ„é€ å™¨ï¼›</li>
<li>é•œåƒï¼ˆ Image ) ä¸­æ‰€æœ‰çš„ <code>+load</code> æ–¹æ³•ï¼›</li>
<li>é•œåƒ ï¼ˆ Image ï¼‰ä¸­æ‰€æœ‰ C++ é™æ€æ„é€ å™¨ï¼Œä»¥åŠ C/C++ çš„ <code>__attribute__(constructor)</code> æ–¹æ³•ï¼›</li>
<li>æ‰§è¡Œå…¨éƒ¨é“¾æ¥åˆ°å½“å‰æ¡†æ¶çš„å…¨éƒ¨æ¡†æ¶çš„æ‰€æœ‰æ„é€ å™¨.</li>
</ol>
<p>ç‰¹ç‚¹ï¼š</p>
<ol>
<li>ç±»çš„ <code>+load</code> æ–¹æ³•ä¼šåœ¨çˆ¶ç±»çš„ <code>+load</code> æ–¹æ³•è°ƒç”¨åå†è°ƒç”¨ï¼›</li>
<li>åˆ†ç±» <code>Category</code> çš„ <code>+load</code> æ–¹æ³•ä¼šåœ¨ç±»çš„ <code>+load</code> æ–¹æ³•åè°ƒç”¨ï¼›</li>
<li>Swift ä¸­æ¡¥æ¥åˆ° Objective-C çš„ç±»ä¸ä¼šè‡ªåŠ¨è°ƒç”¨ <code>+load</code> æ–¹æ³•ã€‚</li>
</ol>
<h2 id="ä½ çœŸçš„äº†è§£-load-æ–¹æ³•ä¹ˆ"><a class="header" href="#ä½ çœŸçš„äº†è§£-load-æ–¹æ³•ä¹ˆ">ä½ çœŸçš„äº†è§£ <code>load</code> æ–¹æ³•ä¹ˆï¼Ÿ</a></h2>
<p><a href="https://github.com/draveness/analyze/blob/master/contents/objc/%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%20load%20%E6%96%B9%E6%B3%95%E4%B9%88%EF%BC%9F.md">draveness/analyze</a></p>
<p>è¯¦ç»†è¯´æ˜äº† <code>+load</code> æ–¹æ³•çš„è°ƒç”¨æ—¶æœºï¼š</p>
<pre><code class="language-c">0  +[XXObject load]
1  call_class_loads()
2  call_load_methods
3  load_images
4  dyld::notifySingle(dyld_image_states, ImageLoader const*)
11 _dyld_start
</code></pre>
<p>åœ¨æœ‰æ–°çš„é•œåƒåŠ è½½åï¼Œéƒ½ä¼šè°ƒç”¨ <code>load_images</code> æ–¹æ³•è¿›è¡Œå›è°ƒï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯è¿è¡Œæ—¶åœ¨ <code>_objc_init</code> æ–¹æ³•ä¸­è¿›è¡Œæ³¨å†Œçš„ï¼š</p>
<pre><code class="language-objectivec">dyld_register_image_state_change_handler(dyld_image_state_dependents_initialized, 0/*not batch*/, &amp;load_images);
</code></pre>
<p>ç±»çš„ <code>+load</code> æ–¹æ³•ä¼šåœ¨çˆ¶ç±»çš„ <code>+load</code> æ–¹æ³•è°ƒç”¨åå†è°ƒç”¨ï¼š</p>
<pre><code class="language-objectivec">static void schedule_class_load(Class cls)
{
    if (!cls) return;
    // ç±»æ˜¯å¦å·²ç» realized
    assert(cls-&gt;isRealized());
		// åˆ¤æ–­ç±»æ˜¯å¦æœ‰è°ƒç”¨è¿‡ +load
    if (cls-&gt;data()-&gt;flags &amp; RW_LOADED) return;
		// é€’å½’è°ƒç”¨ï¼Œå…ˆæ‰§è¡Œçˆ¶ç±»çš„ +load æ–¹æ³•
    schedule_class_load(cls-&gt;superclass);
		// æ·»åŠ å½“å‰ç±»è‡³åˆ—è¡¨
    add_class_to_loadable_list(cls);
    // è®¾ç½®ä¸ºå·²è°ƒç”¨è¿‡ +load
    cls-&gt;setInfo(RW_LOADED); 
}
</code></pre>
<p>åˆ†ç±»çš„ <code>+load</code> æ–¹æ³•åœ¨ç±»ä¹‹åè°ƒç”¨ï¼š</p>
<pre><code class="language-objectivec">void call_load_methods(void)
{
    static bool loading = NO;
    bool more_categories;

    loadMethodLock.assertLocked();

    // åŠ è½½ä¸­ï¼Œç›´æ¥è¿”å›
    if (loading) return;
    loading = YES;

    void *pool = objc_autoreleasePoolPush();

    do {
        // è°ƒç”¨ç±»çš„ +load æ–¹æ³•ï¼Œç›´åˆ°åˆ—è¡¨ä¸ºç©º
        while (loadable_classes_used &gt; 0) {
            // â¡ï¸ è°ƒç”¨ç±»çš„ +load æ–¹æ³•
            call_class_loads();
        }

        // è°ƒç”¨åˆ†ç±»çš„ +load æ–¹æ³•ä¸€æ¬¡
        more_categories = call_category_loads();

        // å¦‚æœæœ‰ç±»æˆ–è€…åˆ†ç±»æœªè°ƒç”¨ +load æ–¹æ³•ï¼Œåˆ™å°è¯•å†è°ƒç”¨ä¸€æ¬¡
    } while (loadable_classes_used &gt; 0  ||  more_categories);

    objc_autoreleasePoolPop(pool);

    loading = NO;
}
</code></pre>
<p>è°ƒç”¨åˆ†ç±» <code>+load</code> æ–¹æ³•æ—¶éœ€è¦ç¡®ä¿ç±»å·²ç»åŠ è½½ï¼š</p>
<pre><code class="language-objectivec">if (cls  &amp;&amp;  cls-&gt;isLoadable()) {
    (*load_method)(cls, SEL_load);
    cats[i].cat = nil;
}
</code></pre>
<h2 id="ios-ä¸­çš„-load-æ–¹æ³•"><a class="header" href="#ios-ä¸­çš„-load-æ–¹æ³•">iOS ä¸­çš„ <code>+load</code> æ–¹æ³•</a></h2>
<p><a href="https://kingcos.me/posts/2019/+load_in_ios/">iOS ä¸­çš„ +load æ–¹æ³•</a></p>
<p><code>+load</code> æ–¹æ³•çš„æ‰§è¡Œæ—¶æœºéå¸¸é å‰ï¼Œè€Œä¸”åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬å¯èƒ½ä¼šé€šè¿‡ <code>+load</code> æ–¹æ³•æ¥æ‰§è¡Œä¸€äº› <code>hook</code> æ“ä½œï¼Œä½†æ˜¯å¦‚æœ <code>+load</code> æ–¹æ³•è¿‡å¤šæˆ–è€…æ–¹æ³•æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œå°±ä¼šå½±å“å¢åŠ åº”ç”¨çš„å¯åŠ¨æ—¶é—´ï¼Œæ‰€ä»¥åœ¨ç¼–å†™ <code>+load</code> æ–¹æ³•æ—¶éœ€è¦éå¸¸å°å¿ƒã€‚</p>
<h2 id="ç›‘æ§-load-æ–¹æ³•çš„è€—æ—¶"><a class="header" href="#ç›‘æ§-load-æ–¹æ³•çš„è€—æ—¶">ç›‘æ§ <code>+load</code> æ–¹æ³•çš„è€—æ—¶</a></h2>
<p>è¿™ç¯‡æ–‡ç« è®²è¿°äº†å¦‚ä½•ç›‘æ§ <code>+load</code> æ–¹æ³•çš„è€—æ—¶ï¼š</p>
<p><a href="https://triplecc.github.io/2019/05/27/%E8%AE%A1%E7%AE%97load%E8%80%97%E6%97%B6/">è®¡ç®— +load æ–¹æ³•çš„è€—æ—¶</a></p>
<p>å®ç°æœ‰ä»¥ä¸‹è¿™å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p>
<p>dyld åŠ è½½çš„é•œåƒä¸­åŒ…å«ç³»ç»Ÿçš„é•œåƒï¼Œéœ€è¦å¯¹è¿™å—åšè¿‡æ»¤ï¼›</p>
<pre><code class="language-objectivec">static bool isSelfDefinedImage(const char *imageName) {
    return !strstr(imageName, &quot;/Xcode.app/&quot;) &amp;&amp;
    !strstr(imageName, &quot;/Library/PrivateFrameworks/&quot;) &amp;&amp;
    !strstr(imageName, &quot;/System/Library/&quot;) &amp;&amp;
    !strstr(imageName, &quot;/usr/lib/&quot;);
}

static const struct mach_header **copyAllSelfDefinedImageHeader(unsigned int *outCount) {
    unsigned int imageCount = _dyld_image_count();
    unsigned int count = 0;
    const struct mach_header **mhdrList = NULL;
    
    if (imageCount &gt; 0) {
        mhdrList = (const struct mach_header **)malloc(sizeof(struct mach_header *) * imageCount);
        for (unsigned int i = 0; i &lt; imageCount; i++) {
            const char *imageName = _dyld_get_image_name(i);
            if (isSelfDefinedImage(imageName)) {
                const struct mach_header *mhdr = _dyld_get_image_header(i);
                mhdrList[count++] = mhdr;
            }
        }
        mhdrList[count] = NULL;
    }
    
    if (outCount) *outCount = count;
    
    return mhdrList;
}
</code></pre>
<p>å¦‚ä½•è·å–å®šä¹‰äº† <code>+load</code> çš„ç±»æˆ–è€…åˆ†ç±»ï¼Œåœ¨ç¼–è¯‘æ—¶æœŸï¼ŒåŒ…å« <code>+load</code> çš„ <code>class</code> å’Œ <code>category</code> ä¼šå†™å…¥ Mach-O æ–‡ä»¶ data æ®µçš„ <code>__objc_nlcslist</code> å’Œ <code>__objc_nlcatlist</code> èŠ‚ï¼Œå¯ä»¥é€šè¿‡è¯»å–è¿™ä¸¤éƒ¨åˆ†æ¥è·å– no lazy class å’Œ no lazy category åˆ—è¡¨ï¼Œå³å®šä¹‰äº† <code>+load</code> æ–¹æ³•çš„ç±»æˆ–è€…åˆ†ç±»</p>
<pre><code class="language-objectivec">static NSArray &lt;LMLoadInfo *&gt; *getNoLazyArray(const struct mach_header *mhdr) {
    NSMutableArray *noLazyArray = [NSMutableArray new];
    unsigned long bytes = 0;
    Class *clses = (Class *)getDataSection(mhdr, &quot;__objc_nlclslist&quot;, &amp;bytes);
    for (unsigned int i = 0; i &lt; bytes / sizeof(Class); i++) {
        LMLoadInfo *info = [[LMLoadInfo alloc] initWithClass:clses[i]];
        if (!shouldRejectClass(info.clsname)) [noLazyArray addObject:info];
    }
    
    bytes = 0;
    Category *cats = getDataSection(mhdr, &quot;__objc_nlcatlist&quot;, &amp;bytes);
    for (unsigned int i = 0; i &lt; bytes / sizeof(Category); i++) {
        LMLoadInfo *info = [[LMLoadInfo alloc] initWithCategory:cats[i]];
        if (!shouldRejectClass(info.clsname)) [noLazyArray addObject:info];
    }
    
    return noLazyArray;
}
</code></pre>
<p>hook <code>+load</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-objectivec">static void swizzleLoadMethod(Class cls, Method method, LMLoadInfo *info) {
retry:
    do {
        SEL hookSel = getRandomLoadSelector();
        Class metaCls = object_getClass(cls);
        IMP hookImp = imp_implementationWithBlock(^ {
            info-&gt;_start = CFAbsoluteTimeGetCurrent();
            ((void (*)(Class, SEL))objc_msgSend)(cls, hookSel);
            info-&gt;_end = CFAbsoluteTimeGetCurrent();
            if (!--LMAllLoadNumber) printLoadInfoWappers();
        });
        
        BOOL didAddMethod = class_addMethod(metaCls, hookSel, hookImp, method_getTypeEncoding(method));
        if (!didAddMethod) goto retry;
        
        info-&gt;_nSEL = hookSel;
        Method hookMethod = class_getInstanceMethod(metaCls, hookSel);
        method_exchangeImplementations(method, hookMethod);
    } while(0);
}

static void hookAllLoadMethods(LMLoadInfoWrapper *infoWrapper) {
    unsigned int count = 0;
    Class metaCls = object_getClass(infoWrapper.cls);
    Method *methodList = class_copyMethodList(metaCls, &amp;count);
    for (unsigned int i = 0; i &lt; count; i++) {
        Method method = methodList[i];
        SEL sel = method_getName(method);
        const char *name = sel_getName(sel);
        if (!strcmp(name, &quot;load&quot;)) {
            IMP imp = method_getImplementation(method);
            LMLoadInfo *info = [infoWrapper findLoadInfoByImp:imp];
            if (!info) {
                info = [infoWrapper findClassLoadInfo];
                if (!info) continue;
            }
            
            swizzleLoadMethod(infoWrapper.cls, method, info);
        }
    }
    free(methodList);
}
</code></pre>
<p>ç›¸åº”çš„å®ç°ï¼š</p>
<p><a href="https://github.com/tripleCC/Laboratory/tree/master/HookLoadMethods">tripleCC/Laboratory</a></p>
<h2 id="ä½¿ç”¨-load-è¿›è¡Œè‡ªåŠ¨å‘é€šçŸ¥å’Œè§£è€¦"><a class="header" href="#ä½¿ç”¨-load-è¿›è¡Œè‡ªåŠ¨å‘é€šçŸ¥å’Œè§£è€¦">ä½¿ç”¨ load è¿›è¡Œè‡ªåŠ¨å‘é€šçŸ¥å’Œè§£è€¦</a></h2>
<p><a href="https://blog.sunnyxx.com/2015/03/09/notification-once/">Notification Once</a></p>
<p>åˆ©ç”¨ <code>+load</code> çš„æ–¹æ³•è°ƒç”¨æ—¶æœºè¾ƒæ—©ï¼Œå®ç° <code>AppDelegate</code> çš„ç˜¦èº«ï¼š</p>
<pre><code class="language-objectivec">/// FooModule.m
+ (void)load
{
    __block id observer =
    [[NSNotificationCenter defaultCenter]
     addObserverForName:UIApplicationDidFinishLaunchingNotification
     object:nil
     queue:nil
     usingBlock:^(NSNotification *note) {
         [self setup]; // Do whatever you want
         [[NSNotificationCenter defaultCenter] removeObserver:observer];
     }];
}
</code></pre>
<ul>
<li><code>+ load</code>æ–¹æ³•åœ¨è¶³å¤Ÿæ—©çš„æ—¶é—´ç‚¹è¢«è°ƒç”¨ï¼›</li>
<li><code>block</code> ç‰ˆæœ¬çš„é€šçŸ¥æ³¨å†Œä¼šäº§ç”Ÿä¸€ä¸ª<code>__NSObserver *</code>å¯¹è±¡ç”¨æ¥ç»™å¤–éƒ¨ <code>remove</code> è§‚å¯Ÿè€…ï¼›</li>
<li><code>block</code> å¯¹ <code>observer</code> å¯¹è±¡çš„æ•è·æ—©äºå‡½æ•°çš„è¿”å›ï¼Œæ‰€ä»¥è‹¥ä¸åŠ <code>__block</code>ï¼Œä¼šæ•è·åˆ° <code>nil</code> ï¼›</li>
<li>åœ¨ <code>block</code> æ‰§è¡Œç»“æŸæ—¶ç§»é™¤ <code>observer</code> ï¼Œæ— éœ€å…¶ä»–æ¸…ç†å·¥ä½œï¼›</li>
<li>è¿™æ ·ï¼Œåœ¨æ¨¡å—å†…éƒ¨å°±å®Œæˆäº†åœ¨ç¨‹åºå¯åŠ¨ç‚¹ä»£ç çš„æŒ‚è½½ã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="block"><a class="header" href="#block">Block</a></h1>
<h2 id="æ·±å…¥ç ”ç©¶-block-æ•è·å¤–éƒ¨å˜é‡å’Œ-__block-å®ç°åŸç†"><a class="header" href="#æ·±å…¥ç ”ç©¶-block-æ•è·å¤–éƒ¨å˜é‡å’Œ-__block-å®ç°åŸç†">æ·±å…¥ç ”ç©¶ Block æ•è·å¤–éƒ¨å˜é‡å’Œ __block å®ç°åŸç†</a></h2>
<p><a href="https://halfrost.com/ios_block/">æ·±å…¥ç ”ç©¶ Block æ•è·å¤–éƒ¨å˜é‡å’Œ __block å®ç°åŸç†</a></p>
<p>é‡Œé¢æœ‰æåˆ°ä½œç”¨åŸŸï¼š</p>
<p><img src="programming-languages/Objective-C/media/16295345348106.jpg" alt="" /></p>
<ul>
<li><code>_NSConcreteStackBlock</code> ï¼šåªç”¨åˆ°å¤–éƒ¨å±€éƒ¨å˜é‡ã€æˆå‘˜å±æ€§å˜é‡ï¼Œä¸”æ²¡æœ‰å¼ºæŒ‡é’ˆå¼•ç”¨çš„ <code>block</code> éƒ½æ˜¯ <code>StackBlock</code> ã€‚ <code>StackBlock</code> çš„ç”Ÿå‘½å‘¨æœŸç”±ç³»ç»Ÿæ§åˆ¶çš„ï¼Œä¸€æ—¦è¿”å›ä¹‹åï¼Œå°±è¢«ç³»ç»Ÿé”€æ¯äº†ã€‚</li>
<li><code>_NSConcreteMallocBlock</code> ï¼šæœ‰å¼ºæŒ‡é’ˆå¼•ç”¨æˆ– <code>copy</code> ä¿®é¥°çš„æˆå‘˜å±æ€§å¼•ç”¨çš„ <code>block</code> ä¼šè¢«å¤åˆ¶ä¸€ä»½åˆ°å †ä¸­æˆä¸º <code>MallocBlock</code> ï¼Œæ²¡æœ‰å¼ºæŒ‡é’ˆå¼•ç”¨å³é”€æ¯ï¼Œç”Ÿå‘½å‘¨æœŸç”±ç¨‹åºå‘˜æ§åˆ¶</li>
<li><code>_NSConcreteGlobalBlock</code> ï¼šæ²¡æœ‰ç”¨åˆ°å¤–ç•Œå˜é‡æˆ–åªç”¨åˆ°å…¨å±€å˜é‡ã€é™æ€å˜é‡çš„ <code>block</code> ä¸º <code>_NSConcreteGlobalBlock</code> ï¼Œç”Ÿå‘½å‘¨æœŸä»åˆ›å»ºåˆ°åº”ç”¨ç¨‹åºç»“æŸã€‚</li>
</ul>
<p><code>__block</code> ç»“æ„ä½“ <code>__forwarding</code> ï¼š</p>
<p><img src="programming-languages/Objective-C/media/16295347079014.jpg" alt="" /></p>
<h2 id="block-æŠ€å·§ä¸åº•å±‚è§£æ"><a class="header" href="#block-æŠ€å·§ä¸åº•å±‚è§£æ">Block æŠ€å·§ä¸åº•å±‚è§£æ</a></h2>
<p><a href="https://triplecc.github.io/2015/07/19/2015-08-27-blockji-qiao-yu-di-ceng-jie-xi/">BlockæŠ€å·§ä¸åº•å±‚è§£æ</a></p>
<p>Block çš„å®é™…ç»“æ„ï¼š</p>
<pre><code class="language-objectivec">/* Revised new layout. */
struct Block_descriptor {
    unsigned long int reserved;
    unsigned long int size;
    void (*copy)(void *dst, void *src);
    void (*dispose)(void *);
};

struct Block_layout {
    void *isa;
    int flags;
    int reserved;
    void (*invoke)(void *, ...);
    struct Block_descriptor *descriptor;
    /* Imported variables. */
};
</code></pre>
<p><code>_NSConcreteMallocBlock</code> æ— æ³•ç›´æ¥åˆ›å»ºï¼Œåªèƒ½ <code>_NSConcreteStackBlock</code> æ‹·è´å¾—åˆ°ï¼Œè€Œ Block çš„æ‹·è´æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ <code>_Block_copy_internal</code> å‡½æ•°ï¼Œæ‰€ä»¥ä» <code>_Block_copy_internal</code> å‡½æ•°ä¸­å¯ä»¥å¾—å‡º <code>_NSConcreteMallocBlock</code> æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼š</p>
<pre><code class="language-objectivec">static void *_Block_copy_internal(const void *arg, const int flags) {
    struct Block_layout *aBlock;
	...
    aBlock = (struct Block_layout *)arg;
	...
    // Its a stack block.  Make a copy.
    if (!isGC) {
    	// ç”³è¯·blockçš„å †å†…å­˜
        struct Block_layout *result = malloc(aBlock-&gt;descriptor-&gt;size);
        if (!result) return (void *)0;
        // æ‹·è´æ ˆä¸­blockåˆ°åˆšç”³è¯·çš„å †å†…å­˜ä¸­
        memmove(result, aBlock, aBlock-&gt;descriptor-&gt;size); // bitcopy first
        // reset refcount
        result-&gt;flags &amp;= ~(BLOCK_REFCOUNT_MASK);    // XXX not needed
        result-&gt;flags |= BLOCK_NEEDS_FREE | 1;
        // æ”¹å˜isaæŒ‡å‘_NSConcreteMallocBlockï¼Œå³å †blockç±»å‹
        result-&gt;isa = _NSConcreteMallocBlock;
        if (result-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSE) {
            //printf(&quot;calling block copy helper %p(%p, %p)...\n&quot;, aBlock-&gt;descriptor-&gt;copy, result, aBlock);
            (*aBlock-&gt;descriptor-&gt;copy)(result, aBlock); // do fixup
        }
        return result;
    }
    else {
        ...
    }
}
</code></pre>
<p>å‡½æ•°é€šè¿‡ <code>memmove</code> å°†æ ˆä¸­çš„ Block çš„å†…å®¹æ‹·è´åˆ°äº†å †ä¸­ï¼Œå¹¶ä½¿ <code>isa</code> æŒ‡å‘äº† <code>_NSConcreteMallocBlock</code> ã€‚</p>
<p>Block çš„æ‹·è´ä»£ç åœ¨ <code>_Block_copy_internal</code> å‡½æ•°ä¸­ï¼Œæ ¹æ® Block çš„ç±»å‹ä¸åŒï¼Œæ‹·è´è¿‡ç¨‹ä¸­çš„æ“ä½œä¹Ÿä¸åŒã€‚</p>
<p>æ ˆ Block çš„æ‹·è´ä¸ä»…æ˜¯æ‹·è´äº†å†…å®¹ï¼Œè€Œä¸”ç”±äºä»æ ˆæ‹·è´åˆ°å †ä¸­ï¼Œè¿˜ä¼šè¿›è¡Œä¸€äº›é¢å¤–çš„æ“ä½œï¼š</p>
<ol>
<li>å¾€ <code>flags</code> ä¸­å¹¶å…¥ <code>BLOCK_NEEDS_FREE</code> ï¼Œå¹¶å°†å¼•ç”¨è®¡æ•°è®¾ç½®ä¸º 1ï¼Œè¡¨ç¤º Block éœ€è¦é‡Šæ”¾ï¼Œéœ€è¦è‡ªè¡Œ <code>release</code> ï¼›</li>
<li>å¦‚æœæœ‰è¾…åŠ© copy å‡½æ•° ( <code>BLOCK_HAS_COPY_DISPOSE</code> )ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨è¾…åŠ©  copy å‡½æ•°æ¥æ‹·è´ Block æ•è·çš„å˜é‡ã€‚</li>
</ol>
<pre><code class="language-objectivec">...
struct Block_layout *result = malloc(aBlock-&gt;descriptor-&gt;size);
if (!result) return (void *)0;
memmove(result, aBlock, aBlock-&gt;descriptor-&gt;size); // bitcopy first
// reset refcount
result-&gt;flags &amp;= ~(BLOCK_REFCOUNT_MASK);    // XXX not needed
result-&gt;flags |= BLOCK_NEEDS_FREE | 1;
result-&gt;isa = _NSConcreteMallocBlock;
if (result-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSE) {
    //printf(&quot;calling block copy helper %p(%p, %p)...\n&quot;, aBlock-&gt;descriptor-&gt;copy, result, aBlock);
    (*aBlock-&gt;descriptor-&gt;copy)(result, aBlock); // do fixup
}
return result;
...
</code></pre>
<p>å † Block ç”±äºå·²ç»æ‹·è´è‡³å †ä¸­ï¼Œæ‰€ä»¥å…¶æ‹·è´æ“ä½œæ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆéœ€è¦åˆ¤æ–­æ˜¯å¦æœ‰ <code>BLOCK_FREE</code> ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¡¨ç¤ºæ˜¯å † Block ï¼Œé‚£ä¹ˆåªéœ€è¦æ‰§è¡Œ <code>latching_incr_int</code> æ“ä½œï¼Œå°† Block çš„å¼•ç”¨è®¡æ•°åŠ  1 å³å¯ï¼Œåªéœ€è¦å•çº¯åœ°æ”¹å˜å¼•ç”¨è®¡æ•°ï¼š</p>
<pre><code class="language-objectivec">...
if (aBlock-&gt;flags &amp; BLOCK_NEEDS_FREE) {
      // latches on high
      latching_incr_int(&amp;aBlock-&gt;flags);
      return aBlock;
}
...
</code></pre>
<p>å…¨å±€ Block ä¸éœ€è¦æ‰§è¡Œä»»ä½•æ“ä½œï¼Œåªæ˜¯ç›´æ¥è¿”å›äº†ä¼ å…¥çš„ Block ï¼š</p>
<pre><code class="language-objectivec">...
else if (aBlock-&gt;flags &amp; BLOCK_IS_GLOBAL) {
      return aBlock;
}
...
</code></pre>
<pre><code class="language-objectivec">// flags/_flagsç±»å‹
enum {
        /* See function implementation for a more complete description of these fields and combinations */
        // æ˜¯ä¸€ä¸ªå¯¹è±¡
        BLOCK_FIELD_IS_OBJECT   =  3,  /* id, NSObject, __attribute__((NSObject)), block, ... */
        // æ˜¯ä¸€ä¸ªblock
        BLOCK_FIELD_IS_BLOCK    =  7,  /* a block variable */
        // è¢«__blockä¿®é¥°çš„å˜é‡
        BLOCK_FIELD_IS_BYREF    =  8,  /* the on stack structure holding the __block variable */
        // è¢«__weakä¿®é¥°çš„å˜é‡ï¼Œåªèƒ½è¢«è¾…åŠ©copyå‡½æ•°ä½¿ç”¨
        BLOCK_FIELD_IS_WEAK     = 16,  /* declared __weak, only used in byref copy helpers */
        // blockè¾…åŠ©å‡½æ•°è°ƒç”¨ï¼ˆå‘Šè¯‰å†…éƒ¨å®ç°ä¸è¦è¿›è¡Œretainæˆ–è€…copyï¼‰
        BLOCK_BYREF_CALLER      = 128  /* called from __block (byref) copy/dispose support routines. */
    };

// è®¾ç½®ä¸åŒå±æ€§å¯¹åº”çš„flags/_flagså€¼
__block id                   128+3
__weak block id              128+3+16
__block (^Block)             128+7
__weak __block (^Block)      128+7+16

struct Block_byref {
    void *isa;
    struct Block_byref *forwarding;
    int flags; /* refcount; */
    int size;
    void (*byref_keep)(struct Block_byref *dst, struct Block_byref *src);
    void (*byref_destroy)(struct Block_byref *);
    /* long shared[0]; */
};

// åšä¸‹å¯¹æ¯”
struct __Block_byref_a_0 {
  void *__isa;
__Block_byref_a_0 *__forwarding;
 int __flags;
 int __size;
 int a;
};
</code></pre>
<p><code>__block</code> å°†åŸæ¥çš„åŸºæœ¬ç±»å‹åŒ…è£…æˆäº†å¯¹è±¡ã€‚å› ä¸ºä»¥ä¸Šä¸¤ä¸ªç»“æ„ä½“çš„å‰ 4 ä¸ªæˆå‘˜çš„ç±»å‹éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå†…å­˜ç©ºé—´æ’åˆ—ä¸€è‡´ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<pre><code class="language-objectivec">// è½¬æ¢æˆC++ä»£ç 
static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) {_Block_object_assign((void*)&amp;dst-&gt;a, (void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);}

// _Block_object_assignæºç 
void _Block_object_assign(void *destAddr, const void *object, const int flags) {
...
    else if ((flags &amp; BLOCK_FIELD_IS_BYREF) == BLOCK_FIELD_IS_BYREF)  {
        // copying a __block reference from the stack Block to the heap
        // flags will indicate if it holds a __weak reference and needs a special isa
        _Block_byref_assign_copy(destAddr, object, flags);
    }
...
}

// _Block_byref_assign_copyæºç 
static void _Block_byref_assign_copy(void *dest, const void *arg, const int flags) {
    // è¿™é‡Œå› ä¸ºå‰é¢4ä¸ªæˆå‘˜çš„å†…å­˜åˆ†å¸ƒä¸€æ ·ï¼Œæ‰€ä»¥ç›´æ¥è½¬æ¢åï¼Œä½¿ç”¨Block_byrefçš„æˆå‘˜å˜é‡åï¼Œèƒ½è®¿é—®åˆ°__Block_byref_a_0çš„å‰é¢4ä¸ªæˆå‘˜
    struct Block_byref **destp = (struct Block_byref **)dest;
    struct Block_byref *src = (struct Block_byref *)arg;
...
    else if ((src-&gt;forwarding-&gt;flags &amp; BLOCK_REFCOUNT_MASK) == 0) {
        // ä»mainå‡½æ•°å¯¹__Block_byref_a_0çš„åˆå§‹åŒ–ï¼Œå¯ä»¥çœ‹åˆ°åˆå§‹åŒ–æ—¶å°†flagsèµ‹å€¼ä¸º0
        // è¿™é‡Œè¡¨ç¤ºç¬¬ä¸€æ¬¡æ‹·è´ï¼Œä¼šè¿›è¡Œå¤åˆ¶æ“ä½œï¼Œå¹¶ä¿®æ”¹åŸæ¥flagsçš„å€¼
        // static int _Byref_flag_initial_value = BLOCK_NEEDS_FREE | 2;
        // å¯ä»¥çœ‹å‡ºï¼Œå¤åˆ¶åï¼Œä¼šå¹¶å…¥BLOCK_NEEDS_FREEï¼Œåé¢çš„2æ˜¯åŒ…è£…å¯¹è±¡çš„åˆå§‹å¼•ç”¨è®¡æ•°ï¼ˆæ ˆä¸ŠæŒæœ‰+å †ä¸ŠæŒæœ‰ï¼‰
        ...
        copy-&gt;flags = src-&gt;flags | _Byref_flag_initial_value;
        ...
    }
    // å·²ç»æ‹·è´åˆ°å †äº†ï¼Œåªå¢åŠ å¼•ç”¨è®¡æ•°
    else if ((src-&gt;forwarding-&gt;flags &amp; BLOCK_NEEDS_FREE) == BLOCK_NEEDS_FREE) {
        latching_incr_int(&amp;src-&gt;forwarding-&gt;flags);
    }
    // æ™®é€šçš„èµ‹å€¼ï¼Œé‡Œé¢æœ€åº•å±‚å°±*destptr = value;è¿™å¥è¡¨è¾¾å¼
    _Block_assign(src-&gt;forwarding, (void **)destp);
}
</code></pre>
<p>å¯¹è±¡çš„è¾…åŠ©å‡½æ•°ï¼š</p>
<p>æ²¡æœ‰ <code>__block</code> ä¿®é¥°ï¼š</p>
<pre><code class="language-objectivec">typedef void(^Block)();
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        NSObject *a = [[NSObject alloc] init];
        Block block = ^ {
            a;
        };
    }
    return 0;
}
</code></pre>
<p>é¦–å…ˆï¼Œåœ¨æ²¡æœ‰ <code>__block</code> ä¿®é¥°æ—¶ï¼Œå¯¹è±¡ç¼–è¯‘è½¬æ¢çš„ç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-objectivec">static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  NSObject *a = __cself-&gt;a; // bound by copy
            a;
        }
static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) {_Block_object_assign((void*)&amp;dst-&gt;a, (void*)src-&gt;a, 3/*BLOCK_FIELD_IS_OBJECT*/);}

static void __main_block_dispose_0(struct __main_block_impl_0*src) {_Block_object_dispose((void*)src-&gt;a, 3/*BLOCK_FIELD_IS_OBJECT*/);}

static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
  void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);
  void (*dispose)(struct __main_block_impl_0*);
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0),
</code></pre>
<p>å¯¹è±¡åœ¨æ²¡æœ‰ <code>__block</code> ä¿®é¥°æ—¶ï¼Œå¹¶æ²¡æœ‰äº§ç”Ÿ <code>__Block_byref_a_0</code> ç»“æ„ä½“ï¼Œåªæ˜¯å°†æ ‡å¿—ä½ä¿®æ”¹ä¸º <code>BLOCK_FIELD_IS_OBJECT</code> ã€‚è€Œåœ¨ <code>_Block_object_assign</code> ä¸­å¯¹åº”çš„åˆ¤æ–­åˆ†æ”¯ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-objectivec"> v...
else if ((flags &amp; BLOCK_FIELD_IS_OBJECT) == BLOCK_FIELD_IS_OBJECT) {
    _Block_retain_object(object);
    _Block_assign((void *)object, destAddr);
}
...
</code></pre>
<p>Block åœ¨æ•è·å¯¹è±¡æ—¶ä¼šè¿›è¡Œ <code>retain</code> æ“ä½œï¼Œå¢åŠ å¼•ç”¨è®¡æ•°ã€‚</p>
<p>åœ¨æœ‰ <code>__block</code> ä¿®é¥°æ—¶ï¼š</p>
<pre><code class="language-objectivec">typedef void(^Block)();
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        __block NSObject *a = [[NSObject alloc] init];
        Block block = ^ {
            a;
        };
    }
    return 0;
}

// è½¬æ¢åï¼š
struct __Block_byref_a_0 {
  void *__isa;
__Block_byref_a_0 *__forwarding;
 int __flags;
 int __size;
 void (*__Block_byref_id_object_copy)(void*, void*);
 void (*__Block_byref_id_object_dispose)(void*);
 NSObject *a;
};
int main(int argc, const char * argv[]) {
    /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool;
attribute__((__blocks__(byref))) __Block_byref_a_0 a = {(void*)0,(__Block_byref_a_0 *)&amp;a, 33554432, sizeof(__Block_byref_a_0), __Block_byref_id_object_copy_131, __Block_byref_id_object_dispose_131,....};
Block block = (void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_a_0 *)&amp;a, 570425344);
}

// ä»¥ä¸‹çš„40è¡¨ç¤º__Block_byref_a_0å¯¹è±¡açš„ä½ç§»ï¼ˆ4ä¸ªæŒ‡é’ˆ(32å­—èŠ‚)ï¼‹2ä¸ªintå˜é‡(8å­—èŠ‚)ï¼40å­—èŠ‚ï¼‰
static void __Block_byref_id_object_copy_131(void *dst, void *src) {
 _Block_object_assign((char*)dst + 40, *(void * *) ((char*)src + 40), 131);
}
static void __Block_byref_id_object_dispose_131(void *src) {
 _Block_object_dispose(*(void * *) ((char*)src + 40), 131);
}
</code></pre>
<p><code>__Block_byref_a_0</code> æ–°å¢ä¸¤ä¸ªå†…å­˜ç®¡ç†çš„è¾…åŠ©å‡½æ•° <code>__Block_byref_id_object_copy</code> å’Œ <code>__Block_byref_id_object_dispose</code> ã€‚æœ€åçš„ <code>131</code> å‚æ•°è¡¨ç¤º <code>BLOCK_BYREF_CALLER|BLOCK_FIELD_IS_OBJECT</code> ï¼Œ <code>BLOCK_BYREF_CALLER</code> ç”¨äºè¡¨æ˜ä¸éœ€è¦å¯¹ <code>__block</code> ä¿®é¥°çš„ <code>a</code> å¯¹è±¡è¿›è¡Œ <code>retain</code> æˆ–è€… <code>copy</code> ï¼š</p>
<pre><code class="language-objectivec">if ((flags &amp; BLOCK_BYREF_CALLER) == BLOCK_BYREF_CALLER) {
	...
    else {
        // do *not* retain or *copy* __block variables whatever they are
        _Block_assign((void *)object, destAddr);
    }
}
</code></pre>
<p><code>_Block_byref_assign_copy</code> å‡½æ•°çš„ä»¥ä¸‹ä»£ç ä¼šå¯¹ä¸Šé¢çš„è¾…åŠ©å‡½æ•° <code>__Block_byref_id_object_copy_131</code> è¿›è¡Œè°ƒç”¨ï¼Œ <code>570425344</code> è¡¨ç¤º <code>BLOCK_HAS_COPY_DISPOSE|BLOCK_HAS_DESCRIPTOR</code> ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œä»¥ä¸‹ç›¸å…³æºç ï¼š</p>
<pre><code class="language-objectivec">if (src-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSE) {
    // Trust copy helper to copy everything of interest
    // If more than one field shows up in a byref block this is wrong XXX
    copy-&gt;byref_keep = src-&gt;byref_keep;
    copy-&gt;byref_destroy = src-&gt;byref_destroy;
    (*src-&gt;byref_keep)(copy, src);
}
</code></pre>
<h2 id="ä¸€é“-block-é¢è¯•é¢˜çš„æ·±å…¥æŒ–æ˜"><a class="header" href="#ä¸€é“-block-é¢è¯•é¢˜çš„æ·±å…¥æŒ–æ˜">ä¸€é“ Block é¢è¯•é¢˜çš„æ·±å…¥æŒ–æ˜</a></h2>
<p><a href="https://juejin.im/post/5eaa2a87e51d454db7436726">ä¸€é“Blocké¢è¯•é¢˜çš„æ·±å…¥æŒ–æ˜</a></p>
<p>å€Ÿç”± <code>NSNotificationCenter</code> å’Œ <code>token</code> è¯´æ˜å®é™…ç¼–ç ä¸­ Block éœ€è¦æ³¨æ„çš„åœ°æ–¹ä»¥åŠåŸç†ã€‚</p>
<h2 id="block-è¯­æ³•å¿«é€ŸæŸ¥è¯¢"><a class="header" href="#block-è¯­æ³•å¿«é€ŸæŸ¥è¯¢">Block è¯­æ³•å¿«é€ŸæŸ¥è¯¢</a></h2>
<p>ç”±äº Objective-C çš„ Block è¯­æ³•å®åœ¨æ˜¯å¤ªéš¾è®°äº†ï¼Œåè§‚ Swift ğŸ˜‚ ï¼Œæ‰€ä»¥æœ‰äº†è¿™ä¹ˆä¸€ä¸ªå¿«é€ŸæŸ¥çœ‹ Block è¯­æ³•çš„ç½‘ç«™ï¼š</p>
<p><a href="http://fuckingblocksyntax.com/">How Do I Declare A Block in Objective-C?</a></p>
<h2 id="obj-c-ä¸­çš„-block"><a class="header" href="#obj-c-ä¸­çš„-block">Obj-C ä¸­çš„ Block</a></h2>
<p><a href="https://kingcos.me/posts/2019/block_in_obj-c/">Obj-C ä¸­çš„ Block</a></p>
<p>Objective-C ä¸­çš„ Block ç›¸å½“äºåŒ¿åå‡½æ•°ã€‚</p>
<p>é€šè¿‡ <code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main.cpp</code> è½¬æ¢ä¸º C++ ä»£ç å¯ä»¥æŸ¥çœ‹ Block çš„ç»“æ„ä½“ã€‚</p>
<p><code>__main_3_block_impl_0</code> ä¸ºå…·ä½“ Block å¯¹åº”çš„ <code>struct</code> ï¼ŒåŒ…å« <code>__block_impl</code> å’Œ <code>__main_3_block_desc_0</code> ã€‚</p>
<pre><code class="language-objectivec">// Block å®ç°çš„ç»“æ„ä½“
struct __block_impl {
  void *isa;     // isa æŒ‡é’ˆï¼Œå³ Block ä¹Ÿæ˜¯ id ç±»å‹ï¼Œå³ Obj-C å¯¹è±¡
  int Flags;     // æ ‡è®°ï¼Œé»˜è®¤ä¼šè¢«åˆå§‹åŒ–ä¸º 0
  int Reserved;  // ä¿ç•™åŸŸï¼ˆABI å…¼å®¹ï¼‰ï¼Œé»˜è®¤ 0
  void *FuncPtr; // Block ä»£ç å—çš„å‡½æ•°æŒ‡é’ˆ
};

// â¡ï¸ Block ç»“æ„ä½“
struct __main_3_block_impl_0 {
  struct __block_impl impl;           // å®ç°ï¼ˆéæŒ‡é’ˆï¼‰
  struct __main_3_block_desc_0* Desc; // æè¿°ä¿¡æ¯ï¼ˆæŒ‡é’ˆï¼‰
  // æ„é€ å‡½æ•°
  __main_3_block_impl_0(void *fp, struct __main_3_block_desc_0 *desc, int flags=0) {
    impl.isa = &amp;_NSConcreteStackBlock; // Block ä½œä¸º Obj-C å¯¹è±¡ï¼Œé‚£ä¹ˆ isa å°†æŒ‡å‘å…¶ç±»å¯¹è±¡ï¼Œå³ _NSConcreteStackBlock
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};

// Block å†…ä»£ç å—å°è£…åœ¨è¯¥ C è¯­è¨€é™æ€å‡½æ•°ä¸­ï¼Œå‡½æ•°å‘½åè§„åˆ™ï¼š__CALLER_METHOD_NAME_block_func_NUMBER
// ç±»ä¼¼ Obj-C å®ä¾‹æ–¹æ³•å‚æ•° self æˆ– C++ å®ä¾‹æ–¹æ³•å‚æ•° thisï¼Œ__cself ä¸ºæŒ‡å‘ Block ç»“æ„ä½“çš„å˜é‡
static void __main_3_block_func_0(struct __main_3_block_impl_0 *__cself) {
  NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_ps_0m9gnvtj0893vpf1cr595djh0000gn_T_main_b9596e_mi_0);
}

// Block æè¿°ä¿¡æ¯çš„ç»“æ„ä½“é™æ€å˜é‡
static struct __main_3_block_desc_0 {
  size_t reserved;   // ä¿ç•™åŸŸï¼Œé»˜è®¤ 0
  size_t Block_size; // Block å¤§å°ï¼Œsizeof æ•´ä¸ª Block ç»“æ„ä½“ â¬‡ï¸
} __main_3_block_desc_0_DATA = { 0, sizeof(struct __main_3_block_impl_0)};

// ä¸»å‡½æ•°
int main_3(int argc, const char * argv[]) {
    // é€šè¿‡ __main_3_block_impl_0 ç»“æ„ä½“çš„æ„é€ å‡½æ•°åˆå§‹åŒ–ï¼Œå‚æ•°ä¸ºé™æ€å‡½æ•°å’Œæè¿°ä¿¡æ¯é™æ€å˜é‡çš„åœ°å€ï¼Œå°†åœ°å€å­˜å‚¨åœ¨ block å˜é‡ä¸­
    // å¿½ç•¥ç±»å‹è½¬æ¢ï¼šblock = &amp;__main_3_block_impl_0(__main_3_block_func_0, &amp;__main_3_block_desc_0_DATA));
    void(*block)(void) = ((void (*)())&amp;__main_3_block_impl_0((void *)__main_3_block_func_0, &amp;__main_3_block_desc_0_DATA));

    // æ‰§è¡Œ Blockï¼ˆå‚æ•° block å³é™æ€å‡½æ•°ä¸­çš„å‚æ•° __cselfï¼‰
    // å¿½ç•¥ç±»å‹è½¬æ¢ï¼šblock-&gt;FuncPtr(block);
    // åœ¨ __main_block_impl_0 ç»“æ„ä½“ä¸­ï¼Œimpl æ˜¯ç¬¬ä¸€ä¸ªå˜é‡ï¼Œå› æ­¤å…¶ä¸ç»“æ„ä½“æœ¬èº«çš„é¦–åœ°å€ä¸€è‡´ï¼Œå› æ­¤å¯ä»¥å¼ºè½¬
    ((void (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);

    return 0;
}
</code></pre>
<p><img src="programming-languages/Objective-C/media/16295350902641.jpg" alt="" /></p>
<p>Block å¯¹äºæ•è·å˜é‡çš„ä¸åŒä¹Ÿä¼šæœ‰ä¸åŒçš„å¤„ç†</p>
<ol>
<li>å±€éƒ¨å˜é‡ï¼Œè¿›è¡Œå€¼æ‹·è´ä¼ é€’ï¼Œä¿®æ”¹åŸæœ‰çš„å€¼ä¸å½±å“ Block æ‰€æ•è·çš„å€¼ï¼›</li>
<li>æ˜¾å¼æˆ–è€…éšå¼æ•è· <code>self</code> ï¼ŒBlock ä¼šæŒæœ‰ <code>self</code> çš„å¼•ç”¨ï¼Œæœ‰å¯èƒ½è§¦å‘æˆ‘ä»¬å¸¸è¯´çš„å¾ªç¯å¼•ç”¨ï¼›</li>
<li>é™æ€å±€éƒ¨å˜é‡ï¼Œ è™½ç„¶ä½œç”¨åŸŸåœ¨ä»£ç å—å†…ï¼Œä½†æ˜¯å…¶ç”Ÿå‘½å‘¨æœŸæ˜¯å…¨å±€çš„ï¼Œæ‰€ä»¥ Block ç›´æ¥æŒæœ‰å¯¹å˜é‡çš„å¼•ç”¨ï¼›</li>
<li>å…¨å±€å˜é‡ï¼ŒBlock ä¸ä¼šæ•è·ï¼Œä½¿ç”¨æ—¶ç›´æ¥è¿›è¡Œè¯»å–ã€‚</li>
</ol>
<p>Block çš„ç±»å‹ï¼š</p>
<p><code>__NSGlobalBlock__</code> ï¼Œä¸æ•è·è‡ªåŠ¨å˜é‡ï¼Œå³è¿è¡Œæ—¶ä¸ä¾èµ–ä¸Šä¸‹æ–‡ï¼Œæ”¾åœ¨å†…å­˜çš„æ•°æ®æ®µ (Data Section) ï¼Œå’Œå…¨å±€å˜é‡åŒä¸€ä¸ª Section ã€‚å¯¹ <code>__NSGlobalBlock__</code> æ‰§è¡Œæ‹·è´åå¾—åˆ°çš„ä»æ˜¯ <code>__NSGlobalBlock__</code> ã€‚</p>
<p><code>__NSStackBlock__</code> ï¼Œå½“ Block æ•è·äº†å¤–ç•Œè‡ªåŠ¨å˜é‡æ—¶ï¼Œåˆ™ä¼šè¢«åˆ†é…åœ¨æ ˆåŒºï¼Œå˜æˆ <code>__NSStackBlock__</code> ï¼Œå¼€å‘è€…æ— éœ€å…³å¿ƒå…¶ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p><code>__NSMallocBlock__</code> ï¼ŒBlock åˆ†é…åœ¨å †åŒºï¼Œéœ€è¦å¼€å‘è€…æ‰‹åŠ¨ç®¡ç†å…¶ç”Ÿå‘½å‘¨æœŸï¼ŒARC ä¸‹ç¼–è¯‘å™¨ä¼šæ ¹æ®æƒ…å†µå°† <code>__NSStackBlock__</code> ç±»å‹çš„ Block è‡ªåŠ¨ copy åˆ°å †ä¸Šï¼Œå°† Block çš„ <code>isa</code> è®¾ç½®ä¸º <code>_NSConcreteMallocBlock</code> ï¼Œä»¥ä¸‹æ“ä½œä¼šå°† Block copy åˆ°å †ä¸Šï¼š</p>
<ol>
<li>å¼ºæŒ‡é’ˆæˆ–è€…å±æ€§æŒ‡å‘çš„ Block ï¼›</li>
<li>Block ä½œä¸ºå‡½æ•°å€¼ä¼šè‡ªåŠ¨æ‹·è´ï¼›</li>
<li>Block ä½œä¸º Cocoa API ä¸­æ–¹æ³•åå«æœ‰ <code>usingBlock</code>  çš„å‚æ•°æ—¶ä¼šè‡ªåŠ¨æ‹·è´ï¼›</li>
<li>Block ä½œä¸º GCD API å‚æ•°æ—¶ä¼šè¢«è‡ªåŠ¨æ‹·è´ï¼›</li>
</ol>
<p><code>__block</code> å£°æ˜çš„å˜é‡ï¼š</p>
<p>Block å†…å¯ä»¥ç›´æ¥ä¿®æ”¹</p>
<p><code>__block</code> å£°æ˜ä¼šå°†å˜é‡å°è£…ä¸ºå¯¹åº”çš„ç»“æ„ä½“ï¼Œè€Œä¸åŒçš„å˜é‡å°±ä¼šç”Ÿæˆä¸åŒçš„ç»“æ„ä½“ã€‚ <code>__block</code> å˜é‡ä»å£°æ˜åï¼Œæ— è®ºåœ¨ Block å†…å¤–å»è®¿é—®å‡æ˜¯é€šè¿‡ç»“æ„ä½“çš„ <code>__forwarding</code> æŒ‡é’ˆå³ <code>blockVar.__forwarding-&gt;blockVar</code> ã€‚å½“ <code>__block</code> å˜é‡åœ¨æ ˆä¸Šæ—¶ï¼Œ <code>blockVar.__forwarding-&gt;blockVar</code> å°±ç­‰åŒäºç›´æ¥é€šè¿‡ <code>blockVar-&gt;blockVar</code> æ¥è®¿é—®çš„ï¼Œå› ä¸ºæ­¤æ—¶ <code>__forwarding</code> å°±æŒ‡å‘æ ˆä¸Šçš„ç»“æ„ä½“æœ¬èº«ï¼›è€Œå½“ Block æ‹·è´åˆ°å †ä¸Šæ—¶ï¼Œ <code>__block</code> å˜é‡ä¹Ÿä¼šè¢«æ‹·è´åˆ°å †ä¸Šï¼Œæ­¤æ—¶æ ˆä¸Šçš„ <code>__forwarding</code> å°†æ›¿æ¢ä¸ºæŒ‡å‘å †ä¸Šçš„ç»“æ„ä½“ï¼Œè€Œå †ä¸Šçš„ç»“æ„ä½“é‡Œçš„ <code>__forwarding</code> å°†æŒ‡å‘å †ä¸Šçš„ç»“æ„ä½“æœ¬èº«ï¼Œä»è€Œä¿è¯åç»­çš„æ•°æ®å˜åŠ¨å‡æ˜¯åœ¨å †ä¸Šã€‚</p>
<p>ä¸Šé¢è¯´åˆ° Block ä¼šç”Ÿæˆä¸åŒçš„ç»“æ„ä½“ï¼Œä¹Ÿå°±è¯´ä½¿ç”¨ Block å®ç°çš„åŠŸèƒ½ä»£ç é‡ä¼šè¾ƒå¤šã€‚</p>
<p><img src="programming-languages/Objective-C/media/16295351225941.jpg" alt="" /></p>
<p>å¾ªç¯å¼•ç”¨ï¼š</p>
<pre><code class="language-objectivec">typedef void(^BlockType_5)(void);

@interface Foo_9 : NSObject
@property (nonatomic, assign) NSUInteger bar;
@property (nonatomic, copy) BlockType_5 block;
@end

@implementation Foo_9
- (void)dealloc
{
#if !__has_feature(objc_arc)
    [super dealloc];
#endifNSLog(@&quot;dealloc&quot;);
}

- (void)foo_1 {
    // Block æ•è·äº† selfï¼Œå…¶å¼ºå¼•ç”¨äº† Blockï¼Œå¯¼è‡´åŒæ–¹éƒ½æ— æ³•é‡Šæ”¾
    self.block = ^{
        // WARNING: Capturing 'self' strongly in this block is likely to lead to a retain cycle
        NSLog(@&quot;%lu&quot;, (unsigned long)self.bar);
        // WARNING: Block implicitly retains 'self'; explicitly mention 'self' to indicate this is intended behavior
        NSLog(@&quot;%lu&quot;, (unsigned long)_bar); // self-&gt;_bar
    };
}
@end

int main_22(int argc, const char * argv[]) {
#if __has_feature(objc_arc)
    Foo_9 *f = [[Foo_9 alloc] init];
    f.bar = 20;

    f.block = ^{
        // Block æ•è·äº† fï¼Œå…¶å¼ºå¼•ç”¨äº† Blockï¼Œå¯¼è‡´åŒæ–¹éƒ½æ— æ³•é‡Šæ”¾
        // WARNING: Capturing 'f' strongly in this block is likely to lead to a retain cycle
        NSLog(@&quot;%lu&quot;, (unsigned long)f.bar);
    };

    f.block();
    [f foo_1];

    // Never call dealloc
#endifreturn 0;
}

// OUTPUT:
// 20
</code></pre>
<p><img src="programming-languages/Objective-C/media/16295351549792.jpg" alt="" /></p>
<h2 id="ç”¨-block-å®ç°-delegate-æ–¹æ³•"><a class="header" href="#ç”¨-block-å®ç°-delegate-æ–¹æ³•">ç”¨ Block å®ç° delegate æ–¹æ³•</a></h2>
<p><a href="https://triplecc.github.io/2017/07/28/2017-07-28-blockhe-nsmethodsignature/">ç”¨ Block å®ç°å§”æ‰˜æ–¹æ³•</a></p>
<p>ä½¿ç”¨ <code>NSInvocation</code> ï¼Œæ¶ˆæ¯è½¬åŒ–æœºåˆ¶å’Œ Block ç»“æ„ä½“è·å– <code>NSMethodSignature</code> ã€‚</p>
<p><code>NSInvocation</code> éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š</p>
<p>æ–¹æ³•çš„è‡ªå®šä¹‰å‚æ•°ä» index 2 å¼€å§‹ï¼Œå‰ä¸¤ä¸ªå‚æ•°æ˜¯æ¥æ”¶æ¶ˆæ¯çš„å¯¹è±¡å’Œæ–¹æ³•çš„ SEL ï¼›</p>
<p><code>-getArgument:atIndex:</code> å’Œ <code>-getReturnvalue:</code> æ–¹æ³•ä¸­è·å–çš„å¯¹è±¡ä¸ä¼šè¿›è¡Œ <code>retain</code> ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ä½¿ç”¨å…·ä½“çš„å¯¹è±¡æŒ‡é’ˆï¼Œåªèƒ½ä½¿ç”¨ <code>vod *</code> ï¼š</p>
<pre><code class="language-objectivec">// é”™è¯¯ä»£ç 
NSString *bar = nil;
[invocation getArgument:&amp;bar atIndex:2];

NSString *result = nil;
[invocation getReturnValue:&amp;result];

// æ­£ç¡®ä»£ç 
void *bar = nil;
//__unsafe_unretained NSString *bar = nil;
//__weak NSString *bar = nil;
[invocation getArgument:&amp;bar atIndex:2];

void *result = nil;
//__unsafe_unretained NSString *result = nil;
//__weak NSString *result = nil;
[invocation getReturnValue:&amp;result];
</code></pre>
<p>å¦‚æœæ˜¯åœ¨ä¸¤ä¸ª <code>NSInvocation</code> å¯¹è±¡é—´ä¼ é€’å‚æ•°/è¿”å›å€¼ï¼Œå¯ä»¥ç›´æ¥ä¼ å…¥æŒ‡é’ˆè·å–å’Œè®¾ç½®ç›®æ ‡åœ°å€ï¼š</p>
<pre><code class="language-objectivec">....
NSInvocation *invocation = [NSInvocation invocationWithMethodSignature:signature];
NSInvocation *shadowInvocation = [NSInvocation invocationWithMethodSignature:signature];
....
void *resultBuffer = malloc(invocation.methodSignature.methodReturnLength);
memset(resultBuffer, 0, invocation.methodSignature.methodReturnLength);

[invocation getReturnValue:resultBuffer];
[shadowInvocation setReturnValue:resultBuffer];
....
free(resultBuffer);
</code></pre>
<p>ä»åè®®ä¸­è·å–æ–¹æ³•ç­¾åï¼Œåˆ©ç”¨ <code>protocol_getMethodDescription</code> å‡½æ•°ï¼Œå¯ä»¥è·å–åˆ°æè¿°ç±»å‹çš„ C å­—ç¬¦ä¸²ï¼Œå†é€šè¿‡è¿™ä¸ªå­—ç¬¦ä¸²æ„é€ æ–¹æ³•ç­¾åã€‚é’ˆå¯¹åè®®ä¸­çš„æ¥å£æœ‰ <code>required</code> å’Œ <code>optional</code> ä¸¤ç§ï¼Œå¹¶ä¸”ä¸å…è®¸é‡å¤è¿™ä¸€ç‰¹ç‚¹ï¼Œå¯ä»¥åˆ›å»ºæ„é€ æ–¹æ³•ç­¾åçš„å‡½æ•°ï¼š</p>
<pre><code class="language-objectivec">static NSMethodSignature *tbv_getProtocolMethodSignature(Protocol *protocol, SEL selector, BOOL isInstanceMethod) {
    struct objc_method_description methodDescription = protocol_getMethodDescription(protocol, selector, YES, isInstanceMethod);
    if (!methodDescription.name) {
        methodDescription = protocol_getMethodDescription(protocol, selector, NO, isInstanceMethod);
    }
    return [NSMethodSignature signatureWithObjCTypes:methodDescription.types];
}
</code></pre>
<p>ç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦ä¸º <code>required</code> ï¼Œå¦‚æœä» <code>required</code> ä¸­è·å–ä¸åˆ°å¯¹åº”çš„ <code>objc_method_description</code> ï¼Œå†ä» <code>optional</code> ä¸­è·å–ï¼š</p>
<p><a href="https://developer.apple.com/documentation/objectivec/1418830-protocol_getmethoddescription">Apple Developer Documentation</a></p>
<p>ä» Block ä¸­è·å–æ–¹æ³•ç­¾åï¼Œè™½ç„¶è‹¹æœæ²¡æœ‰æä¾›å…¬å¼€çš„ API ç»™å¼€å‘è€…è·å–ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ä¸€ä¸ªä¸ Block ç»“æ„ç›¸åŒçš„ <code>struct</code> ï¼Œé€šè¿‡è¿™ä¸ª <code>struct</code> æ¥è·å–æ–¹æ³•ç­¾åï¼š</p>
<pre><code class="language-objectivec">// Block internals.
typedef NS_OPTIONS(int, TBVBlockFlags) {
    TBVBlockFlagsHasCopyDisposeHelpers = (1 &lt;&lt; 25),
    TBVBlockFlagsHasSignature          = (1 &lt;&lt; 30)
};
typedef struct tbv_block {
    __unused Class isa;
    TBVBlockFlags flags;
    __unused int reserved;
    void (__unused *invoke)(struct tbv_block *block, ...);
    struct {
        unsigned long int reserved;
        unsigned long int size;
        // requires TBVBlockFlagsHasCopyDisposeHelpers
        void (*copy)(void *dst, const void *src);
        void (*dispose)(const void *);
        // requires TBVBlockFlagsHasSignature
        const char *signature;
        const char *layout;
    } *descriptor;
    // imported variables
} *TBVBlockRef;

// ä½¿ç”¨è‡ªå®šä¹‰çš„ TBVBlockRef è·å– descriptor
static NSMethodSignature *tbv_signatureForBlock(id block) {
    TBVBlockRef layout = (__bridge TBVBlockRef)(block);
    
    // æ²¡æœ‰ç­¾åï¼Œç›´æ¥è¿”å›ç©º
    if (!(layout-&gt;flags &amp; TBVBlockFlagsHasSignature)) {
        return nil;
    }
    
    // è·å– descriptor æŒ‡é’ˆ
    void *desc = layout-&gt;descriptor;
    
    // è·³è¿‡ reserved å’Œ size æˆå‘˜
    desc += 2 * sizeof(unsigned long int);
    
    // å¦‚æœæœ‰ Helpers å‡½æ•°ï¼Œ è·³è¿‡ copy å’Œ dispose æˆå‘˜
    if (layout-&gt;flags &amp; TBVBlockFlagsHasCopyDisposeHelpers) {
        desc += 2 * sizeof(void *);
    }
    
    // desc ä¸º signature æŒ‡é’ˆçš„åœ°å€ï¼Œè½¬æ¢ä¸‹ç»™ objcTypes
    char *objcTypes = (*(char **)desc);
    
    return [NSMethodSignature signatureWithObjCTypes:objcTypes];
}
</code></pre>
<p>ä¸ºäº†ç¡®ä¿ Block å’Œæ–¹æ³•ä¸¤è€…çš„å‚æ•°æ˜¯ç›¸åŒçš„ï¼Œéœ€è¦å¯¹ä¸¤è€…çš„ç­¾åè¿›è¡ŒåŒ¹é…ï¼Œå³æ£€éªŒè¿”å›å€¼ç±»å‹å’Œå‚æ•°ç±»å‹æ˜¯å¦ç›¸åŒï¼š</p>
<pre><code class="language-objectivec">static BOOL tbv_isCompatibleBlockSignature(NSMethodSignature *blockSignature, NSMethodSignature *methodSignature) {
    NSCParameterAssert(blockSignature);
    NSCParameterAssert(methodSignature);
    
    if ([blockSignature isEqual:methodSignature]) {
        return YES;
    }
    
    // block å‚æ•°ä¸ªæ•°éœ€è¦å°äº method çš„å‚æ•°ä¸ªæ•° (é’ˆå¯¹ block è°ƒç”¨æ›¿æ¢ method è°ƒç”¨)
    // ä¸¤è€…è¿”å›ç±»å‹éœ€è¦ä¸€è‡´
    if (blockSignature.numberOfArguments &gt;= methodSignature.numberOfArguments ||
        blockSignature.methodReturnType[0] != methodSignature.methodReturnType[0]) {
        return NO;
    }
    
    // å‚æ•°ç±»å‹éœ€è¦ä¸€è‡´
    BOOL compatibleSignature = YES;
    
    // è‡ªå®šä¹‰å‚æ•°ä»ç¬¬äºŒä¸ªå¼€å§‹
    for (int idx = 2; idx &lt; blockSignature.numberOfArguments; idx++) {

        // block ç›¸æ¯” method ï¼Œé»˜è®¤å‚æ•°å°‘äº† SEL
        // method: id(@) SEL(:) ....
        // block: block(@?) ....
        const char *methodArgument = [methodSignature getArgumentTypeAtIndex:idx];
        const char *blockArgument = [blockSignature getArgumentTypeAtIndex:idx - 1];
        if (!methodArgument || !blockArgument || methodArgument[0] != blockArgument[0]) {
            compatibleSignature = NO;
            break;
        }
    }
    
    return compatibleSignature;
}
</code></pre>
<p>è°ƒç”¨ Block çš„ <code>NSInvocation</code> ï¼Œç”±äºç›´æ¥è°ƒç”¨çš„æ˜¯ <code>delegate</code> æ–¹æ³•ï¼Œåœ¨è½¬å‘æ—¶æ¥æ”¶åˆ°çš„æ˜¯æ–¹æ³•å¯¹åº”çš„ <code>NSInvocation</code> ï¼Œæ‰€ä»¥éœ€è¦å°†å…¶çš„å‚æ•°å’Œè¿”å›å€¼ä¼ é€’ç»™ Block çš„ <code>NSInvocation</code> ï¼š</p>
<pre><code class="language-objectivec">- (void)invokeWithMethodInvocation:(NSInvocation *)methodInvocation {
    NSParameterAssert(methodInvocation);
    NSAssert([self.methodSignature isEqual:methodInvocation.methodSignature], @&quot;Method invocation's signature is not compatible with block signature&quot;);
    
    NSMethodSignature *methodSignature = methodInvocation.methodSignature;
    NSInvocation *blockInvocation = [NSInvocation invocationWithMethodSignature:self.blockSignature];
    
    void *argumentBuffer = NULL;
    for (int idx = 2; idx &lt; methodSignature.numberOfArguments; idx++) {
        
        // è·å–å‚æ•°ç±»å‹
        const char *type = [methodSignature getArgumentTypeAtIndex:idx];
        NSUInteger size = 0;
        
        // è·å–å‚æ•°å¤§å°
        NSGetSizeAndAlignment(type, &amp;size, NULL);
        
        // å‚æ•°ç¼“å­˜
        if (!(argumentBuffer = reallocf(argumentBuffer, size))) {
            return;
        }
        
        // æŠŠ method çš„å‚æ•°ä¼ é€’ç»™ block
        [methodInvocation getArgument:argumentBuffer atIndex:idx];
        [blockInvocation setArgument:argumentBuffer atIndex:idx - 1];
    }
    
    // è°ƒç”¨ block
    [blockInvocation invokeWithTarget:self.block];
    
    // è¿”å›å€¼ç¼“å­˜
    if (methodSignature.methodReturnLength &amp;&amp;
        (argumentBuffer = reallocf(argumentBuffer, methodSignature.methodReturnLength))) {
        
        // æŠŠ block çš„è¿”å›å€¼ä¼ é€’ç»™ method
        [blockInvocation getReturnValue:argumentBuffer];
        [methodInvocation setReturnValue:argumentBuffer];
    }
    
    // é‡Šæ”¾ç¼“å­˜
    free(argumentBuffer);
}

// reallocf å‡½æ•°æ˜¯ realloc å‡½æ•°çš„å¢å¼ºç‰ˆï¼Œå®ƒå¯ä»¥åœ¨åè€…æ— æ³•ç”³è¯·åˆ°å †ç©ºé—´æ—¶ï¼Œé‡Šæ”¾æ—§çš„å †ç©ºé—´ï¼š
void *reallocf(void *p, size_t s) {
    void *tmp = realloc(p, s);
    if(tmp) return tmp;
    free(p);
    return NULL;
}
</code></pre>
<p>æœ€åæ˜¯é€šè¿‡æ¶ˆæ¯è½¬å‘çš„ <code>forwardInvocaion:</code> æ–¹æ³•è¿›è¡Œè½¬å‘ï¼š</p>
<pre><code class="language-objectivec">- (void)forwardInvocation:(NSInvocation *)invocation {
    TBVBlockInvocation *blockInvocation = self.selectorInvocationMap[NSStringFromSelector(invocation.selector)];
    [blockInvocation invokeWithMethodInvocation:invocation];
}

- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel {
    return self.selectorInvocationMap[NSStringFromSelector(sel)].methodSignature;
}

- (BOOL)respondsToSelector:(SEL)aSelector {
    return !!self.selectorInvocationMap[NSStringFromSelector(aSelector)];
}
</code></pre>
<h2 id="å¦‚ä½•è·å–-block-æ•è·çš„å¯¹è±¡"><a class="header" href="#å¦‚ä½•è·å–-block-æ•è·çš„å¯¹è±¡">å¦‚ä½•è·å– Block æ•è·çš„å¯¹è±¡</a></h2>
<p><a href="https://triplecc.github.io/2019/08/15/%E8%81%8A%E8%81%8A%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E7%9A%84%E6%A3%80%E6%B5%8B/">èŠèŠå¾ªç¯å¼•ç”¨çš„æ£€æµ‹</a></p>
<p>ç”±äº Objective-C ä½¿ç”¨å¼•ç”¨è®¡æ•°ä½œä¸ºå†…å­˜ç®¡ç†æ–¹æ³•ï¼Œä¸” Block ä¼šå¼ºå¼•ç”¨æ‰€æ•è·çš„å¯¹è±¡ï¼Œæ‰€ä»¥ Block ç»å¸¸ä¼šé€ æˆå¼•ç”¨å¾ªç¯ã€‚æœ¬æ–‡è®²è¿°äº†å¦‚ä½•é€šè¿‡ Block çš„å¸ƒå±€ï¼Œæ•è·å˜é‡æ’åºæ¥è·å– Block å¼ºå¼•ç”¨çš„å¯¹è±¡ã€‚</p>
<p>Block æ•è·çš„å¯¹è±¡ä¼šç»Ÿä¸€æ”¾åœ¨ layout çš„ <code>descriptor</code> åé¢ï¼Œå³ <code>sr_block_layout</code> ç»“æ„ä½“çš„ <code>imported variables</code> éƒ¨åˆ†ï¼Œè¿™ç§æ“ä½œå¯ä»¥çœ‹ä½œåœ¨ <code>sr_block_layout</code> å°¾éƒ¨å®šä¹‰äº†ä¸€ä¸ª 0 é•¿æ•°ç»„ï¼Œå¯ä»¥æ ¹æ®å®é™…æ•è·å˜é‡çš„å¤§å°ï¼Œç»™æ•è·åŒºåŸŸç”³è¯·å¯¹åº”çš„å†…å­˜ç©ºé—´ï¼Œåªä¸è¿‡è¿™ä¸€æ“ä½œç”±ç¼–è¯‘å™¨å®Œæˆ :</p>
<pre><code class="language-objectivec">struct sr_block_layout {
    void *isa;
    int flags;
    int reserved;
    void (*invoke)(void *, ...);
    struct sr_block_descriptor *descriptor;
    char captured[0];
};

// æ ‡å¿—ä½ä¸ä¸€æ ·ï¼Œè¿™ä¸ªç»“æ„çš„å®é™…å¸ƒå±€ä¹Ÿä¼šæœ‰å·®åˆ«ï¼Œè¿™é‡Œç®€å•åœ°æ”¾åœ¨ä¸€èµ·å¥½é˜…è¯»
struct sr_block_descriptor {
    unsigned long reserved; // Block_descriptor_1
    unsigned long size; // Block_descriptor_1
    void (*)(void *dst, void *src);  // Block_descriptor_2 BLOCK_HAS_COPY_DISPOSE
    void (*dispose)(void *); // Block_descriptor_2
    const char *signature; // Block_descriptor_3 BLOCK_HAS_SIGNATURE
    const char *layout; // Block_descriptor_3 contents depend on BLOCK_HAS_EXTENDED_LAYOUT
};
</code></pre>
<p>Block çš„æ•è·åŒºåŸŸå¸ƒå±€æœ‰ç‰¹å®šçš„æ’åºè§„åˆ™ï¼š</p>
<p><a href="https://github.com/llvm-mirror/clang/blob/e870496ea61feb01aa0eb4dc599be0ddf2d03878/lib/CodeGen/CGBlocks.cpp#L366-L384">llvm-mirror/clang</a></p>
<p>åœ¨å¯¹é½å­—èŠ‚æ•° ( <code>alignment</code> ) ä¸ç›¸ç­‰æ—¶ï¼Œæ•è·çš„å®ä½“æŒ‰ç…§ <code>alignment</code> é™åºæ’åº ( C ç»“æ„ä½“æ¯”è¾ƒç‰¹æ®Šï¼Œå³ä½¿æ•´ä½“å ç”¨ç©ºé—´æ¯”æŒ‡é’ˆå˜é‡å¤§ï¼Œä¹Ÿæ’åœ¨å¯¹è±¡æŒ‡é’ˆåé¢)ï¼Œå¦åˆ™æŒ‰ç…§ä»¥ä¸‹ç±»å‹æ’åºï¼š</p>
<ol>
<li><code>__strong</code>Â ä¿®é¥°å¯¹è±¡æŒ‡é’ˆå˜é‡</li>
<li><code>__block</code>Â ä¿®é¥°å¯¹è±¡æŒ‡é’ˆå˜é‡</li>
<li><code>__weak</code>Â ä¿®é¥°å¯¹è±¡æŒ‡é’ˆå˜é‡</li>
<li>å…¶ä»–å˜é‡</li>
</ol>
<p>ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre><code class="language-objectivec">NSObject *o1 = [NSObject new];
__weak NSObject *o2 = o1;
__block NSObject *o3 = o1;
unsigned long long j = 4;
int i = 3;
char c = 'a';
void (^blk)(void) = ^{
    i;
    c;
    o1;
    o2;
    o3;
    j;
};
</code></pre>
<p>è¾“å‡ºï¼š</p>
<pre><code class="language-objectivec">(lldb) x/69bx layout
0x10200d940: 0x70 0x21 0x7b 0xa6 0xff 0x7f 0x00 0x00
0x10200d948: 0x02 0x00 0x00 0xc3 0x00 0x00 0x00 0x00
0x10200d950: 0xf0 0x1b 0x00 0x00 0x01 0x00 0x00 0x00
0x10200d958: 0xf8 0x20 0x00 0x00 0x01 0x00 0x00 0x00
0x10200d960: 0xa0 0xf6 0x00 0x02 0x01 0x00 0x00 0x00  // o1
0x10200d968: 0x90 0xd9 0x00 0x02 0x01 0x00 0x00 0x00  // o3
0x10200d970: 0xa0 0xf6 0x00 0x02 0x01 0x00 0x00 0x00  // o2
0x10200d978: 0x04 0x00 0x00 0x00 0x00 0x00 0x00 0x00  // j
0x10200d980: 0x03 0x00 0x00 0x00 0x61                 // i c
(lldb) p o1
(NSObject *) $1 = 0x000000010200f6a0
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå°ç«¯æ¨¡å¼ä¸‹ï¼Œæ•è·çš„ o1 å’Œ o2 æŒ‡é’ˆå˜é‡å€¼ä¸º <code>0x10200f6a0</code> ï¼Œå¯¹åº”å†…å­˜åœ°å€ä¸º <code>0x10200d960</code> å’Œ <code>0x10200d970</code> ï¼Œè€Œ o3 å› ä¸ºè¢« <code>__block</code> ä¿®é¥°ï¼Œç¼–è¯‘å™¨ä¸º o3 æ•è·å˜é‡åŒ…è£…äº†ä¸€å±‚ <code>byref</code> ç»“æ„ï¼Œæ‰€ä»¥å…¶å€¼ä¸º <code>byref</code> ç»“æ„çš„åœ°å€ 0x102000d990 ï¼Œè€Œä¸æ˜¯ 0x10200f6a0 ï¼Œæ•è·çš„ j å˜é‡åœ°å€ä¸º 0x10200d978ï¼Œi å˜é‡åœ°å€ä¸º 0x10200d980ï¼Œc å­—ç¬¦å˜é‡ç´§éšå…¶åã€‚</p>
<p>é€šè¿‡åˆ†æ <code>descriptor</code> çš„ <code>layout</code> ä¿¡æ¯åˆ™å¯ä»¥è·å–æ•è·åˆ°çš„å¯¹è±¡ä¸ªæ•°ã€‚</p>
<p><a href="https://github.com/tripleCC/Laboratory/blob/d5d98d343a918d3883a2d5274da212cd44f50414/AppleSources/libclosure-73/Block_private.h#L283-L314">tripleCC/Laboratory</a></p>
<p><a href="https://github.com/llvm-mirror/clang/blob/e5d2fdc902b0fb4e0a8f5a7d549728e1f2a648ad/lib/CodeGen/CGObjCMac.cpp#L2614-L2865">llvm-mirror/clang</a></p>
<pre><code class="language-objectivec">// block
// Extended layout encoding.

// Values for Block_descriptor_3-&gt;layout with BLOCK_HAS_EXTENDED_LAYOUT
// and for Block_byref_3-&gt;layout with BLOCK_BYREF_LAYOUT_EXTENDED

// If the layout field is less than 0x1000, then it is a compact encoding 
// of the form 0xXYZ: X strong pointers, then Y byref pointers, 
// then Z weak pointers.

// If the layout field is 0x1000 or greater, it points to a 
// string of layout bytes. Each byte is of the form 0xPN.
// Operator P is from the list below. Value N is a parameter for the operator.

enum {
    ...
    BLOCK_LAYOUT_NON_OBJECT_BYTES = 1,    // N bytes non-objects
    BLOCK_LAYOUT_NON_OBJECT_WORDS = 2,    // N words non-objects
    BLOCK_LAYOUT_STRONG           = 3,    // N words strong pointers
    BLOCK_LAYOUT_BYREF            = 4,    // N words byref pointers
    BLOCK_LAYOUT_WEAK             = 5,    // N words weak pointers
    ...
};

// clang 
/// InlineLayoutInstruction - This routine produce an inline instruction for the
/// block variable layout if it can. If not, it returns 0. Rules are as follow:
/// If ((uintptr_t) layout) &lt; (1 &lt;&lt; 12), the layout is inline. In the 64bit world,
/// an inline layout of value 0x0000000000000xyz is interpreted as follows:
/// x captured object pointers of BLOCK_LAYOUT_STRONG. Followed by
/// y captured object of BLOCK_LAYOUT_BYREF. Followed by
/// z captured object of BLOCK_LAYOUT_WEAK. If any of the above is missing, zero
/// replaces it. For example, 0x00000x00 means x BLOCK_LAYOUT_STRONG and no
/// BLOCK_LAYOUT_BYREF and no BLOCK_LAYOUT_WEAK objects are captured.`
</code></pre>
<p><code>descriptor-&gt;layout</code> ä¼šåŒ…å«æ•è·çš„å¯¹è±¡ä¸ªæ•°ï¼Œä¸”ä¼šæ ¹æ® <code>__strong</code> ï¼Œ <code>__block</code> å’Œ <code>__weak</code> è¿›è¡ŒåŒºåˆ†ã€‚</p>
<pre><code class="language-objectivec">NSObject *o1 = [NSObject new];
__block NSObject *o3 = o1;
__weak NSObject *o2 = o1;
NSObject *o4 = o1;
... // 5 - 18
NSObject *o19 = o1;
void (^blk)(void) = ^{
    o1;
    o2;
    o3;
    o4;
    ... // 5 - 18
    o19;
};
</code></pre>
<pre><code class="language-objectivec">(lldb) p/x (long)layout-&gt;descriptor-&gt;layout
(long) $0 = 0x0000000100002f44
(lldb) x/8bx layout-&gt;descriptor-&gt;layout
0x100002f44: 0x3f 0x30 0x40 0x50 0x00 0x76 0x31 0x36
</code></pre>
<p>ç”±äºç»“æ„ä½“çš„å¸ƒå±€é¡ºåºåœ¨ç”Ÿå‘½æ—¶å°±ç¡®å®šäº†ï¼Œæ— æ³•åƒ Block é‚£æ ·åœ¨ç¼–è¯‘æ—¶å†æ ¹æ®å˜é‡ç±»å‹ï¼Œä¿®é¥°ç¬¦è¿›è¡Œè°ƒæ•´ï¼Œæ‰€ä»¥å¦‚æœç»“æ„ä½“ä¸­æœ‰ç±»å‹ä¸ºå¯¹è±¡æŒ‡é’ˆçš„å­—æ®µï¼Œå°±éœ€è¦é¢å¤–çš„ä¿¡æ¯æ¥è¿›è¡Œè®°å½•ï¼Œè¿™ä¹Ÿä¼šå½±å“ <code>layout</code> ã€‚</p>
<p>ä½¿ç”¨ <code>__block</code> ä¿®é¥°çš„æ•è·å˜é‡é¦–å…ˆä¼šè½¬æ¢æˆ <code>byref</code> ç»“æ„ï¼Œç„¶åå†ç”±è¿™ä¸ªç»“æ„å»æŒæœ‰å®é™…çš„å˜é‡ï¼Œ Block åªè´Ÿè´£ç®¡ç† <code>byref</code> ï¼š</p>
<pre><code class="language-objectivec">struct sr_block_byref {
    void *isa;
    struct sr_block_byref *forwarding;
    volatile int32_t flags; // contains ref count
    uint32_t size;
    // requires BLOCK_BYREF_HAS_COPY_DISPOSE
    void (*byref_keep)(struct sr_block_byref *dst, struct sr_block_byref *src);
    void (*byref_destroy)(struct sr_block_byref *);
    // requires BLOCK_BYREF_LAYOUT_EXTENDED
    const char *layout;
};
</code></pre>
<p>è¿™é‡Œä½¿ç”¨ <code>layout</code> çš„åŸå› æ˜¯éœ€è¦æ ¹æ®ä¸åŒçš„æ•è·å˜é‡è®°å½•ä¸åŒçš„ä¿¡æ¯ï¼Œå…·ä½“çš„å®ç°å¯ä»¥æŸ¥çœ‹åŸæ–‡ã€‚</p>
<p>äº†è§£å®Œ Block çš„æ•è·åŒºåŸŸçš„å†…å­˜å¸ƒå±€åï¼Œå°±å¯ä»¥é€šè¿‡å†…å­˜å¸ƒå±€æ¥è·å–å¼ºå¼•ç”¨å¯¹è±¡äº†ï¼š</p>
<ol>
<li>è¢« Block å¼ºå¼•ç”¨</li>
<li>è¢« byref ç»“æ„å¼ºå¼•ç”¨</li>
</ol>
<p>å®Œæ•´çš„ä»£ç åœ¨è¿™é‡Œï¼š</p>
<p><a href="https://github.com/tripleCC/Laboratory/blob/9982b333c6b8d1cd7cb9ed17430906afebf1f8bb/BlockStrongReferenceObject/BlockStrongReferenceObject/SRBlockStrongReferenceCollector.m">tripleCC/Laboratory</a></p>
<h2 id="å¦ä¸€ç§è·å–-block-å¼ºå¼•ç”¨å¯¹è±¡çš„æ–¹å¼"><a class="header" href="#å¦ä¸€ç§è·å–-block-å¼ºå¼•ç”¨å¯¹è±¡çš„æ–¹å¼">å¦ä¸€ç§è·å– Block å¼ºå¼•ç”¨å¯¹è±¡çš„æ–¹å¼</a></h2>
<p><a href="https://github.com/draveness/analyze/blob/master/contents/FBRetainCycleDetector/iOS%20%E4%B8%AD%E7%9A%84%20block%20%E6%98%AF%E5%A6%82%E4%BD%95%E6%8C%81%E6%9C%89%E5%AF%B9%E8%B1%A1%E7%9A%84.md">draveness/analyze</a></p>
<p><a href="https://github.com/facebook/FBRetainCycleDetector/blob/ecd369ed1e03eb22178199091fecdba6c9964189/FBRetainCycleDetector/Layout/Blocks/FBBlockStrongLayout.m#L29-L102">facebook/FBRetainCycleDetector</a></p>
<p>FBRetainCycleDetector ä¹Ÿæä¾›äº†è·å– Block å¼ºå¼•ç”¨å¯¹è±¡çš„åŠŸèƒ½ï¼Œä¸ä¸Šé¢çš„åˆ†æ Block æ•è·åŒºåŸŸçš„å†…å­˜å¸ƒå±€æ–¹å¼ä¸åŒï¼Œä½¿ç”¨äº†ä¸€ç§æ¯”è¾ƒå–å·§çš„æ–¹å¼ã€‚</p>
<p>è·å– <code>dispose_helper</code> ï¼Œ <code>dispose_helper</code> ä½œä¸º Block çš„è¾…åŠ©å‡½æ•°ï¼Œåœ¨ Block ææ„æ—¶ä¼šè°ƒç”¨ï¼Œç„¶åç»™å¼ºå¼•ç”¨å¯¹è±¡å‘é€ <code>release</code> æ¶ˆæ¯ï¼Œå€Ÿç”¨è¿™ä¸ªç‰¹æ€§è¿›è¡Œå¤„ç†ã€‚</p>
<pre><code class="language-objectivec">struct BlockDescriptor {
	unsigned long int reserved;                // NULL
	unsigned long int size;
	// optional helper functions
	void (*copy_helper)(void *dst, void *src); // IFF (1&lt;&lt;25)
	void (*dispose_helper)(void *src);         // IFF (1&lt;&lt;25)
	const char *signature;                     // IFF (1&lt;&lt;30)
};
</code></pre>
<p>å¦å¤–ä¸€ä¸ªè¾…åŠ©ç±»å°±æ˜¯ <code>FBBlockStrongRelationDetector</code> ï¼Œ <code>FBBlockStrongRelationDetector</code> é‡å†™äº† <code>release</code> æ–¹æ³•å’Œæ–°å¢äº†ä¸€ä¸ª <code>trueRelease</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-objectivec">- (oneway void)release
{
  _strong = YES;
}

- (oneway void)trueRelease
{
  [super release];
}
</code></pre>
<p><code>FBBlockStrongRelationDetector</code> åŒæ—¶ä¹Ÿå¯ä»¥è¢«å½“ä½œ Block æ¥å¤„ç†ï¼Œå½“ Block  ä¸­åˆå¼•ç”¨äº† Block æ—¶ï¼Œå®ƒä¼šå°è¯•è°ƒç”¨ <code>byref_dispose</code> ï¼Œæ‰€ä»¥ <code>FBBlockStrongRelationDetector</code> ä¹Ÿå®šä¹‰äº†å’Œ Block ç›¸åŒçš„å˜é‡å¸ƒå±€ï¼š</p>
<pre><code class="language-objectivec">struct _block_byref_block;
@interface FBBlockStrongRelationDetector : NSObject
{
  // __block fakery
  void *forwarding;
  int flags;   //refcount;
  int size;
  void (*byref_keep)(struct _block_byref_block *dst, struct _block_byref_block *src);
  void (*byref_dispose)(struct _block_byref_block *);
  void *captured[16];
}
</code></pre>
<p>åœ¨è·å–å¼ºå¼•ç”¨å¯¹è±¡ç´¢å¼•çš„å®ç°ä¸­ï¼Œä¼šåœ¨è‡ªåŠ¨é‡Šæ”¾è¿Ÿä¸­æ‰§è¡Œ <code>dispose_helper(obj)</code> æ–¹æ³•ï¼Œç»™æ¯ä¸ª å¼ºå¼•ç”¨å¯¹è±¡å¯¹åº”çš„ <code>FBBlockStrongRelationDetector</code> å‘é€ <code>release</code> æ¶ˆæ¯ï¼Œè¿™æ ·å°±å¯ä»¥æ‹¿åˆ°å®ƒä»¬çš„ç´¢å¼•å€¼ï¼Œä»è€Œè·å–å¯¹åº”çš„å¯¹è±¡ã€‚</p>
<pre><code class="language-objectivec">static NSIndexSet *_GetBlockStrongLayout(void *block) {
	...
	void (*dispose_helper)(void *src) = blockLiteral-&gt;descriptor-&gt;dispose_helper;
	const size_t ptrSize = sizeof(void *);	
	const size_t elements = (blockLiteral-&gt;descriptor-&gt;size + ptrSize - 1) / ptrSize;
	
	void *obj[elements];
	void *detectors[elements];
	
	for (size_t i = 0; i &lt; elements; ++i) {
		FBBlockStrongRelationDetector *detector = [FBBlockStrongRelationDetector new];
		obj[i] = detectors[i] = detector;
	}
	
	@autoreleasepool {
		dispose_helper(obj);
	}
	NSMutableIndexSet *layout = [NSMutableIndexSet indexSet];
	
	for (size_t i = 0; i &lt; elements; ++i) {
		FBBlockStrongRelationDetector *detector = (FBBlockStrongRelationDetector *)(detectors[i]);
		if (detector.isStrong) {
			[layout addIndex:i];
		}
		
		[detector trueRelease];
	}
	
	return layout;
}
</code></pre>
<h2 id="llvm-å…³äº-block-çš„æ–‡æ¡£"><a class="header" href="#llvm-å…³äº-block-çš„æ–‡æ¡£">LLVM å…³äº Block çš„æ–‡æ¡£</a></h2>
<p><a href="https://clang.llvm.org/docs/Block-ABI-Apple.html">Clang 12 documentation</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="category"><a class="header" href="#category">Category</a></h1>
<h2 id="å®˜æ–¹æ–‡æ¡£-1"><a class="header" href="#å®˜æ–¹æ–‡æ¡£-1">å®˜æ–¹æ–‡æ¡£</a></h2>
<p><a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/DevPedia-CocoaCore/Category.html">Category</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/24925196">Objective-C Category</a></p>
<p>Category çš„ä½œç”¨ï¼š</p>
<ol>
<li>ä¸ºå·²å­˜åœ¨çš„ç±»æ·»åŠ æ–¹æ³•ï¼›</li>
<li>å°†ç±»çš„å®ç°åˆ†å¼€åœ¨ä¸åŒçš„ä»£ç æ–‡ä»¶é‡Œï¼Œå‡å°‘å•ä¸ªä»£ç æ–‡ä»¶çš„è¡Œæ•°ï¼Œå°†ä¸åŒçš„åŠŸèƒ½ç»„ç»‡åˆ°ä¸åŒçš„ Category ï¼Œå¯ä»¥ç”±å¤šä¸ªå¼€å‘è€…å…±åŒå¼€å‘åŒä¸€ä¸ªç±»ï¼ŒæŒ‰éœ€åŠ è½½å¯¹åº”çš„ Category ï¼›</li>
<li>å£°æ˜ç§æœ‰æ–¹æ³•ï¼Œå€Ÿæ­¤å°†ç§æœ‰æ–¹æ³•å…¬å¼€ï¼Œæ–¹ä¾¿è°ƒç”¨ï¼›</li>
<li>æ¨¡æ‹Ÿå¤šç»§æ‰¿ï¼›</li>
<li>Method Swizzling ï¼›</li>
<li>ç»“åˆ Associated Objects å’Œ Category ç»™å·²æœ‰çš„ç±»æ–°å¢ Property ï¼›</li>
<li>è¦†ç›–ä¸»ç±»çš„å®ç°ï¼ˆä¹Ÿå¯ä»¥è¯´æ˜¯å‰¯ä½œç”¨ï¼‰ã€‚</li>
</ol>
<h2 id="æ·±å…¥ç†è§£-category"><a class="header" href="#æ·±å…¥ç†è§£-category">æ·±å…¥ç†è§£ Category</a></h2>
<p><a href="https://tech.meituan.com/2015/03/03/diveintocategory.html">æ·±å…¥ç†è§£Objective-Cï¼šCategory</a></p>
<p>æ·±å…¥è§£æ Category ï¼š</p>
<ol>
<li>Category å’Œ Extension çš„ä¸åŒï¼›</li>
<li>æºç è§£æï¼ŒCategory ç”Ÿæˆçš„ <code>sturct</code> ï¼›</li>
<li>Category çš„å±æ€§ï¼Œæ–¹æ³•ç­‰æ˜¯å¦‚ä½•åœ¨é€šè¿‡ runtime è¿½åŠ åˆ°ä¸»ç±»ä¸­ï¼›</li>
<li>Category çš„åŠ è½½é¡ºåºï¼›</li>
<li>Category ä¸ Associated Objects ã€‚</li>
</ol>
<p>å¦‚ä½•è°ƒç”¨è¢«è¦†ç›–æ‰çš„ä¸»ç±»æ–¹æ³•ï¼š</p>
<pre><code class="language-objectivec">Class currentClass = [MyClass class];
MyClass *my = [[MyClass alloc] init];

if (currentClass) {
    unsigned int methodCount;
    Method *methodList = class_copyMethodList(currentClass, &amp;methodCount);
    IMP lastImp = NULL;
    SEL lastSel = NULL;
    for (NSInteger i = 0; i &lt; methodCount; i++) {
        Method method = methodList[i];
        NSString *methodName = [NSString stringWithCString:sel_getName(method_getName(method)) 
        								encoding:NSUTF8StringEncoding];
        if ([@&quot;printName&quot; isEqualToString:methodName]) {
            lastImp = method_getImplementation(method);
            lastSel = method_getName(method);
        }
    }
    typedef void (*fn)(id,SEL);
    
    if (lastImp != NULL) {
        fn f = (fn)lastImp;
        f(my,lastSel);
    }
    free(methodList);
}
</code></pre>
<p>è¿™é‡Œæ˜¯é¡ºåºéå†ï¼Œå¯ä»¥ä½¿ç”¨é€†åºéå†ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ª IMP å°±è¿”å›ï¼Œä¼šå¿«é‚£ä¹ˆä¸€ç‚¹ç‚¹ã€‚</p>
<h2 id="ios-ä¸­çš„-category"><a class="header" href="#ios-ä¸­çš„-category">iOS ä¸­çš„ Category</a></h2>
<p><a href="https://kingcos.me/posts/2019/category_in_ios/">iOS ä¸­çš„ Category</a></p>
<p>è¿™ç¯‡æ–‡ç« éå¸¸è¯¦ç»†ï¼Œä» <code>realloc</code> åˆ° <code>memmove</code> å’Œ <code>memcpy</code> éƒ½æœ‰è®²ï¼š</p>
<p><img src="programming-languages/Objective-C/media/16295354687549.jpg" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="message-sending--forwarding"><a class="header" href="#message-sending--forwarding">Message Sending &amp; Forwarding</a></h1>
<h2 id="æ¶ˆæ¯å‘é€ä¸è½¬å‘"><a class="header" href="#æ¶ˆæ¯å‘é€ä¸è½¬å‘">æ¶ˆæ¯å‘é€ä¸è½¬å‘</a></h2>
<p><a href="https://halfrost.com/objc_runtime_objc_msgsend/">ç¥ç»ç—…é™¢ Objective-C Runtime ä½é™¢ç¬¬äºŒå¤©--æ¶ˆæ¯å‘é€ä¸è½¬å‘</a></p>
<p>ä½œè€…ç”»äº†ä¸€å¼ éå¸¸æ¸…æ™°çš„æµç¨‹å›¾ï¼Œå¯ä»¥å…ˆçœ‹å›¾å†çœ‹æ–‡ç« ã€‚</p>
<p><img src="programming-languages/Objective-C/media/16295369175812.jpg" alt="" /></p>
<h2 id="æ¶ˆæ¯å‘é€ä¸è½¬å‘æœºåˆ¶åŸç†"><a class="header" href="#æ¶ˆæ¯å‘é€ä¸è½¬å‘æœºåˆ¶åŸç†">æ¶ˆæ¯å‘é€ä¸è½¬å‘æœºåˆ¶åŸç†</a></h2>
<p><a href="http://yulingtianxia.com/blog/2016/06/15/Objective-C-Message-Sending-and-Forwarding/">Objective-C æ¶ˆæ¯å‘é€ä¸è½¬å‘æœºåˆ¶åŸç†</a></p>
<p>è¿™é‡Œæœ‰è¯´åˆ°ä¸ºä»€ä¹ˆ <code>objc_msgSend</code> è¦ä½¿ç”¨æ±‡ç¼–è¿›è¡Œå¤„ç†ï¼š</p>
<p>å…¶å®åœ¨Â <a href="https://github.com/opensource-apple/objc4/blob/master/runtime/Messengers.subproj/objc-msg-x86_64.s">objc-msg-x86_64.s</a>Â ä¸­åŒ…å«äº†å¤šä¸ªç‰ˆæœ¬çš„Â <code>objc_msgSend</code>Â æ–¹æ³•ï¼Œå®ƒä»¬æ˜¯æ ¹æ®è¿”å›å€¼çš„ç±»å‹å’Œè°ƒç”¨è€…çš„ç±»å‹åˆ†åˆ«å¤„ç†çš„ï¼š</p>
<ul>
<li><code>objc_msgSendSuper</code>:å‘çˆ¶ç±»å‘æ¶ˆæ¯ï¼Œè¿”å›å€¼ç±»å‹ä¸ºÂ <code>id</code></li>
<li><code>objc_msgSend_fpret</code>:è¿”å›å€¼ç±»å‹ä¸º floating-pointï¼Œå…¶ä¸­åŒ…å«Â <code>objc_msgSend_fp2ret</code>Â å…¥å£å¤„ç†è¿”å›å€¼ç±»å‹ä¸ºÂ <code>long double</code>Â çš„æƒ…å†µ</li>
<li><code>objc_msgSend_stret</code>:è¿”å›å€¼ä¸ºç»“æ„ä½“</li>
<li><code>objc_msgSendSuper_stret</code>:å‘çˆ¶ç±»å‘æ¶ˆæ¯ï¼Œè¿”å›å€¼ç±»å‹ä¸ºç»“æ„ä½“</li>
</ul>
<p>å½“éœ€è¦å‘é€æ¶ˆæ¯æ—¶ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸­é—´ä»£ç ï¼Œæ ¹æ®æƒ…å†µåˆ†åˆ«è°ƒç”¨Â <code>objc_msgSend</code>,Â <code>objc_msgSend_stret</code>,Â <code>objc_msgSendSuper</code>, æˆ–Â <code>objc_msgSendSuper_stret</code>Â å…¶ä¸­ä¹‹ä¸€ã€‚</p>
<p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆÂ <code>objc_msgSend</code>Â è¦ç”¨æ±‡ç¼–è¯­è¨€è€Œä¸æ˜¯ OCã€C æˆ– C++ è¯­è¨€æ¥å®ç°ï¼Œå› ä¸ºå•ç‹¬ä¸€ä¸ªæ–¹æ³•å®šä¹‰æ»¡è¶³ä¸äº†å¤šç§ç±»å‹è¿”å›å€¼ï¼Œæœ‰çš„æ–¹æ³•è¿”å›Â <code>id</code>ï¼Œæœ‰çš„è¿”å›Â <code>int</code>ã€‚è€ƒè™‘åˆ°ä¸åŒç±»å‹å‚æ•°è¿”å›å€¼æ’åˆ—ç»„åˆæ˜ å°„ä¸åŒæ–¹æ³•ç­¾åï¼ˆmethod signatureï¼‰çš„é—®é¢˜ï¼Œé‚£ switch è¯­å¥å¾—è€é•¿äº†ã€‚ã€‚ã€‚**è¿™äº›åŸå› å¯ä»¥æ€»ç»“ä¸ºÂ <a href="https://en.wikipedia.org/wiki/Calling_convention">Calling Convention</a>ï¼Œä¹Ÿå°±æ˜¯è¯´å‡½æ•°è°ƒç”¨è€…ä¸è¢«è°ƒç”¨è€…å¿…é¡»çº¦å®šå¥½å‚æ•°ä¸è¿”å›å€¼åœ¨ä¸åŒæ¶æ„å¤„ç†å™¨ä¸Šçš„å­˜å–è§„åˆ™ï¼Œæ¯”å¦‚å‚æ•°æ˜¯ä»¥ä½•ç§é¡ºåºå­˜å‚¨åœ¨æ ˆä¸Šï¼Œæˆ–æ˜¯å­˜å‚¨åœ¨å“ªäº›å¯„å­˜å™¨ä¸Šã€‚**é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å…¶ä»–åŸå› ï¼Œæ¯”å¦‚å…¶å¯å˜å‚æ•°ç”¨æ±‡ç¼–å¤„ç†èµ·æ¥æœ€æ–¹ä¾¿ï¼Œå› ä¸ºæ‰¾åˆ° IMP åœ°å€åå‚æ•°éƒ½åœ¨æ ˆä¸Šã€‚è¦æ˜¯ç”¨ C++ ä¼ é€’å¯å˜å‚æ•°é‚£å°±æ‚²å‰§äº†ï¼Œprologue æœºåˆ¶ä¼šå¼„ä¹±åœ°å€ï¼ˆæ¯”å¦‚ i386 ä¸Šä¸ºäº†å­˜å‚¨Â <code>ebp</code>Â å‘åç§»ä½ 4byte ï¼‰ï¼Œæœ€åè¿˜è¦ç”¨ epilogue æ‰“æ‰«æˆ˜åœºã€‚è€Œä¸”æ±‡ç¼–ç¨‹åºæ‰§è¡Œæ•ˆç‡é«˜ï¼Œåœ¨ Objective-C Runtime ä¸­è°ƒç”¨é¢‘ç‡è¾ƒé«˜çš„å‡½æ•°å¥½å¤šéƒ½ç”¨æ±‡ç¼–å†™çš„ã€‚</p>
<p>è¿˜æœ‰ä¸€å¼ å·¨è¯¦ç»†çš„å›¾ï¼š</p>
<p><img src="programming-languages/Objective-C/media/16295369836049.jpg" alt="" /></p>
<h2 id="æ¶ˆæ¯å‘é€"><a class="header" href="#æ¶ˆæ¯å‘é€">æ¶ˆæ¯å‘é€</a></h2>
<p><a href="https://github.com/draveness/analyze/blob/master/contents/objc/%E4%BB%8E%E6%BA%90%E4%BB%A3%E7%A0%81%E7%9C%8B%20ObjC%20%E4%B8%AD%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%91%E9%80%81.md">draveness/analyze</a></p>
<p>é€šè¿‡æ–­ç‚¹æ–¹å¼æ¥æŸ¥çœ‹æ¶ˆæ¯å‘é€çš„è°ƒç”¨é¡ºåºï¼š</p>
<ol>
<li>ç¼“å­˜å‘½ä¸­ï¼›</li>
<li>æŸ¥æ‰¾å½“å‰ç±»çš„ç¼“å­˜åŠæ–¹æ³•ï¼›</li>
<li>æŸ¥æ‰¾çˆ¶ç±»çš„ç¼“å­˜åŠæ–¹æ³•ï¼›</li>
<li>æ–¹æ³•å†³è®®ï¼›</li>
<li>æ¶ˆæ¯è½¬å‘ã€‚</li>
</ol>
<p><code>objc_msgSend</code> çš„è°ƒç”¨æ ˆï¼š</p>
<pre><code class="language-objectivec">0 lookUpImpOrForward
1 _class_lookupMethodAndLoadCache3
2 objc_msgSend
3 main
4 start
</code></pre>
<h2 id="lets-build-objc_msgsend"><a class="header" href="#lets-build-objc_msgsend">Let's Build <code>objc_msgSend</code></a></h2>
<p><a href="https://www.mikeash.com/pyblog/friday-qa-2012-11-16-lets-build-objc_msgsend.html">mikeash.com: Friday Q&amp;A 2012-11-16: Let's Build objc_msgSend</a></p>
<p>Mike Ash å°è¯•è‡ªå·±å®ç°äº† <code>objc_msgSend</code> ï¼Œå‰é¢éƒ¨åˆ†ä¸ºäº†æ‹¦æˆªç³»ç»Ÿ <code>objc_msgSend</code> ï¼Œä½¿ç”¨çš„æ˜¯æ±‡ç¼–æ¥å®ç°ï¼Œå½“åœ¨ç¼“å­˜æ‰¾ä¸åˆ° IMP æ—¶ï¼Œæ”¹ç”¨å¯ç»´æŠ¤çš„ C æ¥å®ç°ï¼Œç”±äºæ‰¾ä¸åˆ°ç¼“å­˜çš„æ¦‚ç‡è¾ƒå°ï¼Œå’Œæ‰¾ä¸åˆ°ç¼“å­˜åå¯¹é€Ÿåº¦è¦æ±‚æ²¡é‚£ä¹ˆé«˜ï¼Œæ‰€ä»¥æ”¹ç”¨ C æ¥å®ç°ã€‚</p>
<p>ä¼ªä»£ç å®ç°ï¼š</p>
<pre><code class="language-objectivec">IMP class_getMethodImplementation(Class cls, SEL sel)
{
    IMP imp;
    if (!cls  ||  !sel) return nil;
    imp = lookUpImpOrNil(cls, sel, nil, YES/*initialize*/, YES/*cache*/, YES/*resolver*/);
    // Translate forwarding function to C-callable external version
    if (!imp) {
        return _objc_msgForward;
    }
    return imp;
}
</code></pre>
<h2 id="æ–¹æ³•ç¼“å­˜"><a class="header" href="#æ–¹æ³•ç¼“å­˜">æ–¹æ³•ç¼“å­˜</a></h2>
<p><a href="https://tech.meituan.com/2015/08/12/deep-understanding-object-c-of-method-caching.html">æ·±å…¥ç†è§£ Objective-Cï¼šæ–¹æ³•ç¼“å­˜</a></p>
<p>ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜ï¼š</p>
<ol>
<li>å¤§éƒ¨åˆ†æ–¹æ³•ä¸ä¼šåªè°ƒç”¨ä¸€æ¬¡ï¼Œè€Œä¸”å¾€å¾€é‡å¤çš„å‡ ç‡è¾ƒé«˜ï¼›</li>
<li>å½“ä¸€ä¸ªæ–¹æ³•åœ¨æ¯”è¾ƒâ€œä¸Šå±‚â€çš„ç±»ä¸­ï¼Œè€Œä½¿ç”¨æ¯”è¾ƒâ€œä¸‹å±‚â€çš„å¯¹è±¡å»è°ƒç”¨æ—¶ï¼Œå¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œæ•´ä¸ªéå†å°±ä¼šæ¯”è¾ƒè€—æ—¶ã€‚</li>
</ol>
<p>ä½¿ç”¨æ•£åˆ—è¡¨æ¥è¿›è¡Œç¼“å­˜ï¼Œå…·ä½“ä»£ç åˆ†æå¯ä»¥æŸ¥çœ‹ä¸Šé¢çš„æ–‡ç« ï¼Œä½¿ç”¨æ•£åˆ—è¡¨å¯ä»¥åŠ å¿«æ£€ç´¢é€Ÿåº¦ã€‚</p>
<h2 id="æµ…å°-objc_msgsend"><a class="header" href="#æµ…å°-objc_msgsend">æµ…å° <code>objc_msgSend</code></a></h2>
<p><a href="https://kingcos.me/posts/2019/objc_msgsend/">æµ…å° objc_msgSend</a></p>
<p>å¯¹ <code>objc_msgSend</code> æ•´ä½“æµç¨‹è¿›è¡Œç ”ç©¶ï¼ŒåŒ…æ‹¬æ¶ˆæ¯å‘é€ï¼ŒåŠ¨æ€æ–¹æ³•è§£æä»¥åŠæ¶ˆæ¯è½¬å‘ä¸‰éƒ¨åˆ†ã€‚</p>
<h2 id="objective-c-message-forwarding"><a class="header" href="#objective-c-message-forwarding">Objective-C Message Forwarding</a></h2>
<p><a href="https://mikeash.com/pyblog/friday-qa-2009-03-27-objective-c-message-forwarding.html">mikeash.com: Friday Q&amp;A 2009-03-27: Objective-C Message Forwarding</a></p>
<p>å½“ç»™ä¸€ä¸ªå¯¹è±¡å‘é€ä¸€ä¸ªå®ƒæ— æ³•å“åº”çš„æ¶ˆæ¯æ—¶ï¼Œå¹¶ä¸ä¼šè¯´ç›´æ¥æŠ›å‡º <code>unrecognized selector sent to instance</code> é”™è¯¯ï¼Œè€Œæ˜¯ä¼šç»è¿‡ä¸€ç³»åˆ—çš„æ¶ˆæ¯è½¬å‘å¤„ç†ï¼Œæä¾›äº†å¤„ç†æœºåˆ¶ã€‚</p>
<h3 id="lazy-method-resolution"><a class="header" href="#lazy-method-resolution">Lazy method resolution</a></h3>
<p>runtime åœ¨å‘é€æ¶ˆæ¯æ—¶ä¼šæŸ¥æ‰¾å¯¹åº”çš„ <code>IMP</code> ï¼Œè€Œ Lazy method resolution æä¾›äº†ä¸€ä¸ªå»¶è¿Ÿåˆ°å‘é€æ¶ˆæ¯æ—¶æ‰ç”Ÿæˆå¯¹åº”æ–¹æ³•çš„æœºåˆ¶ï¼Œè€Œä¸æ˜¯æå‰å°±è®¾ç½®å¥½æ‰€æœ‰æ–¹æ³•ã€‚ Lazy method solution å¤„ç†æ¶ˆæ¯éå¸¸å¿«ï¼Œå½“æ·»åŠ å®Œæ–¹æ³•åå°±ä¼šèµ°æ­£å¸¸çš„æ¶ˆæ¯å¤„ç†æµç¨‹ï¼Œä½†æ˜¯ç¼ºå°‘çµæ´»æ€§ï¼Œæ— æ³•æ”¹å˜å‚æ•°ï¼Œæ¥æ”¶å¯¹è±¡å’Œè¿”å›å‚æ•°ç­‰ã€‚åœ¨ Lazy method solution ä¸­ä¼šè°ƒç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<pre><code class="language-objectivec">/// ç±»æ–¹æ³•
+ (BOOL)resolveClassMethod:(SEL)sel;
/// å¯¹è±¡æ–¹æ³•
+ (BOOL)resolveInstanceMethod:(SEL)sel;
</code></pre>
<p>å¦‚æœåœ¨æ–¹æ³•ä¸­æ·»åŠ  <code>SEL</code> çš„å®ç°å’Œè¿”å› <code>YES</code> ï¼Œå°±ä¼šé‡èµ°æ¶ˆæ¯å¤„ç†æµç¨‹ï¼Œå¦‚æœè¿”å› <code>NO</code> å°±ä¼šè¿›å…¥æ¶ˆæ¯è½¬å‘çš„ä¸‹ä¸€ä¸ªæµç¨‹ã€‚</p>
<p>CoreData å°±æ˜¯é€šè¿‡ç»“åˆ <code>@dynamic</code> å±æ€§ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆ <code>setter</code> å’Œ <code>getter</code> æ–¹æ³•ã€‚</p>
<h3 id="fast-fowarding"><a class="header" href="#fast-fowarding">Fast Fowarding</a></h3>
<p>åœ¨ Lazy method resolution è¿”å› <code>NO</code> ä¹‹åï¼Œå°±ä¼šèµ°åˆ° Fast Fowarding æµç¨‹ï¼Œè°ƒç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<pre><code class="language-objectivec">- (id)forwardingTargetForSelector:(SEL)aSelector;
</code></pre>
<p>é€šè¿‡è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å¯ä»¥è¿”å›å…¶å®ƒå¯¹è±¡æ¥å“åº”è¿™ä¸ª <code>SEL</code> ï¼Œè¿™é‡Œå±äºæ¶ˆæ¯è½¬å‘çš„åŸºç¡€æµç¨‹ï¼Œæ‰€ä»¥æ€§èƒ½å¼€é”€ä¹Ÿæ¯”è¾ƒå°ã€‚é€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ç±»ä¼¼äºå¤šç»§æ‰¿çš„æœºåˆ¶ï¼Œæ ¹æ®ä¸åŒçš„ <code>SEL</code> è¿”å›ä¸åŒçš„å¯¹è±¡ï¼Œå³ä½¿è‡ªå·±å½“å‰æ²¡æœ‰å®ç°å¯¹åº”çš„ <code>SEL</code> ã€‚</p>
<h3 id="normal-forwarding"><a class="header" href="#normal-forwarding">Normal Forwarding</a></h3>
<p>Normal Forwarding æ˜¯æ¶ˆæ¯è½¬å‘çš„æœ€åä¸€ä¸ªå¤„ç†æµç¨‹ï¼Œä¼šç›¸ç»§è°ƒç”¨ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<pre><code class="language-objectivec">- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel;
- (void)forwardInvocation:(NSInvocation *)inv;
</code></pre>
<p>å…ˆè°ƒç”¨ <code>methodSignatureForSelector:</code> æ–¹æ³•æ¥è¿”å› <code>NSMethodSignature</code> ï¼Œ <code>NSMethodSignature</code> ç”¨äºç”Ÿæˆ <code>NSInvocation</code> ï¼Œè€Œ <code>NSInvocation</code> åŒ…å«äº† <code>Target</code> ï¼Œ <code>SEL</code> ï¼Œæ‰€æœ‰å‚æ•°å’Œè¿”å›å€¼ï¼Œå®ƒä»¥å¯¹è±¡çš„å½¢å¼å¯¹æ¶ˆæ¯è¿›è¡Œäº†ä¸€å±‚å°è£…ã€‚ç„¶åå°±ä¼šè°ƒç”¨ <code>forwardInvocation:</code> å¯¹ <code>NSInvocation</code> è¿›è¡Œå¤„ç†ã€‚ <code>NSInvocation</code> éå¸¸çµæ´»ï¼Œè¿”å›å€¼ï¼Œå¤„ç†å¯¹è±¡ï¼Œå‚æ•°å’Œ <code>SEL</code> éƒ½å¯ä»¥è¿›è¡Œæ”¹å˜ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æƒ³ç»™ <code>NSArray</code> æ·»åŠ ä¸€ä¸ªè¿™æ ·çš„ç‰¹æ€§ï¼šå½“ç»™  <code>NSArray</code> å‘é€æ¶ˆæ¯æ—¶ï¼Œå¦‚æœ <code>NSArray</code> æ— æ³•å“åº”ï¼Œå°±æŸ¥æ‰¾å®ƒé‡Œé¢çš„å…ƒç´ ï¼Œæ‰¾å‡ºå¯ä»¥å“åº”çš„å¯¹è±¡å¹¶è¿›è¡Œå‘é€ã€‚</p>
<pre><code class="language-objectivec">@implementation NSArray (ForwardingIteration)

- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel
{
    NSMethodSignature *sig = [super methodSignatureForSelector:sel];
    if(!sig)
    {
        for(id obj in self)
            if((sig = [obj methodSignatureForSelector:sel]))
                break;
    }
    return sig;
}

- (void)forwardInvocation:(NSInvocation *)inv
{
    for(id obj in self)
        [inv invokeWithTarget:obj];
}

@end
</code></pre>
<p>ä»¥ä¸Šä¸‰ä¸ªæµç¨‹ï¼Œæ€§èƒ½é€’å‡ï¼Œçµæ´»æ€§é€’å¢ï¼Œå¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚åœ¨å¯¹åº”çš„æµç¨‹ä¸­è¿›è¡Œå¤„ç†ã€‚</p>
<h2 id="æ¶ˆæ¯è½¬å‘çš„åº”ç”¨"><a class="header" href="#æ¶ˆæ¯è½¬å‘çš„åº”ç”¨">æ¶ˆæ¯è½¬å‘çš„åº”ç”¨</a></h2>
<p><a href="https://triplecc.github.io/2017/07/09/2017-07-09-objective-cxiao-xi-zhuan-fa-ying-yong-zhi-ji-chu/">Objective-C æ¶ˆæ¯è½¬å‘åº”ç”¨åœºæ™¯æ‘˜å½•</a></p>
<h3 id="weak-proxy"><a class="header" href="#weak-proxy">Weak Proxy</a></h3>
<p><a href="https://github.com/ibireme/YYKit/blob/master/YYKit/Utility/YYWeakProxy.m">ibireme/YYKit</a></p>
<p><code>YYWeakProxy</code> é€šè¿‡å¼±å¼•ç”¨æŒæœ‰å¯¹è±¡æ¥é¿å…å¾ªç¯å¼•ç”¨ï¼Œåœ¨è®¾ç½® <code>NSTimer</code> æˆ–è€… <code>CADisplayLink</code> æ—¶å¯ä»¥ä½¿ç”¨ï¼Œç¤ºä¾‹ä»£ç ï¼š</p>
<pre><code class="language-objectivec">@implementation MyView {
    NSTimer *_timer;
}

- (void)initTimer {
    YYWeakProxy *proxy = [YYWeakProxy proxyWithTarget:self];
    _timer = [NSTimer timerWithTimeInterval:0.1 target:proxy selector:@selector(tick:) userInfo:nil repeats:YES];
}

- (void)tick:(NSTimer *)timer {...}
@end
</code></pre>
<h3 id="delegate-proxy"><a class="header" href="#delegate-proxy">Delegate Proxy</a></h3>
<p><a href="https://github.com/Instagram/IGListKit/blob/019b22da07324f5dfdb81863865360937087b95d/Source/IGListKit/Internal/IGListAdapterProxy.m">Instagram/IGListKit</a></p>
<p>å†…éƒ¨å¯¹ä»£ç†è¿›è¡Œä¸€å±‚å°è£…ï¼Œå¯ä»¥åŒºåˆ†ä¸åŒçš„æ–¹æ³•ï¼Œè½¬å‘ç»™ä¸åŒçš„å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å‡å°‘èƒ¶æ°´ä»£ç ï¼Œä¸éœ€è¦æ‰‹åŠ¨å¯¹æ¯ä¸ªä»£ç†æ–¹æ³•è¿›è¡Œè½¬å‘ã€‚</p>
<h3 id="multicast-delegate"><a class="header" href="#multicast-delegate">Multicast Delegate</a></h3>
<p><a href="https://github.com/robbiehanson/XMPPFramework/wiki/MulticastDelegate">robbiehanson/XMPPFramework</a></p>
<p>Wiki é‡Œåˆ—äº†ä¸€ä¸‹ <code>Delegate</code> å’Œ <code>Notification</code> çš„ä¼˜ç¼ºç‚¹ï¼Œä»¥åŠ Multicast Delegate çš„ç‰¹æ€§ã€‚</p>
<p><code>Delegate</code> ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ³¨å†Œå¤šä¸ªå›è°ƒæ–¹æ³•æ›´åŠ å®¹æ˜“ï¼›</li>
<li>å¤„ç†å¤šä¸ªå‚æ•°æ—¶æ›´åŠ å®¹æ˜“å’Œç®€å•ï¼›</li>
<li>å…è®¸è¿”å›å€¼ã€‚</li>
</ul>
<p><code>Delegate</code> ç¼ºç‚¹ï¼š</p>
<ul>
<li>åªèƒ½æœ‰ä¸€ä¸ª <code>Delegate</code> ã€‚</li>
</ul>
<p><code>Notification</code> ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å¤šä¸ªå¯¹è±¡å¯ä»¥å“åº”åŒä¸€ä¸ªé€šçŸ¥ã€‚</li>
</ul>
<p><code>Notification</code> ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ³¨å†Œå¤šä¸ªå›è°ƒæ—¶éå¸¸éº»çƒ¦ï¼›</li>
<li>ä» <code>Dictionary</code> é‡Œå–å‡ºå‚æ•°æ—¶ä¹Ÿååˆ†éº»çƒ¦ï¼›</li>
<li>ä¸æ”¯æŒè¿”å›å€¼ã€‚</li>
</ul>
<p>Multicast Delegate æ”¯æŒçš„ç‰¹æ€§ï¼š</p>
<ul>
<li>æ”¯æŒå¤šä¸ªå›è°ƒå¯¹è±¡ï¼Œå³å¹¿æ’­ç»™æ‰€æœ‰ç›‘å¬è€…ï¼›</li>
<li>è‰¯å¥½çš„æ‰©å±•æ€§ï¼Œæ”¯æŒå®šä¹‰ä¸åŒçš„ <code>Delegate</code> ï¼›</li>
<li>æ”¯æŒè¿”å›å€¼ï¼›</li>
<li>çº¿ç¨‹å®‰å…¨ã€‚</li>
</ul>
<p>æ ¸å¿ƒåŸç†å°±æ˜¯åœ¨ <code>methodSignatureForSelector:</code> å’Œ <code>forwardInvocation:</code> ä¸­è¿›è¡Œè°ƒç”¨ <code>delegates</code> ä¸­å¯¹åº”çš„æ–¹æ³•ï¼Œå…·ä½“å®ç°å¯ä»¥æŸ¥çœ‹æºä»£ç ï¼š</p>
<p><a href="https://github.com/robbiehanson/XMPPFramework/blob/master/Utilities/GCDMulticastDelegate.m">robbiehanson/XMPPFramework</a></p>
<h3 id="nsundomanager"><a class="header" href="#nsundomanager">NSUndoManager</a></h3>
<p><code>NSUndoManager</code> é€šè¿‡ <code>NSInvocation</code> è®°å½• <code>undo</code> æ—¶éœ€è¦æ‰§è¡Œçš„æ–¹æ³•ï¼Œå½“ <code>undo</code> æ—¶å°±è§¦å‘æœ€æ–°çš„ <code>NSInvocation</code> ã€‚</p>
<h3 id="aspects"><a class="header" href="#aspects">Aspects</a></h3>
<p><a href="https://github.com/steipete/Aspects">steipete/Aspects</a></p>
<p>æ ¸å¿ƒåŸç†ï¼š</p>
<ol>
<li>å¯¹ <code>-forwardInvocation:</code> è¿›è¡Œ hook ï¼Œä»¥ä¾¿åœ¨æ‰§è¡ŒåŸå‡½æ•°å‰åè¿›è¡Œä¸€äº›æ“ä½œï¼›</li>
<li>å¯¹éœ€è¦å¤„ç†çš„æ–¹æ³•è¿›è¡Œ hook ï¼Œæ›¿æ¢ä¸º <code>_objc_msgForward</code> æˆ–è€… <code>_objc_msgForward_stret</code> ï¼Œè¿™æ ·å°±ä¼šè§¦å‘æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼Œæ‰§è¡Œ <code>-forwardInvocation:</code> ã€‚</li>
</ol>
<p>å…·ä½“çš„æºç è§£æï¼š</p>
<p><a href="https://dirtmelon.github.io/posts/Aspects/">Aspects</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kvo"><a class="header" href="#kvo">KVO</a></h1>
<h2 id="åŸºç¡€"><a class="header" href="#åŸºç¡€">åŸºç¡€</a></h2>
<p>å®˜æ–¹æ–‡æ¡£ï¼š</p>
<p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html#//apple_ref/doc/uid/10000177-BCICJDHA">Introduction to Key-Value Observing Programming Guide</a></p>
<p>å¼€å¯ KVO éœ€è¦ä¸¥æ ¼éµå¾ªä»¥ä¸‹ 3 ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>ä½¿ç”¨ <code>addObserver:forKeyPath:options:context:</code> æ–¹æ³•æ³¨å†Œç›‘å¬è€…ï¼›</li>
<li>åœ¨ç›‘å¬ç±»ä¸­å®ç° <code>observeValueForKeyPath:ofObject:change:context:</code> æ–¹æ³•æ¥æ¥æ”¶é€šçŸ¥ï¼›</li>
<li>å½“ä¸éœ€è¦æ¥æ”¶æ—¶ï¼Œéœ€è¦è°ƒç”¨ <code>removeObserver:forKeyPath:</code> ã€‚åœ¨ç›‘å¬è€… <code>dealloc</code> æ–¹æ³•ä¸­éœ€è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥ç§»é™¤ç›‘å¬ã€‚</li>
</ol>
<p>å…¶å®ƒï¼š</p>
<p><code>automaticallyNotifiesObserversForKey:</code> é»˜è®¤è¿”å› <code>YES</code> ï¼Œå½“é‡å†™å¹¶å¯¹æŸä¸ª <code>Key</code> è¿”å› <code>NO</code> æ—¶ï¼Œé‚£ä¹ˆä¿®æ”¹å±æ€§æ—¶å°±éœ€è¦æ‰‹åŠ¨è°ƒç”¨ <code>(void)willChangeValueForKey:(NSString *)key</code> ä¸ <code>-(void)didChangeValueForKey:(NSString *)key</code> å‘é€é€šçŸ¥ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¿™æ ·åœ¨ <code>Setter</code> æ–¹æ³•åˆ¤æ–­å¯¹è±¡æ˜¯å¦çœŸçš„å‘ç”Ÿæ”¹å˜ï¼Œåªæœ‰çœŸçš„å‘ç”Ÿæ”¹å˜æ—¶æ‰å‘é€é€šçŸ¥ã€‚</p>
<h2 id="kvo-è¯¦è§£"><a class="header" href="#kvo-è¯¦è§£">KVO è¯¦è§£</a></h2>
<p><a href="https://kingcos.me/posts/2019/kvo_in_ios/">iOS ä¸­çš„ KVO</a></p>
<p>è¿™ç¯‡æ–‡ç« éå¸¸è¯¦ç»†ï¼Œä» <code>KVO</code> çš„ä½¿ç”¨åˆ°åŸç†éƒ½è¿›è¡Œäº†è¯´æ˜ã€‚</p>
<h2 id="kvc-å’Œ-kvo"><a class="header" href="#kvc-å’Œ-kvo">KVC å’Œ KVO</a></h2>
<p><a href="https://objccn.io/issue-7-3/">ObjC ä¸­å›½ - KVC å’Œ KVO</a></p>
<p>ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼ŒKVO è¡Œä¸ºæ˜¯åŒæ­¥çš„ï¼Œå¹¶ä¸”å‘ç”Ÿä¸æ‰€è§‚å¯Ÿçš„å€¼å‘ç”Ÿå˜åŒ–çš„åŒæ ·çš„çº¿ç¨‹ä¸Šã€‚æ²¡æœ‰é˜Ÿåˆ—æˆ–è€… RunLoop çš„å¤„ç†ã€‚</p>
<p><a href="https://github.com/objcio/issue-7-lab-color-space-explorer/blob/master/Lab%20Color%20Space%20Explorer/KeyValueObserver.m">objcio/issue-7-lab-color-space-explorer</a></p>
<h2 id="friday-qa-about-kvo"><a class="header" href="#friday-qa-about-kvo">Friday Q&amp;A About KVO</a></h2>
<p><a href="https://www.mikeash.com/pyblog/friday-qa-2009-01-23.html">mikeash.com: Friday Q&amp;A 2009-01-23</a></p>
<p>Mikeash å…³äº KVO åŸç†çš„æ–‡ç« ï¼š</p>
<ul>
<li>åŠ¨æ€ç”Ÿæˆä¸€ä¸ª <code>KVO</code> çš„å­ç±»ï¼Œå®ç°äº† <code>dealloc</code> ï¼Œ <code>_isKVOA</code> ï¼Œ <code>class</code> æ–¹æ³•ï¼›</li>
<li>åªä¼šç”Ÿæˆä¸€ä¸ª <code>KVO</code> å­ç±»ï¼Œå¯¹æ‰€æœ‰ç›‘å¬çš„å±æ€§çš„è®¾ç½®æ–¹æ³•éƒ½è¿›è¡Œäº†æ›¿æ¢ï¼Œå¦‚æœé’ˆå¯¹ä¸åŒçš„å±æ€§ç›‘å¬ç”Ÿæˆä¸åŒç±»ï¼Œå°±éœ€è¦åŠ¨æ€ç”Ÿæˆå¤§é‡çš„ä¸åŒçš„ç±»ï¼Œæ‰€ä»¥è‹¹æœé€‰æ‹©äº†åªç”Ÿæˆä¸€ä¸ªç±»ï¼›</li>
<li>æ›¿æ¢äº†å¯¹åº”çš„æ–¹æ³•çš„ <code>IMP</code> ï¼Œæ”¹ç”¨å†…éƒ¨çš„ <code>NSSet...ValueAndNotify</code> ï¼›</li>
</ul>
<h2 id="key-value-observing-done-right"><a class="header" href="#key-value-observing-done-right">Key-Value Observing Done Right</a></h2>
<p><a href="https://www.mikeash.com/pyblog/key-value-observing-done-right.html">mikeash.com: Key-Value Observing Done Right</a></p>
<p>Mikeash å…ˆæ˜¯å¹æ§äº†ä¸€ä¸‹ KVO æœºåˆ¶ï¼Œéå¸¸å¼ºå¤§å’Œå¥½ç”¨ï¼Œä½†æ˜¯ API è®¾è®¡éå¸¸ç³Ÿç³•ï¼š</p>
<ol>
<li><code>-addObserver:forKeyPath:options:context:</code> ä¸æ”¯æŒ <code>selector</code> å‚æ•°ï¼Œå¯¹æ¯” <code>NSNotificationCenter</code> çš„è®¾è®¡ï¼Œå¯è°“é«˜ä¸‹ç«‹åˆ¤ï¼Œ KVO å¿…é¡»è¦åœ¨  <code>-observeValueForKeyPath:ofObject:change:context:</code> ä¸­å¤„ç†æ¶ˆæ¯æˆ–è€…ä¼ é€’ç»™çˆ¶ç±»ï¼›</li>
<li>å› ä¸ºä¸æ”¯æŒ <code>selector</code> å‚æ•°ï¼Œæ‰€ä»¥å¦‚æœåœ¨ç›¸åŒçš„ <code>observer</code> ç›‘å¬ç›¸åŒçš„ <code>KeyPath</code> æ—¶ï¼Œéœ€è¦é€šè¿‡ <code>context</code> å‚æ•°æ¥è¿›è¡ŒåŒºåˆ†ï¼›</li>
<li><code>-removeObserver:forKeyPath:</code> ä¸æ”¯æŒ <code>context</code> å‚æ•°ï¼Œ KVO æ˜¯åœ¨ iOS2.0 æ—¶å¢åŠ çš„ï¼Œåé¢åœ¨ iOS5.0 æ–°å¢äº† <code>-removeObserver:forKeyPath:context:</code> ï¼Œæ”¯æŒ <code>context</code> å‚æ•°ã€‚</li>
</ol>
<h2 id="kvo-considered-harmful"><a class="header" href="#kvo-considered-harmful">KVO Considered Harmful</a></h2>
<p><a href="https://khanlou.com/2013/12/kvo-considered-harmful/">kvo-considered-harmful</a></p>
<p>KVO ç¼ºç‚¹ï¼š</p>
<ol>
<li>æ‰€æœ‰å›è°ƒéƒ½åœ¨åŒä¸€ä¸ªæ–¹æ³•ä¸­è¿›è¡Œï¼Œç¨ä¸ç•™æ„è¿™ä¸ªæ–¹æ³•å°±ä¼šå¿«é€Ÿè†¨èƒ€ï¼›</li>
<li>ä½¿ç”¨å­—ç¬¦ä¸²ç¡¬ç¼–ç ï¼Œå¦‚æœè¢«ç›‘å¬çš„å¯¹è±¡ä¿®æ”¹äº†å±æ€§åï¼Œç¼–è¯‘æœŸæ— æ³•å¯Ÿè§‰ï¼›</li>
<li>è¦æ±‚å¤„ç†çˆ¶ç±»çš„ KVO æµç¨‹ï¼›</li>
<li>ç§»é™¤ observer æ—¶æœ‰å¯èƒ½ä¼šå´©æºƒï¼›</li>
<li>å……æ–¥ç€å¤§é‡æœ‰å¯èƒ½ä¼šå¤±è´¥çš„æ“ä½œï¼Œä½œè€…è®¤ä¸ºä¸€ä¸ªå¥½çš„ API è®¾è®¡åº”è¯¥èµ·åˆ°ä½¿ç”¨è€…æˆåŠŸåœ°è°ƒç”¨ä»–ä»¬ï¼Œå³ä½¿æ²¡æœ‰è§£é‡Šä¸ºä»€ä¹ˆè¦è¿™æ ·å»è°ƒç”¨ï¼›</li>
<li>æµç¨‹è¿‡äºéšè—ï¼Œæ²¡åŠæ³•è¿½è¸ªæ•°æ®æ”¹å˜çš„æµç¨‹ï¼Œä¸ delegate æ¨¡å¼ç›¸æ¯”ï¼Œ KVO åœ¨ debug æ—¶æ¯”è¾ƒéº»çƒ¦ï¼Œä¸”éœ€è¦åœ¨è¿è¡Œæ—¶é€šè¿‡ <code>isKindOfClass:</code> åŠ¨æ€åˆ¤æ–­ç±»å‹ï¼›</li>
<li>æœ‰å¯èƒ½é€ æˆæ­»å¾ªç¯ï¼Œå¦‚æœä¸å°å¿ƒåœ¨å›è°ƒä¸­ä¿®æ”¹äº†ç›‘å¬çš„å±æ€§ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆæ­»å¾ªç¯ï¼Œå¦‚æœè¯´ä¸¤ä¸ªå±æ€§åœ¨ä¸åŒçš„ KVO æµç¨‹ä¸­äº’ç›¸ä¿®æ”¹ï¼Œä¹Ÿä¼šé€ æˆæ­»å¾ªç¯ï¼Œä¸”éš¾äº debug ï¼›</li>
<li>KVO åœ¨æŸäº›åœºæ™¯ä¸‹ä¼šå¤±æ•ˆï¼Œæ¯”å¦‚è¯´ <code>__weak</code> å±æ€§ï¼Œåœ¨ <code>__weak</code> å¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œ KVO æ˜¯ä¸ä¼šå»æ¸…ç†å¯¹åº”çš„ç›‘å¬ï¼Œå¯¼è‡´å¯èƒ½ä¼šå‡ºç°é‡æŒ‡é’ˆå´©æºƒï¼›</li>
<li>KVO æ˜¯ä¸€ç§è€æ—§çš„æ¨¡å¼ï¼Œåœ¨ Apple å¹³å°ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…¶å®ƒæ–¹å¼æ¯”å¦‚è¯´ Delegate ï¼ŒBlock å’Œæ˜ç¡®çš„å‘å¸ƒ/è®¢é˜… ï¼ˆ <code>NSNotificationCenter</code> ï¼‰æ–¹å¼æ¥è§£å†³é—®é¢˜ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ KVO è¿™ç§éšæ™¦çš„æ–¹å¼ã€‚</li>
</ol>
<p>ä»€ä¹ˆæ—¶å€™å¯ä»¥ä½¿ç”¨ KVO ï¼š</p>
<ol>
<li>Apple å®˜æ–¹è¦æ±‚ï¼Œæ¯”å¦‚è¯´ <code>AVPlayer</code> ï¼Œè¦æ±‚é€šè¿‡ç›‘å¬ <code>status</code> å±æ€§æ¥è·å–æ’­æ”¾å™¨çš„çŠ¶æ€ï¼›</li>
<li>è®¾è®¡ç›¸å…³çš„ API ç»™å…¶ä»–å¼€å‘è€…ä½¿ç”¨ã€‚</li>
</ol>
<h2 id="åˆ¨æ ¹é—®é¢˜-kvo-åŸç†"><a class="header" href="#åˆ¨æ ¹é—®é¢˜-kvo-åŸç†">åˆ¨æ ¹é—®é¢˜ KVO åŸç†</a></h2>
<p><a href="https://juejin.im/post/5c22023df265da6124157a25">åˆ¨æ ¹é—®åº•KVOåŸç†</a></p>
<p>é€šè¿‡æºç ç›¸å…³çš„ä¼ªä»£ç æ¥æ¢ç©¶ <code>KVO</code> çš„å®ç°æ–¹å¼ï¼Œå¦‚æœéœ€è¦æ·±å…¥äº†è§£ <code>KVO</code> çš„åŸç†ï¼Œå¯ä»¥é˜…è¯»ä¸‹è¿™ç¯‡æ–‡ç« ã€‚ <code>KVO</code> çš„åŸç†çœ‹èµ·æ¥è™½ç„¶æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å®ç°æ—¶è¿˜æ˜¯æœ‰ä¸å°‘å‘ï¼Œæ¯”å¦‚è¯´å¤šçº¿ç¨‹ï¼Œç³»ç»Ÿçš„å…·ä½“å®ç°ä¹Ÿä½“ç°äº†è¿™ä¸€ç‚¹ï¼Œé€šè¿‡ <code>pthread_mutex_lock</code> æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>
<h2 id="kvocontroller-è§£æ"><a class="header" href="#kvocontroller-è§£æ">KVOController è§£æ</a></h2>
<p><a href="https://github.com/draveness/analyze/blob/master/contents/KVOController/KVOController.md">draveness/analyze</a></p>
<p><a href="https://github.com/facebookarchive/KVOController">facebookarchive/KVOController</a></p>
<p>ä¸ºäº†è§£å†³ <code>KVO</code> éå¸¸éš¾ç”¨çš„é—®é¢˜ï¼ŒFacebook å¼€æºäº† <code>KVOController</code> ï¼Œä¼˜ç‚¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ä¸éœ€è¦æ‰‹åŠ¨ç§»é™¤ <code>observer</code> ï¼Œè¿™é‡Œåˆ©ç”¨äº†å…³è”å±æ€§åœ¨å¯¹è±¡é‡Šæ”¾æ—¶ä¹Ÿä¼šè¢«é‡Šæ”¾çš„åŸç†ï¼Œåœ¨å…³è”å±æ€§çš„ <code>dealloc</code> æ–¹æ³•ä¸­ç§»é™¤ <code>observer</code> ï¼›</li>
<li>æ”¯æŒä½¿ç”¨ <code>block</code> ï¼Œå‡å°‘å¤æ‚åº¦ï¼Œæ·»åŠ ç›‘å¬å’Œå¤„ç†é€šçŸ¥çš„ä»£ç å¯ä»¥æ”¾åœ¨åŒä¸€å¤„ã€‚</li>
</ol>
<h2 id="åŸºäº-kvo-hook-å­ç±»çš„æ–¹æ³•"><a class="header" href="#åŸºäº-kvo-hook-å­ç±»çš„æ–¹æ³•">åŸºäº KVO hook å­ç±»çš„æ–¹æ³•</a></h2>
<p><a href="http://satanwoo.github.io/2017/11/27/KVO-Swizzle/">ä¸€ç§åŸºäºKVOçš„é¡µé¢åŠ è½½ï¼Œæ¸²æŸ“è€—æ—¶ç›‘æ§æ–¹æ³•</a></p>
<p>åœ¨åš <code>ViewController</code> çš„è€—æ—¶æ£€æµ‹æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è®°å½•å„ä¸ª <code>UIViewController</code> å­ç±»å¯¹åº”æ–¹æ³•çš„è€—æ—¶ï¼Œå¦‚æœåªæ˜¯é’ˆå¯¹ <code>UIViewController</code> çš„æ–¹æ³•è¿›è¡Œ <code>hook</code> ï¼Œé‚£ä¹ˆåªèƒ½è®°å½•åˆ° <code>UIViewController</code> çš„æ–¹æ³•è€—æ—¶ï¼Œæ— æ³•è·å–å­ç±»çš„æ–¹æ³•è€—æ—¶ã€‚</p>
<p>åœ¨è¿›è¡Œ <code>KVO</code> æ—¶ <code>runtime</code> å®é™…ä¸Šä¼šå¸®ä½ åˆ›å»ºä¸€ä¸ª <code>KVO</code> ç›¸å…³çš„å­ç±»ï¼Œç”±æ­¤å¯ä»¥åœ¨åˆå§‹åŒ–æ—¶è¿›è¡Œä¸€æ¬¡ <code>KVO</code> æ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„å­ç±»ï¼Œç„¶åå¯¹è¿™ä¸ªå­ç±»æ–¹æ³•è¿›è¡Œè€—æ—¶æ£€æµ‹ã€‚</p>
<p>è‡³äºä¸ºä»€ä¹ˆä½¿ç”¨ <code>KVO</code> çš„æ–¹å¼ï¼Œä¸‹é¢è¿™ç¯‡æ–‡ç« æœ‰è¿›è¡Œè§£é‡Šï¼Œè€Œä¸”ä¹Ÿç»™å‡ºäº†å…·ä½“å®ç°ä»£ç ï¼š</p>
<p><a href="https://punmy.cn/2018/06/18/15278496835424.html">å·§å¦™åˆ©ç”¨KVOå®ç°ç²¾å‡†çš„VCè€—æ—¶æ£€æµ‹</a></p>
<p><a href="https://github.com/panmingyang2009/VCProfiler">panmingyang2009/VCProfiler</a></p>
<h2 id="kvo-åœ¨ä¸åŒçš„äºŒè¿›åˆ¶ä¸­å¤šä¸ªç¬¦å·å¹¶å­˜çš„-crash-é—®é¢˜"><a class="header" href="#kvo-åœ¨ä¸åŒçš„äºŒè¿›åˆ¶ä¸­å¤šä¸ªç¬¦å·å¹¶å­˜çš„-crash-é—®é¢˜">KVO åœ¨ä¸åŒçš„äºŒè¿›åˆ¶ä¸­å¤šä¸ªç¬¦å·å¹¶å­˜çš„ Crash é—®é¢˜</a></h2>
<p><a href="http://satanwoo.github.io/2017/09/11/KVO-CRASH/">KVOåœ¨ä¸åŒçš„äºŒè¿›åˆ¶ä¸­å¤šä¸ªç¬¦å·å¹¶å­˜çš„Crashé—®é¢˜</a></p>
<p>å½“ä¸¤ä¸ªäº§ç‰©éƒ½æœ‰ç›¸åŒçš„ç±»åæ—¶ï¼Œæ¯”å¦‚ä¸»äºŒè¿›åˆ¶å’ŒåŠ¨æ€åº“ä¸­ï¼Œè¿™ä¸¤ä¸ªç±»éƒ½ä¼šè¢« realize ï¼Œéƒ½èƒ½å¤Ÿè¢«æ­£å¸¸è°ƒç”¨ã€‚</p>
<blockquote>
<p>å…¶åŸå› åœ¨äºè‹¹æœä½¿ç”¨çš„æ˜¯ <code>two level namespace</code> çš„æŠ€æœ¯ã€‚åœ¨è¿™ç§å½¢å¼ä¸‹ï¼Œç¬¦å·æ‰€åœ¨çš„â€œåº“â€çš„åç§°ä¹Ÿä¼šä½œä¸ºç¬¦å·çš„ä¸€éƒ¨åˆ†ã€‚é“¾æ¥çš„æ—¶å€™ï¼Œ <code>staic linker</code> ä¼šæ ‡è®°ä½åœ¨è¿™ä¸ªç¬¦å·æ˜¯æ¥è‡ªäºå“ªä¸ªåº“çš„ã€‚è¿™æ ·ä¸ä»…å¤§å¤§å‡å°‘äº†dyldæœç´¢ç¬¦å·æ‰€éœ€è¦çš„æ—¶é—´ï¼Œä¹Ÿæ›´å¥½å¯¹åç»­åº“çš„æ›´æ–°è¿›è¡Œäº†å…¼å®¹ã€‚</p>
</blockquote>
<p>ä½†æ˜¯ç”±äºå…¨å±€ç±»è¡¨çš„å­˜åœ¨ï¼Œåœ¨åŠ¨æ€åˆ›å»º <code>KVO</code> çš„å­ç±»æ—¶ï¼Œåªèƒ½äº§ç”Ÿä¸€ä¸ªã€‚æ‰€ä»¥å°±å¯¼è‡´ <code>allocate</code> å¤±è´¥ï¼Œä»è€Œå¼•å‘ <code>register</code> è¿‡ç¨‹çš„ Crash é—®é¢˜ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kvc"><a class="header" href="#kvc">KVC</a></h1>
<h2 id="åŸºç¡€-1"><a class="header" href="#åŸºç¡€-1">åŸºç¡€</a></h2>
<p>å®˜æ–¹æ–‡æ¡£ï¼š</p>
<p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueCoding/index.html#//apple_ref/doc/uid/10000107-SW1">About Key-Value Coding</a></p>
<p><code>KVC</code> æ˜¯é€šè¿‡ <code>NSKeyValueCodinng</code> åè®®æ¥å®ç°çš„ã€‚å½“ä¸€ä¸ªå¯¹è±¡æ”¯æŒ <code>KVC</code> æ—¶ï¼Œå®ƒçš„å±æ€§å¯ä»¥é€šè¿‡å­—ç¬¦ä¸²æ¥è¿›è¡Œè®¿é—®ã€‚ <code>KVC</code> å¯¹è±¡æä¾›äº†ç®€å•çš„æ¥å£ï¼Œé€šè¿‡æ¥å£å’Œå­—ç¬¦ä¸²å¯ä»¥è®¿é—®æ‰€æœ‰çš„å±æ€§ã€‚ <code>KVC</code> æ˜¯ Cocoa ä¸­ä¸€äº›åŠŸèƒ½çš„åŸºçŸ³ï¼Œå¦‚ <code>KVO</code> ï¼Œ <code>Cocoa</code> ç»‘å®šæœºåˆ¶ï¼Œ Core Data ç­‰ã€‚</p>
<h3 id="ç”¨é€”"><a class="header" href="#ç”¨é€”">ç”¨é€”</a></h3>
<p>åªè¦ç»§æ‰¿è‡ª <code>NSObject</code> å°±å¯ä»¥ä½¿ç”¨ <code>KVC</code> ï¼Œ <code>NSObject</code> å·²é»˜è®¤æ”¯æŒ <code>NSKeyValueCoding</code> åè®®å’Œæä¾›é»˜è®¤çš„å¿…é¡»æ–¹æ³•ï¼Œ <code>KVC</code> æä¾›äº†ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>è·å–å¯¹è±¡å±æ€§ã€‚åè®®å®šä¹‰äº†ä¸€äº›æ–¹æ³•ï¼Œæ¯”å¦‚è¯´ <code>valueForKey:</code> å’Œ <code>setValue:forKey:</code> ï¼Œä½¿ç”¨å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ï¼Œå¯ä»¥è®¿é—®åˆ°å¯¹è±¡çš„å±æ€§æˆ–è€…å¯¹å±æ€§è¿›è¡Œè®¾ç½®ï¼›</li>
<li>æ“ä½œé›†åˆå±æ€§ï¼Œè·Ÿå…¶å®ƒå±æ€§ä¸€æ ·ï¼Œæä¾›äº†å¯¹é›†åˆå±æ€§è¿›è¡Œæ“ä½œçš„æ–¹æ³•ï¼Œå¦‚æœéœ€è¦å¯¹é›†åˆè¿›è¡Œä¿®æ”¹ï¼Œ <code>KVC</code> ä¹Ÿæä¾›äº†ç‹¬ç‰¹é«˜æ•ˆçš„æ–¹æ³•ï¼›</li>
<li>é›†åˆå±æ€§çš„æ“ä½œç¬¦ï¼Œå½“è®¿é—®å¯¹è±¡çš„é›†åˆå±æ€§æ—¶ï¼Œ <code>KVC</code> ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›æ“ä½œç¬¦ï¼Œé€šè¿‡è¿™äº›æ“ä½œç¬¦å¯ä»¥ç›´æ¥å¯¹é›†åˆè·å–æŸäº›å±æ€§ï¼Œç»§ç»­è®¡ç®—è½¬æ¢ç­‰ï¼›</li>
<li>è·å–éå¯¹è±¡å±æ€§ï¼Œ <code>KVC</code> ä¹Ÿæ”¯æŒè·å–éå¯¹è±¡å±æ€§ï¼ŒåŒ…æ‹¬çº¯é‡å±æ€§å’Œç»“æ„ä½“ç­‰ï¼Œä¼šè‡ªåŠ¨å°†å®ƒä»¬å’Œå¯¹è±¡ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼Œä»¥ä¾¿åè®®çš„æ–¹æ³•è¿›è¡Œè°ƒç”¨ï¼›</li>
</ul>
<h3 id="é€‚é…-kvc"><a class="header" href="#é€‚é…-kvc">é€‚é… KVC</a></h3>
<p>å¦‚æœæƒ³è¦ä½ çš„å¯¹è±¡æ”¯æŒ <code>KVC</code> ï¼Œé‚£ä¹ˆä½ éœ€è¦ä½¿å¾—å®ƒä»¬éµå¾ª <code>NSKeyValueCoding</code> åè®®ã€‚å¹¸è¿çš„æ˜¯ï¼Œ <code>NSObject</code> å·²ç»ä¸ºæˆ‘ä»¬åšå¥½ä¸€åˆ‡å·¥ä½œï¼Œå› æ­¤å¦‚æœä½ æƒ³è¦ä½¿ç”¨ <code>KVC</code> ï¼Œé‚£ä¹ˆåªéœ€è¦ç»§æ‰¿è‡ª <code>NSObject</code> å³å¯ã€‚ä¸ºäº†ä¿è¯ <code>KVC</code> ç”Ÿæ•ˆï¼Œä½ éœ€è¦ä¿è¯å¯¹è±¡çš„å­˜å–å™¨å’Œå˜é‡åéµå®ˆç›¸å…³çš„è§„åˆ™ã€‚</p>
<h3 id="è·å–å¯¹è±¡å±æ€§"><a class="header" href="#è·å–å¯¹è±¡å±æ€§">è·å–å¯¹è±¡å±æ€§</a></h3>
<p>ä¸€ä¸ªå¯¹è±¡ä¼šåœ¨å®ƒçš„ <code>interface</code> å£°æ˜ä¸­å®šä¹‰å±æ€§ï¼Œè€Œå±æ€§åˆ™ä¼šåˆ†æˆä»¥ä¸‹å‡ ä¸ªåˆ†ç±»ï¼š</p>
<ul>
<li>å±æ€§ï¼Œç³»ç»Ÿæä¾›çš„ä¸€äº›æ¯”è¾ƒç®€å•çš„å€¼ï¼Œå¦‚çº¯é‡å±æ€§ï¼Œå­—ç¬¦ä¸²ï¼Œ <code>Bool</code> å€¼ç­‰ã€‚</li>
<li>ä¸€å¯¹ä¸€å…³ç³»ï¼Œå¯¹äºæ‹¥æœ‰è€…æ¥è¯´å®ƒä»¬æ˜¯å¯å˜å¯¹è±¡ã€‚ä¸€ä¸ªå¯¹è±¡çš„å±æ€§å¯ä»¥åœ¨å¯¹è±¡æœ¬èº«ä¸æ”¹å˜çš„æƒ…å†µä¸‹å‘ç”Ÿæ”¹å˜ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªé“¶è¡Œå®¢æˆ·çš„å¯¹è±¡æ‹¥æœ‰ä¸€ä¸ª <code>Person</code> çš„ <code>owner</code> å±æ€§ï¼Œ <code>Person</code> æ‹¥æœ‰ä¸€ä¸ªåœ°å€å±æ€§ã€‚ <code>owner</code> å°±å¯ä»¥åœ¨ä¸æ”¹å˜é“¶è¡Œå®¢æˆ·çš„å¼•ç”¨å…³ç³»çš„å‰æä¸‹æ”¹å˜è‡ªå·±çš„åœ°å€å±æ€§ï¼›</li>
<li>ä¸€å¯¹å¤šï¼Œé›†åˆå¯¹è±¡ï¼Œæ¯”å¦‚è¯´ <code>NSArray</code> æˆ–è€… <code>NSSet</code> ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶å®ƒçš„ä¸€äº›è‡ªå®šä¹‰é›†åˆç±»å‹ï¼›</li>
</ul>
<pre><code class="language-objectivec">@interface BankAccount : NSObject
 
@property (nonatomic) NSNumber* currentBalance;              // An attribute
@property (nonatomic) Person* owner;                         // A to-one relation
@property (nonatomic) NSArray&lt; Transaction* &gt;* transactions; // A to-many relation
 
@end
</code></pre>
<p>ä¸ºäº†ä¿æŒå°è£…æ€§ï¼Œä¸€ä¸ªå¯¹è±¡ä¼šæä¾›ä¸ºå±æ€§æä¾›å­˜å–æ–¹æ³•ä½œä¸ºå®ƒçš„æ¥å£ã€‚</p>
<pre><code class="language-objectivec">[myAccount setCurrentBalance:@(100.0)];
</code></pre>
<p>è¿™æ ·å¾ˆç›´æ¥ï¼Œä½†æ˜¯ä¼šç¼ºå°‘çµæ´»æ€§ã€‚ <code>KVC</code> ä¸ºå¯¹è±¡æä¾›äº†ä¸€ç§é€šè¿‡å­—ç¬¦ä¸²æ¥è·å–å±æ€§çš„æœºåˆ¶ã€‚</p>
<h3 id="é€šè¿‡-keys-æˆ–è€…-keypaths-è¯†åˆ«å¯¹è±¡çš„å±æ€§"><a class="header" href="#é€šè¿‡-keys-æˆ–è€…-keypaths-è¯†åˆ«å¯¹è±¡çš„å±æ€§">é€šè¿‡ <code>Keys</code> æˆ–è€… <code>KeyPaths</code> è¯†åˆ«å¯¹è±¡çš„å±æ€§</a></h3>
<p><code>key</code> æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¯¹åº”æŸä¸ªå±æ€§ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œ <code>key</code> ä¼šè·Ÿå±æ€§çš„åå­—ä¸€è‡´ã€‚ä½¿ç”¨  <code>ASCII</code> ç¼–ç ï¼Œä¸åŒ…å«ç©ºæ ¼ï¼Œä»¥å°å†™å­—æ¯å¼€å¤´ ï¼ˆå½“ç„¶äº†ï¼Œä¹Ÿä¼šæœ‰ä¾‹å¤–ï¼Œæ¯”å¦‚è¯´ <code>URL</code> å±æ€§ï¼‰ã€‚</p>
<p>å¯¹äº <code>BankAccount</code> æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å±æ€§æ¥è®¾ç½® <code>currentBalance</code> ï¼š</p>
<pre><code class="language-objectivec">[myAccount setValue:@(100.0) forKey:@&quot;currentBalance&quot;];
</code></pre>
<p>å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç›¸åŒçš„æ–¹æ³•ï¼Œä¸åŒçš„ <code>key</code> å‚æ•°æ¥è·å– <code>myAccount</code> å¯¹è±¡çš„æ‰€æœ‰å±æ€§ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>.</code> æ¥ä½¿ç”¨ <code>KeyPath</code> ã€‚å‡è®¾ <code>Person</code> å’Œ <code>Address</code> ä¹Ÿç¬¦åˆ <code>KVC</code> è§„èŒƒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>owner.address.street</code> çš„æ–¹å¼æ¥è®¿é—®è´¦æˆ·æ‰€æœ‰è€…çš„åœ°å€ä¸­çš„è¡—é“ä¿¡æ¯ã€‚</p>
<p><code>NSObject</code> å·²ç»å®ç°äº† <code>NSKeyValueCoding</code> åè®®æ‰€éœ€è¦çš„æ–¹æ³•ï¼Œæ‰€ä»¥åªéœ€è¦ç»§æ‰¿è‡ª <code>NSObject</code> ï¼Œå°±å¯ä»¥å¾—åˆ°é»˜è®¤çš„å®ç°å’Œæ”¯æŒ <code>KVC</code> ã€‚</p>
<ul>
<li><code>valueForKey:</code> ï¼Œè¿”å›ä¸€ä¸ªä»¥ <code>key</code> å‚æ•°æ¥è¿›è¡Œå‘½åçš„å±æ€§ã€‚å¦‚æœè¯´å±æ€§æ— æ³•è¢« <code>key</code> é€šè¿‡å®šå¥½çš„è§„åˆ™æœç´¢åˆ°ï¼Œå¯¹è±¡ä¼šè°ƒç”¨ <code>valueForUndefinedKey:</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯æŠ›å‡ºä¸€ä¸ª <code>NSUndefinedKeyException</code> å¼‚å¸¸ï¼Œä½†æ˜¯å­ç±»å¯ä»¥é€šè¿‡é‡å†™è¿™ä¸ªæ–¹æ³•æ¥æ›´ä¼˜é›…åœ°å¤„ç†è¿™ä¸ªåœºæ™¯ï¼›</li>
<li><code>valueForKeyPath:</code> ï¼Œè¿”å›æ¥æ”¶å™¨ä¸­æ»¡è¶³ <code>keyPath</code> è·¯å¾„çš„å€¼ã€‚æ‰€æœ‰åœ¨è¿™ä¸ª <code>keyPath</code> è·¯å¾„ä¸­çš„å¯¹è±¡éƒ½éœ€è¦æ»¡è¶³ç‰¹å®šçš„ <code>key</code> å¯¹åº”çš„ <code>KVC</code> æœºåˆ¶ï¼Œå¦‚æœè¯´ <code>valueForKey:</code> æ‰¾ä¸åˆ°å¯¹åº”çš„å­˜å–æ–¹æ³•ï¼Œå°±ä¼šæ”¶åˆ° <code>valueForUndefinedKey:</code> æ¶ˆæ¯ï¼›</li>
<li><code>dictionaryWithValuesForKeys:</code> ï¼Œè¿”å› <code>value</code> å’Œ <code>key</code> ç»„æˆçš„ <code>NSDictionary</code> ï¼Œå®ƒä¼šä¸ºæ•°ç»„çš„æ¯ä¸ª <code>key</code> è°ƒç”¨ <code>valueForKey:</code> æ–¹æ³•æ¥è·å–å¯¹åº”çš„å€¼ã€‚</li>
</ul>
<p>é›†åˆå¯¹è±¡ï¼Œæ¯”å¦‚è¯´ <code>NSArray</code> ï¼Œ <code>NSSet</code> å’Œ <code>NSDictionary</code> ï¼Œä¸å¯ä»¥åŒ…å« <code>nil</code> ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>NSNull</code> å¯¹è±¡æ¥æ›¿æ¢ <code>nil</code> ï¼Œ <code>NSNull</code> æä¾›äº†ä¸€ä¸ªå•ä¾‹æ¥è¡¨ç¤º <code>nil</code> å€¼ã€‚ <code>dictionaryWithValuesForKeys:</code> å’Œ <code>setValuesForKeysWithDictionary:</code> ä¼šåœ¨ <code>NSNull</code> ï¼ˆ dictionary å‚æ•°ï¼‰å’Œ <code>nil</code> ï¼ˆå±æ€§ï¼‰ä¸­è‡ªåŠ¨åˆ‡æ¢ã€‚</p>
<p><code>KeyPath</code> ä¹Ÿæ”¯æŒå¤šå¯¹ä¸€å…³ç³»ï¼Œå½“ <code>key-path</code> è·¯å¾„ä¸­æœ‰ä¸€å¯¹å¤šçš„å…³ç³»æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›æ•°ç»„ã€‚æ¯”å¦‚è¯´ <code>transactions.payee</code> ä¼šä»¥æ•°ç»„å½¢å¼è¿”å›æ‰€æœ‰ <code>transactions</code> ä¸­çš„ <code>payee</code> å¯¹è±¡ã€‚</p>
<h3 id="é€šè¿‡-keys-è®¾ç½®å±æ€§å€¼"><a class="header" href="#é€šè¿‡-keys-è®¾ç½®å±æ€§å€¼">é€šè¿‡ <code>Keys</code> è®¾ç½®å±æ€§å€¼</a></h3>
<p>å’Œ <code>getter</code> ä¸€æ ·ï¼Œ <code>KVC</code> ä¹Ÿæä¾›äº†ä¸€ç»„é€šç”¨çš„ <code>setter</code> æ–¹æ³•ï¼Œç”± <code>NSObject</code> ä¸­ <code>NSKeyValueCoding</code> åè®®çš„é»˜è®¤æ–¹æ³•æä¾›ï¼š</p>
<ul>
<li><code>setValue:forKey:</code> ï¼Œä½¿ç”¨ <code>value</code> æ¥è®¾ç½®å¯¹è±¡ä¸­å¯¹åº” <code>key</code> çš„å±æ€§ã€‚ <code>setValue:forKey:</code> çš„é»˜è®¤å®ç°ä¼šè‡ªåŠ¨å¯¹ <code>NSNumber</code> å’Œ <code>NSValue</code> å¯¹è±¡è¿›è¡Œè§£åŒ…ï¼ŒæŠŠå®ƒä»¬è½¬æ¢ä¸ºå¯¹åº”çš„çº¯é‡å’Œç»“æ„ä½“ï¼Œç„¶åè®¾ç½®åˆ°å¯¹åº”çš„å±æ€§ä¸­ã€‚å¦‚æœå¯¹è±¡ä¸­æ²¡æœ‰å’Œ <code>key</code> å¯¹åº”çš„ <code>setter</code> ï¼Œé‚£ä¹ˆå¯¹è±¡å°±ä¼šè°ƒç”¨å®ƒè‡ªå·±çš„ <code>setValue:forUndefinedKey:</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°ä¼šæŠ›å‡ºä¸€ä¸ª <code>NSUndefinedKeyException</code> å¼‚å¸¸ã€‚å­ç±»å¯ä»¥é€šè¿‡é‡å†™è¿™ä¸ªæ–¹æ³•æ¥ å®ç°è‡ªå®šä¹‰é€»è¾‘ã€‚</li>
<li><code>setValue:forKeyPath:</code> ï¼Œä½¿ç”¨ <code>value</code> æ¥è®¾ç½®å¯¹è±¡ä¸­ä¸ <code>keyPath</code> è·¯å¾„ç›¸ç¬¦çš„å±æ€§ã€‚å½“å­˜åœ¨ <code>keyPath</code> è·¯å¾„ä¸Šä¸æ”¯æŒå¯¹åº”çš„ <code>key</code> çš„ <code>KVC</code> æ—¶ï¼Œå°±ä¼šæ”¶åˆ° <code>setValue:forUndefinedKey:</code> æ¶ˆæ¯ã€‚</li>
<li><code>setValuesForKeysWithDictionary:</code> ï¼Œæ‰¹é‡è®¾ç½®å±æ€§ï¼Œä½¿ç”¨ <code>dictionary</code> ä¸­çš„ <code>key</code> æ¥æŒ‡æ˜å±æ€§ã€‚å®ƒé€šè¿‡è°ƒç”¨ <code>setValue:forKey:</code> æ–¹æ³•æ¥ä¸ºæ¯ä¸€å¯¹ <code>key-value</code> è¿›è¡Œè®¾ç½®ï¼Œè‡ªåŠ¨å°† <code>NSNull</code> å¯¹è±¡æ›¿æ¢ä¸º <code>nil</code> ã€‚</li>
</ul>
<p>åœ¨é»˜è®¤çš„å®ç°ä¸­ï¼Œå½“ä½ å°è¯•è®¾ç½®ä¸€ä¸ªéå¯¹è±¡çš„å±æ€§ä¸º <code>nil</code> æ—¶ï¼Œ <code>KVC</code> ä¼šè°ƒç”¨ <code>setNilValueForKey:</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°ä¼šæŠ›å‡ºä¸€ä¸ª <code>NSInvalidArgumentException</code> ï¼Œå¯¹è±¡å¯ä»¥é€šè¿‡é‡å†™è¿™ä¸ªè¡Œä¸ºæ¥æä¾›ä¸€ä¸ªé»˜è®¤å€¼æˆ–è€…æ ‡è®°å€¼ï¼ˆ marker value ï¼‰ã€‚</p>
<p><a href="https://kingcos.me/posts/2019/kvc_in_ios/">iOS ä¸­çš„ KVC</a></p>
<p>è¿™ç¯‡æ–‡ç« æœ‰æ›´è¯¦ç»†çš„è¯´æ˜</p>
<p><a href="https://juejin.im/post/6844903934662803464">iOS å¼€å‘ï¼šã€Crash é˜²æŠ¤ç³»ç»Ÿã€ï¼ˆä¸‰ï¼‰KVC é˜²æŠ¤</a></p>
<p><code>KVC</code> å´©æºƒé˜²æŠ¤ã€‚ä¸Šé¢æåˆ° <code>KVC</code> ç›¸å…³çš„å´©æºƒï¼Œè¿™ç¯‡æ–‡ç« ä¸­ç›¸å…³é˜²æŠ¤ä¹Ÿæ˜¯å¯¹è¿™äº›æ–¹æ³•è¿›è¡Œ <code>hook</code> ï¼Œæ›¿æ¢æ‰åŸæ¥çš„å®ç°ã€‚</p>
<pre><code class="language-objectivec">/********************* NSObject+KVCDefender.h æ–‡ä»¶ *********************/
#import &lt;Foundation/Foundation.h&gt;

@interface NSObject (KVCDefender)

@end

/********************* NSObject+KVCDefender.m æ–‡ä»¶ *********************/
#import &quot;NSObject+KVCDefender.h&quot;
#import &quot;NSObject+MethodSwizzling.h&quot;

@implementation NSObject (KVCDefender)

// ä¸å»ºè®®æ‹¦æˆª `setValue:forKey:` æ–¹æ³•
+ (void)load {
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{

        // æ‹¦æˆª `setValue:forKey:` æ–¹æ³•ï¼Œæ›¿æ¢è‡ªå®šä¹‰å®ç°
        [NSObject yscDefenderSwizzlingInstanceMethod:@selector(setValue:forKey:)
                                       withMethod:@selector(ysc_setValue:forKey:)
                                        withClass:[NSObject class]];

    });
}

- (void)ysc_setValue:(id)value forKey:(NSString *)key {
    if (key == nil) {
        NSString *crashMessages = [NSString stringWithFormat:@&quot;crashMessages : [&lt;%@ %p&gt; setNilValueForKey]: could not set nil as the value for the key %@.&quot;,NSStringFromClass([self class]),self,key];
        NSLog(@&quot;%@&quot;, crashMessages);
        return;
    }

    [self ysc_setValue:value forKey:key];
}

- (void)setNilValueForKey:(NSString *)key {
    NSString *crashMessages = [NSString stringWithFormat:@&quot;crashMessages : [&lt;%@ %p&gt; setNilValueForKey]: could not set nil as the value for the key %@.&quot;,NSStringFromClass([self class]),self,key];
    NSLog(@&quot;%@&quot;, crashMessages);
}

- (void)setValue:(id)value forUndefinedKey:(NSString *)key {
    NSString *crashMessages = [NSString stringWithFormat:@&quot;crashMessages : [&lt;%@ %p&gt; setValue:forUndefinedKey:]: this class is not key value coding-compliant for the key: %@,value:%@'&quot;,NSStringFromClass([self class]),self,key,value];
    NSLog(@&quot;%@&quot;, crashMessages);
}

- (nullable id)valueForUndefinedKey:(NSString *)key {
    NSString *crashMessages = [NSString stringWithFormat:@&quot;crashMessages :[&lt;%@ %p&gt; valueForUndefinedKey:]: this class is not key value coding-compliant for the key: %@&quot;,NSStringFromClass([self class]),self,key];
    NSLog(@&quot;%@&quot;, crashMessages);
    
    return self;
}

@end
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="autoreleasepool"><a class="header" href="#autoreleasepool">AutoreleasePool</a></h1>
<h2 id="autoreleasepool-è§£æ"><a class="header" href="#autoreleasepool-è§£æ">AutoreleasePool è§£æ</a></h2>
<p><a href="https://github.com/draveness/analyze/blob/master/contents/objc/%E8%87%AA%E5%8A%A8%E9%87%8A%E6%94%BE%E6%B1%A0%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F.md">draveness/analyze</a></p>
<p><a href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/">é»‘å¹•èƒŒåçš„Autorelease</a></p>
<p>æ•´ä¸ª iOS çš„å…¥å£éƒ½æ˜¯æ”¾åˆ° <code>@autoreleasepool</code> çš„ <code>block</code> ä¸­ï¼š</p>
<pre><code class="language-objectivec">int main(int argc, char * argv[]) {
    @autoreleasepool {
        return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));
    }
}
</code></pre>
<p>ç„¶åç¼–è¯‘å™¨ä¼šå°†å…¶æ”¹å†™æˆä¸‹é¢çš„ä»£ç ï¼š</p>
<pre><code class="language-objectivec">void *context = objc_autoreleasePoolPush();
// {}ä¸­çš„ä»£ç 
objc_autoreleasePoolPop(context);
</code></pre>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ‰‹åŠ¨è°ƒç”¨ <code>@autoreleasepool</code> æ¥åˆ›å»ºè‡ªå·±çš„è‡ªåŠ¨é‡Šæ”¾æ± ã€‚</p>
<p>RunLoop æ¯æ¬¡å¤„ç†äº‹ä»¶æ—¶ä¹Ÿä¼šåˆ›å»ºå’Œé‡Šæ”¾ <code>autoreleasepool</code> ã€‚App å¯åŠ¨åï¼Œä¼šåœ¨ä¸»çº¿ç¨‹çš„ RunLoop é‡Œæ³¨å†Œä¸¤ä¸ª <code>autoreleasepool</code> ç›¸å…³çš„ Observer ï¼Œå…¶å›è°ƒçš„æ–¹æ³•éƒ½æ˜¯ <code>_wrapRunLoopWithAutoreleasePoolHandler()</code> ã€‚</p>
<ol>
<li>ç¬¬ä¸€ä¸ª Observer ç›‘å¬çš„äº‹ä»¶æ˜¯ Entry ï¼Œå³å°†è¿›å…¥ Loop ï¼Œä¼šè°ƒç”¨ <code>_objc_autoreleasePoolPush()</code> æ¥åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œorder æ˜¯ -2147483647 ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œç¡®ä¿è‡ªåŠ¨é‡Šæ”¾æ± çš„åˆ›å»ºåœ¨å…¶å®ƒå›è°ƒä¹‹å‰ï¼›</li>
<li>ç¬¬äºŒä¸ª Observer ç›‘å¬äº† BeforeWaiting äº‹ä»¶ï¼Œå½“å¤„ç†å®Œäº‹ä»¶å³å°†è¿›å…¥ä¼‘çœ æ—¶è°ƒç”¨ï¼Œä¼šè°ƒç”¨ <code>_objc_autoreleasePoolPop()</code> æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œorder æ˜¯ 2147483647 ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œç¡®ä¿è‡ªåŠ¨é‡Šæ”¾æ± çš„é‡Šæ”¾åœ¨æ‰€æœ‰å›è°ƒä¹‹åï¼ŒåŒæ—¶ä¹Ÿä¼šè°ƒç”¨ <code>_objc_autoreleasePoolPush()</code> æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œä»¥ä¾›ä¸‹ä¸€æ¬¡å”¤é†’ä½¿ç”¨ï¼›</li>
</ol>
<pre><code class="language-objectivec">void *objc_autoreleasePoolPush(void) {
    return AutoreleasePoolPage::push();
}

void objc_autoreleasePoolPop(void *ctxt) {
    AutoreleasePoolPage::pop(ctxt);
}
</code></pre>
<p><code>AutoreleasePage</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code class="language-objectivec">class AutoreleasePoolPage {
    magic_t const magic;
    id *next;
    pthread_t const thread;
    AutoreleasePoolPage * const parent;
    AutoreleasePoolPage *child;
    uint32_t const depth;
    uint32_t hiwat;
};
</code></pre>
<p>è‡ªåŠ¨é‡Šæ”¾æ± æ˜¯ç”±ä¸€ç³»åˆ—çš„ <code>AutoreleasePoolPage</code> ç»„æˆï¼Œæ¯ä¸ª <code>AutoreleasePoolPage</code> çš„å¤§å°éƒ½æ˜¯ 4096 bit å¤§å°ã€‚</p>
<ul>
<li>è‡ªåŠ¨é‡Šæ”¾æ± æ˜¯ç”±Â <code>AutoreleasePoolPage</code>Â ä»¥åŒå‘é“¾è¡¨çš„æ–¹å¼å®ç°çš„</li>
<li>å½“å¯¹è±¡è°ƒç”¨Â <code>autorelease</code>Â æ–¹æ³•æ—¶ï¼Œä¼šå°†å¯¹è±¡åŠ å…¥Â <code>AutoreleasePoolPage</code>Â çš„æ ˆä¸­</li>
<li>è°ƒç”¨Â <code>AutoreleasePoolPage::pop</code>Â æ–¹æ³•ä¼šå‘æ ˆä¸­çš„å¯¹è±¡å‘é€Â <code>release</code>Â æ¶ˆæ¯</li>
</ul>
<p>å½“ä½¿ç”¨å®¹å™¨çš„ <code>block</code> æšä¸¾æ—¶ï¼Œå†…éƒ¨ä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ª <code>AutoreleasePool</code> ï¼š</p>
<pre><code class="language-objectivec">[array enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) {
    // è¿™é‡Œè¢«ä¸€ä¸ªå±€éƒ¨@autoreleasepoolåŒ…å›´ç€
}];
</code></pre>
<p>ä½†æ˜¯æ™®é€šçš„ for å¾ªç¯å’Œ for in å¾ªç¯ä¸­æ˜¯æ²¡æœ‰çš„ï¼Œæ‰€ä»¥å½“éå†ä¸­çš„ <code>autorelease</code> å˜é‡æ‰€å ç”¨çš„å†…å­˜è¾ƒå¤§æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ  <code>@autoreleasepool</code> ã€‚</p>
<h2 id="autoreleasepool-uses-in-swift"><a class="header" href="#autoreleasepool-uses-in-swift"><code>@autoreleasepool</code> uses in Swift</a></h2>
<p><a href="https://swiftrocks.com/autoreleasepool-in-2019-swift.html">@autoreleasepool uses in 2019 Swift</a></p>
<p>æœ¬æ–‡å…ˆæ˜¯ç®€å•çš„ä»‹ç»äº† <code>autoreleasepool</code> åœ¨ Objective-C ä¸­çš„ä½¿ç”¨åœºæ™¯â€”â€”åœ¨å¾ªç¯ä½“ä¸­å¤§é‡åˆ›å»º <code>autorelease</code> å¯¹è±¡ã€‚è€Œ ARC å¯¹ Swift çš„ä¼˜åŒ–åœ¨è¿‡å»å‡ å¹´ä¸­è¿›æ­¥äº†å¾ˆå¤šï¼Œæ ¹æ®ä½œè€…çš„æµ‹è¯•ï¼Œä¼¼ä¹ ARC for Swift ä»ä¸è°ƒç”¨ <code>autorelease</code> ï¼Œè€Œæ˜¯ç”¨å¤šæ¬¡è°ƒç”¨ <code>release</code> æ¥æ›¿ä»£ã€‚æ‰€ä»¥å¯¹äºçº¯ç²¹çš„ Swift å¯¹è±¡æˆ‘ä»¬å¯èƒ½ä¸å†éœ€è¦ <code>autoreleasepool</code> ã€‚ä½†åœ¨ Swift å¼€å‘ä¸­ <code>autoreleasepool</code> ä»ç„¶æœ‰ç”¨ï¼Œå› ä¸ºåœ¨ UIKit å’Œ Foundation ä¸­ä»ç„¶å­˜åœ¨è°ƒç”¨ <code>autorelease</code> çš„é—ç•™ <code>Objective-C</code> ç±»ã€‚åœ¨ Swift 5.2 ä¸Šæµ‹è¯•ç¡®å®å¦‚æ­¤ã€‚</p>
<p><a href="https://swifter.tips/autoreleasepool/">Swifter</a></p>
<p>å…¶å®å¯¹äºè¿™ä¸ªç‰¹å®šçš„ä¾‹å­ï¼Œæˆ‘ä»¬å¹¶ä¸ä¸€å®šéœ€è¦åŠ å…¥è‡ªåŠ¨é‡Šæ”¾ã€‚åœ¨ Swift ä¸­æ›´æå€¡çš„æ˜¯ç”¨åˆå§‹åŒ–æ–¹æ³•è€Œä¸æ˜¯ç”¨åƒä¸Šé¢é‚£æ ·çš„ç±»æ–¹æ³•æ¥ç”Ÿæˆå¯¹è±¡ï¼Œè€Œä¸”ä» Swift 1.1 å¼€å§‹ï¼Œå› ä¸ºåŠ å…¥äº†å¯ä»¥<a href="https://swifter.tips/init-nil/">è¿”å›Â <code>nil</code>Â çš„åˆå§‹åŒ–æ–¹æ³•</a>ï¼Œåƒä¸Šé¢ä¾‹å­ä¸­é‚£æ ·çš„å·¥å‚æ–¹æ³•éƒ½å·²ç»ä» API ä¸­åˆ é™¤äº†ã€‚ä»Šåæˆ‘ä»¬éƒ½åº”è¯¥è¿™æ ·å†™ï¼š</p>
<pre><code class="language-swift">let data = Data(contentsOfFile: path)
</code></pre>
<p>ä½¿ç”¨åˆå§‹åŒ–æ–¹æ³•çš„è¯ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦é¢ä¸´è‡ªåŠ¨é‡Šæ”¾çš„é—®é¢˜äº†ï¼Œæ¯æ¬¡åœ¨è¶…è¿‡ä½œç”¨åŸŸåï¼Œè‡ªåŠ¨å†…å­˜ç®¡ç†éƒ½å°†ä¸ºæˆ‘ä»¬å¤„ç†å¥½å†…å­˜ç›¸å…³çš„äº‹æƒ…ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dealloc"><a class="header" href="#dealloc">dealloc</a></h1>
<h2 id="llvm-å…³äº-dealloc-çš„è¯´æ˜"><a class="header" href="#llvm-å…³äº-dealloc-çš„è¯´æ˜">LLVM å…³äº <code>dealloc</code> çš„è¯´æ˜</a></h2>
<p><a href="http://clang.llvm.org/docs/AutomaticReferenceCounting.html#dealloc">Clang 12 documentation</a></p>
<blockquote>
<p>A class may provide a method definition for an instance method named dealloc. This method will be called after the final release of the object but before it is deallocated or any of its instance variables are destroyed. The superclassâ€™s implementation of dealloc will be called automatically when the method returns.</p>
</blockquote>
<p><code>dealloc</code> åœ¨æœ€å <code>release</code> æ—¶è°ƒç”¨ï¼Œä½†æ­¤æ—¶å®ä¾‹å˜é‡ï¼ˆ <code>Ivars</code> ï¼‰å¹¶æœªé‡Šæ”¾ï¼Œçˆ¶ç±»çš„  <code>dealloc</code> ä¼šåœ¨å­ç±»çš„ <code>dealloc</code> è¿”å›åè°ƒç”¨ã€‚</p>
<blockquote>
<p>The instance variables for an ARC-compiled class will be destroyed at some point after control enters the dealloc method for the root class of the class. The ordering of the destruction of instance variables is unspecified, both within a single class and between subclasses and superclasses.</p>
</blockquote>
<p>å®ä¾‹å˜é‡ä¼šåœ¨ <code>root class</code> ï¼ˆæ ¹ç±»ï¼‰çš„ <code>dealloc</code> ä¸­é‡Šæ”¾ï¼Œä¸€èˆ¬æ¥è¯´å°±æ˜¯ <code>NSObject</code> çš„ <code>dealloc</code> æ–¹æ³•ï¼Œé‡Šæ”¾é¡ºåºä¸ç¡®å®šã€‚</p>
<h3 id="dealloc-è°ƒç”¨æ—¶æœº"><a class="header" href="#dealloc-è°ƒç”¨æ—¶æœº">dealloc è°ƒç”¨æ—¶æœº</a></h3>
<p><a href="https://zhongwuzw.github.io/2017/09/21/%E8%81%8A%E8%81%8Adealloc/">èŠèŠdealloc</a></p>
<p>å½“å¯¹è±¡è°ƒç”¨ <code>release</code> æ–¹æ³•æ—¶ä¼šèµ°åˆ° <code>sidetable_release</code> è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œè€Œ <code>sidetable_release</code> è¿™ä¸ªæ–¹æ³•ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨ <code>dealloc</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-objectivec">uintptr_t objc_object::sidetable_release(bool performDealloc)
{
#if SUPPORT_NONPOINTER_ISA
    assert(!isa.nonpointer);
#endif
    // æ‰¾åˆ°å½“å‰å¯¹è±¡æ‰€å¯¹åº”çš„ SideTable
    SideTable&amp; table = SideTables()[this];
    bool do_dealloc = false;
    table.lock();
    // æ‰¾åˆ°å½“å‰å¯¹è±¡æ‰€å¯¹åº”çš„å¼•ç”¨è®¡æ•°
    RefcountMap::iterator it = table.refcnts.find(this);
    if (it == table.refcnts.end()) {
        // å¦‚æœæ‰¾ä¸åˆ°æ‰€å¯¹åº”çš„åº”ç”¨è®¡æ•°ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥æ‰§è¡Œ dealloc ï¼Œ
			  // åŒæ—¶è®¾ç½®å¯¹åº”çš„å€¼ä¸º SIDE_TABLE_DEALLOCATING
        do_dealloc = true;
        table.refcnts[this] = SIDE_TABLE_DEALLOCATING;
    } else if (it-&gt;second &lt; SIDE_TABLE_DEALLOCATING) {
        // SIDE_TABLE_WEAKLY_REFERENCED may be set. Don't change it.
        // å¦‚æœå¼•ç”¨è®¡æ•°å°äº SIDE_TABLE_DEALLOCATING ï¼Œåˆ™è¡¨ç¤ºå¼•ç”¨è®¡æ•°ä¸º 0 ï¼Œå¯ä»¥æ‰§è¡Œ dealloc
        do_dealloc = true;
        it-&gt;second |= SIDE_TABLE_DEALLOCATING;
    } else if (! (it-&gt;second &amp; SIDE_TABLE_RC_PINNED)) {
        // å¼•ç”¨è®¡æ•°å‡ 1
        it-&gt;second -= SIDE_TABLE_RC_ONE;
    }
    table.unlock();
    // è¿›è¡Œé‡Šæ”¾æ“ä½œï¼Œæ‰§è¡Œ dealloc
    if (do_dealloc  &amp;&amp;  performDealloc) {
        ((void(*)(objc_object *, SEL))objc_msgSend)(this, SEL_dealloc);
    }
    return do_dealloc;
}
</code></pre>
<p><code>dealloc</code> æœ‰å¯èƒ½åœ¨ä»»ä½•çº¿ç¨‹è°ƒç”¨ï¼Œåœ¨æœ€åä¸€ä¸ªè°ƒç”¨ <code>release</code> æ–¹æ³•çš„çº¿ç¨‹ä¸­è°ƒç”¨ã€‚</p>
<p>å‡½æ•°è°ƒç”¨é¡ºåºï¼š <code>dealloc-&gt;_objc_rootDealloc-&gt;objc_object::rootDealloc-&gt;object_dispose-&gt;objc_destructInstance</code> ï¼š</p>
<pre><code class="language-objectivec">- (void)dealloc {
    _objc_rootDealloc(self);
}
</code></pre>
<pre><code class="language-objectivec">void _objc_rootDealloc(id obj)
{
    assert(obj);

    obj-&gt;rootDealloc();
}
</code></pre>
<pre><code class="language-objectivec">inline void
objc_object::rootDealloc()
{
    if (isTaggedPointer()) return;  // fixme necessary?
		// åˆ¤æ–­ isa çš„å„ä¸ªæ ‡å¿—ä½ï¼Œç¡®è®¤æ˜¯å¦éœ€è¦è¿›è¡Œå¿«é€Ÿé‡Šæ”¾ã€‚
    if (fastpath(isa.nonpointer  &amp;&amp;  
                 !isa.weakly_referenced  &amp;&amp;  
                 !isa.has_assoc  &amp;&amp;  
                 !isa.has_cxx_dtor  &amp;&amp;  
                 !isa.has_sidetable_rc))
    {
        assert(!sidetable_present());
        free(this);
    } 
    else {
        object_dispose((id)this);
    }
}
</code></pre>
<pre><code class="language-objectivec">id object_dispose(id obj)
{
    if (!obj) return nil;

    objc_destructInstance(obj);    
    free(obj);

    return nil;
}
</code></pre>
<pre><code class="language-objectivec">void *objc_destructInstance(id obj)
{
    if (obj) {
        Class isa_gen = _object_getClass(obj);
        class_t *isa = newcls(isa_gen);

        // Read all of the flags at once for performance.
        bool cxx = hasCxxStructors(isa);
        bool assoc = !UseGC &amp;&amp; _class_instancesHaveAssociatedObjects(isa_gen);

        // This order is important.
        if (cxx) object_cxxDestruct(obj); // 1
        if (assoc) _object_remove_assocations(obj); // 2

        if (!UseGC) objc_clear_deallocating(obj); // 3
    }

    return obj;
}
</code></pre>
<ol>
<li><code>object_cxxDestruct</code> è°ƒç”¨ C++ ææ„å™¨ï¼Œé‡Šæ”¾å®ä¾‹å˜é‡ï¼›</li>
<li><code>_object_remove_assocations</code> æ¸…é™¤ <code>Associated</code> å¯¹è±¡ï¼›</li>
<li><code>objc_clear_deallocating</code> ARC ç›¸å…³æ“ä½œï¼Œæ¸…ç† <code>SideTable</code> ï¼Œ <code>weak</code> è®¾ç½®ä¸º <code>nil</code> ç­‰ã€‚</li>
</ol>
<h2 id="arc-ä¸‹-dealloc-è¿‡ç¨‹åŠ-cxx_destruct-çš„æ¢ç©¶"><a class="header" href="#arc-ä¸‹-dealloc-è¿‡ç¨‹åŠ-cxx_destruct-çš„æ¢ç©¶">ARC ä¸‹ <code>dealloc</code> è¿‡ç¨‹åŠ <code>.cxx_destruct</code> çš„æ¢ç©¶</a></h2>
<p><a href="http://blog.sunnyxx.com/2014/04/02/objc_dig_arc_dealloc/">ARCä¸‹deallocè¿‡ç¨‹åŠ.cxx_destructçš„æ¢ç©¶</a></p>
<p>è¿™ç¯‡æ–‡ç« å¯¹ <code>.cxx_destruct</code> åšäº†æ·±å…¥ç ”ç©¶ï¼ŒåŒ…æ‹¬ <code>.cxx_destruct</code> å¦‚ä½•é‡Šæ”¾å®ä¾‹å˜é‡ï¼Œå¦‚ä½•è°ƒç”¨ <code>[super dealloc]</code> ã€‚è¿™ä¸¤è€…éƒ½æ˜¯ç”±ç¼–è¯‘å™¨å¸®æˆ‘ä»¬å®Œæˆï¼Œæ’å…¥è¿™éƒ¨åˆ†çš„ä»£ç ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tagged-pointer"><a class="header" href="#tagged-pointer">Tagged Pointer</a></h1>
<h2 id="è¯´æ˜"><a class="header" href="#è¯´æ˜">è¯´æ˜</a></h2>
<p><a href="https://en.wikipedia.org/wiki/Tagged_pointer">Tagged pointer</a></p>
<p>å¯¹è±¡å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ—¶å€™æ€»æ˜¯å†…å­˜å¯¹é½çš„ï¼Œæ‰€ä»¥å®ƒä»¬çš„åœ°å€ä¼šæ˜¯å•ä¸ªæŒ‡é’ˆå¤§å°çš„å€æ•°ï¼Œé€šå¸¸æ¥è¯´ä¼šæ˜¯ 16 çš„å€æ•°ã€‚åœ¨ 64 ä½ç³»ç»Ÿä¸­ï¼Œå¯¹è±¡çš„æŒ‡é’ˆä¸º 64 ä½æ•´å½¢ã€‚åé¢å‡ ä½ä¸º 0 ã€‚ç”±äºåé¢å‡ ä½ä¸€ç›´ä¸º 0 ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åé¢å‡ ä½æ¥è®°å½•ä¸€äº›äº‹æƒ…ã€‚</p>
<p><a href="https://developer.apple.com/videos/play/wwdc2013/404/">Advances in Objective-C - WWDC 2013 - Videos - Apple Developer</a></p>
<p>WWDC 2013 ä¸Šç›¸å…³ä»‹ç»ï¼Œä» 36:49 å¼€å§‹ã€‚</p>
<p><img src="programming-languages/Objective-C/media/16295382272652.jpg" alt="" /></p>
<ul>
<li>è‹¹æœä½¿ç”¨ Tagged Pointer æ¥å­˜å‚¨ä¸€äº›æ¯”è¾ƒå°çš„æ•°æ®ï¼Œå¦‚ï¼š <code>NSNumber</code> ï¼Œ <code>NSDate</code> å’Œ <code>NSString</code> ç­‰ï¼›</li>
<li>ç”±äºç›´æ¥ä½¿ç”¨æŒ‡é’ˆæœ¬èº«æ¥å­˜å‚¨æ•°æ®ï¼Œä¸å†éœ€è¦é¢å¤–ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæ²¡æœ‰ <code>malloc/free</code> ï¼›</li>
<li>3 å€çš„ç©ºé—´ä¼˜åŒ–ï¼Œ 106 å€çš„åˆ›å»ºæˆ–è€…é”€æ¯é€Ÿåº¦ã€‚</li>
</ul>
<p><img src="programming-languages/Objective-C/media/16295384569038.jpg" alt="" /></p>
<p>ä½¿ç”¨ä½ä½çš„ <code>bit</code> æ¥ä½œä¸ºæ ‡è¯†ä½ã€‚</p>
<h2 id="tagged-pointer-è§£æ"><a class="header" href="#tagged-pointer-è§£æ">Tagged Pointer è§£æ</a></h2>
<p><a href="https://wenghengcong.com/posts/b6becb26/">å†…å­˜ç®¡ç†ï¼ˆäºŒï¼‰Tagged Pointer</a></p>
<p><a href="https://juejin.cn/post/6844904132940136462">iOS - è€ç”Ÿå¸¸è°ˆå†…å­˜ç®¡ç†ï¼ˆäº”ï¼‰ï¼šTagged Pointer</a></p>
<p>ç”±äºå†…å­˜å¯¹é½çš„å…³ç³»ï¼ŒæŒ‡é’ˆçš„å€¼æœ€åå››ä½éƒ½æ˜¯ 0 ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨è¿™å››ä½æ¥åšä¸€äº›è®°å½•ã€‚å¦‚æœæœ€åä¸€ä½æ˜¯ 1 ï¼Œåˆ™è¿™ä¸ªæŒ‡é’ˆæ˜¯ Tagged Pointer ã€‚</p>
<pre><code class="language-objectivec">static inline bool 
_objc_isTaggedPointer(const void *ptr) 
{
    return ((intptr_t)ptr &amp; _OBJC_TAG_MASK) == _OBJC_TAG_MASK;
}

#if OBJC_MSB_TAGGED_POINTERS
#   define _OBJC_TAG_MASK (1ULL&lt;&lt;63)
#else
#   define _OBJC_TAG_MASK 1
#endif

#if TARGET_OS_OSX &amp;&amp; __x86_64__
    // 64-bit Mac - tag bit is LSB
#   define OBJC_MSB_TAGGED_POINTERS 0
#else
    // Everything else - tag bit is MSB
#   define OBJC_MSB_TAGGED_POINTERS 1
#endif
</code></pre>
<p>åœ¨ iOS å¹³å°ä¸Šä½¿ç”¨çš„æ˜¯æœ€é«˜ä½è¿›è¡Œåˆ¤æ–­ï¼Œåœ¨ macOS ä¸Š ä½¿ç”¨çš„æ˜¯æœ€ä½ä½ã€‚ Tagged Pointer æ”¯æŒçš„ç±»å‹ï¼š</p>
<pre><code class="language-objectivec">enum
{
    OBJC_TAG_NSAtom            = 0, 
    OBJC_TAG_1                 = 1, 
    OBJC_TAG_NSString          = 2, 
    OBJC_TAG_NSNumber          = 3, 
    OBJC_TAG_NSIndexPath       = 4, 
    OBJC_TAG_NSManagedObjectID = 5, 
    OBJC_TAG_NSDate            = 6, 
    OBJC_TAG_RESERVED_7        = 7, 

    OBJC_TAG_First60BitPayload = 0, 
    OBJC_TAG_Last60BitPayload  = 6, 
    OBJC_TAG_First52BitPayload = 8, 
    OBJC_TAG_Last52BitPayload  = 263, 

    OBJC_TAG_RESERVED_264      = 264
};
</code></pre>
<p>Tagged Pointer ä¸æ˜¯çœŸçš„å¯¹è±¡ï¼Œæ²¡æœ‰ isa æŒ‡é’ˆï¼Œä¸å­˜åœ¨ <code>retain</code> ï¼Œ <code>release</code> ï¼Œ <code>autorelease</code> ç­‰å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„æµç¨‹ï¼Œå…¶å¼•ç”¨è®¡æ•°ä¸º <code>NSUInteger</code> çš„æœ€å¤§å€¼ã€‚</p>
<pre><code class="language-objectivec">dispatch_queue_t queue = dispatch_queue_create(&quot;parallel&quot;, DISPATCH_QUEUE_CONCURRENT);
for (int i = 0; i &lt; 1000; i ++) {
    dispatch_async(queue, ^{
        self.name = [NSString stringWithFormat:@&quot;abcdefghijk&quot;];
    })
}
dispatch_queue_t queue = dispatch_queue_create(&quot;parallel&quot;, DISPATCH_QUEUE_CONCURRENT);
for (int i = 0; i &lt; 1000; i ++) {
    dispatch_async(queue, ^{
        self.name = [NSString stringWithFormat:@&quot;abc&quot;];
    })
}
</code></pre>
<p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œç¬¬ä¸€ä¸ª for å¾ªç¯ä¼šå´©æºƒï¼Œå› ä¸ºåœ¨å¤šçº¿ç¨‹ä¸­å¯èƒ½ä¼šé‡å¤ <code>release</code> ï¼Œè€Œç¬¬äºŒä¸ªä¸ä¼šï¼Œå› ä¸º Tagged Pointer å…¶å®æ˜¯å€¼ç±»å‹ï¼Œä¸æ¶‰åŠåˆ° <code>retain</code> å’Œ <code>release</code> æ“ä½œï¼Œå…¶èµ‹å€¼æ“ä½œæ˜¯åŸå­æ€§çš„ã€‚</p>
<h2 id="lets-build-tagged-pointers"><a class="header" href="#lets-build-tagged-pointers">Let's Build Tagged Pointers</a></h2>
<p><a href="https://www.mikeash.com/pyblog/friday-qa-2012-07-27-lets-build-tagged-pointers.html">mikeash.com: Friday Q&amp;A 2012-07-27: Let's Build Tagged Pointers</a></p>
<p>Mike Ash å°è¯•è‡ªå·±å®ç°äº†ä¸€ä¸ª Tagged Pointer ã€‚</p>
<h2 id="tagged-pointer-strings"><a class="header" href="#tagged-pointer-strings">Tagged Pointer Strings</a></h2>
<p><a href="https://mikeash.com/pyblog/friday-qa-2015-07-31-tagged-pointer-strings.html">mikeash.com: Friday Q&amp;A 2015-07-31: Tagged Pointer Strings</a></p>
<p><a href="https://swift.gg/2018/10/08/tagged-pointer-strings/">Tagged Pointer å­—ç¬¦ä¸²</a></p>
<p>å¦‚æœæŸäº›å­—ç¬¦ä¸²å¯ä»¥ä¿å­˜ä¸º 60 ä½ä»¥å†…çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œé‚£ä¹ˆå¯¹åº”çš„ <code>NSString</code> å°±ä¼šè¢«åˆ›å»ºä¸º Tagged Pointer ã€‚</p>
<p>ç”±äº <code>NSString</code> å­—ç¬¦ä¸²ç¼–ç çš„ç‰¹æ®Šæ€§ï¼Œè‹¹æœé’ˆå¯¹ <code>NSString</code> çš„ Tagged Pointer è¿›è¡Œä¼˜åŒ–ã€‚</p>
<h3 id="å®ç°"><a class="header" href="#å®ç°">å®ç°</a></h3>
<pre><code class="language-objectivec">NSString *a = @&quot;a&quot;;
NSString *b = [[a mutableCopy] copy];
NSLog(@&quot;%p %p %@&quot;, a, b, object_getClass(b));
</code></pre>
<ol>
<li>å¸¸é‡å­—ç¬¦ä¸²ä¸ä¼šè¢«å­˜å‚¨ä¸º Tagged Pointer ï¼Œå› ä¸ºå¸¸é‡å­—ç¬¦ä¸²å¿…é¡»ä¿è¯å¯ä»¥å…¼å®¹ä¸åŒçš„ç³»ç»Ÿï¼Œä½†æ˜¯ Tagged Pointer çš„å†…éƒ¨å®ç°ç»†èŠ‚å´ä¸èƒ½ä¿è¯å…¼å®¹ä¸åŒçš„ç³»ç»Ÿï¼Œå¸¸é‡å­—ç¬¦ä¸²åµŒå…¥åˆ°äºŒè¿›åˆ¶å­—ç¬¦ä¸²æ—¶æœ‰å¯èƒ½ä¼šå´©æºƒï¼›</li>
<li>å…ˆæ‰§è¡Œ <code>[a mutableCopy]</code> ï¼Œå›  <code>copy</code> è¿”å›çš„æ˜¯ä¸å¯å˜çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å¸¸é‡å­—ç¬¦ä¸²çš„ <code>copy</code> å¾—åˆ°çš„è¿˜æ˜¯åŸæ¥çš„å¸¸é‡å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å…ˆé€šè¿‡ <code>mutableCopy</code> ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯å˜å­—ç¬¦ä¸²ï¼Œç„¶åå†é€šè¿‡ <code>copy</code> å¾—åˆ°ä¸€ä¸ªä¸å¯å˜çš„ Tagged Pointer ï¼Œ Tagged Pointer åªä¼šåœ¨è¿è¡Œæ—¶åˆ›å»ºã€‚</li>
</ol>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-objectivec">0x10ba41038 0x6115 NSTaggedPointerString
</code></pre>
<p>é¦–å…ˆç¬¬ä¸€ä¸ª <code>a</code> ä¸æ˜¯ Tagged Pointer ï¼Œæ˜¯ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªæ˜¯ Tagged Pointerã€‚</p>
<p>ç„¶å <code>NSString</code> å¯¹åº”çš„ Tagged Pointer ä½¿ç”¨çš„æ˜¯ ASCII ç¼–ç ï¼Œå ç”¨çš„é•¿åº¦è¾ƒå°‘ã€‚</p>
<p>ä¼ªä»£ç ï¼š</p>
<pre><code class="language-objectivec">unsigned short -[NSTaggedPointerString characterAtIndex:](void * self, void * _cmd, unsigned long long index) {
     int8_t buffer[11];
     length = self &gt;&gt; 0x4 &amp; 0xf;
     if (length &gt;= 0x8) {
         stringData = self &gt;&gt; 0x8;
         table = &quot;eilotrm.apdnsIc ufkMShjTRxgC4013bDNvwyUL2O856P-B79AFKEWV_zGJ/HYX&quot;;
             cursor = length;
             if (length &lt; 0xa) {
                 do {
                     buffer[cursor - 1] = table[stringData &amp; 0x3f];
                     cursor = cursor - 0x1;
                     stringData = stringData &gt;&gt; 0x6;
                 } while (cursor != 0x0);
             }
             else {
                 do {
                     buffer[cursor - 1] = table[stringData &amp; 0x1f];
                     cursor = cursor - 0x1;
                     stringData = stringData &gt;&gt; 0x5;
                 } while (cursor != 0x0);
             }
     } else {
         *(uint64_t *)buffer = self &gt;&gt; 8;
     }
     if (length &lt;= index) {
         rbx = r8;
         ___CFExceptionProem(self, _cmd);
         [NSException raise:@&quot;NSRangeException&quot; format:@&quot;%@: Index %lu out of bounds; string length %lu&quot;];
         r8 = rbx;
     }
     rax = buffer[index];
     return rax;
 }
</code></pre>
<ol>
<li>é•¿åº¦å°äº 8 çš„æƒ…å†µä¸‹ï¼Œç›´æ¥ä½¿ç”¨ ASCII ç¼–ç ï¼Œæ‰€ä»¥ <code>self</code> æŒ‰ä½ç¼–è¯‘åç›´æ¥èµ‹å€¼ç»™ <code>buff</code> å³å¯ï¼›</li>
<li>é•¿åº¦å¤§äºç­‰äº8å°äº10ï¼Œå°±ä¼šå–å‡º <code>stringData</code> çš„æœ€ä½ 6 ä½ï¼Œä½œä¸º <code>table</code> çš„ç´¢å¼•å–å‡ºç›¸åº”çš„å€¼æ‹·è´åˆ° <code>buffer</code> ä¸­ï¼Œç„¶åå°† <code>stringData</code> å³ç§» 6 ä½ï¼Œé‡å¤æ“ä½œï¼›</li>
<li>å¦‚æœå¤§äºç­‰äº 10 ï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨ 5 ä½ç¼–ç ï¼Œè€Œ <code>table</code> åªä½¿ç”¨å‰åŠéƒ¨åˆ†ã€‚</li>
</ol>
<p>æ„é€  <code>NSString</code> Tagged Pointer çš„åŸç†å¤§è‡´ä¸Šä¹Ÿå’Œä¸Šé¢çš„ä¸€è‡´ã€‚</p>
<p>6 ä½ç¼–ç è¡¨ï¼š</p>
<pre><code>eilotrm.apdnsIc ufkMShjTRxgC4013bDNvwyUL2O856P-B79AFKEWV_zGJ/HYX
</code></pre>
<p>çŒœæµ‹æ˜¯æŒ‰ç…§åœ¨è‹±è¯­ä¸­å‡ºç°çš„é¢‘ç‡è¿›è¡Œæ’åºï¼Œä½¿å¾—å°½é‡å¤šçš„å­—ç¬¦ä¸²å¯ä»¥ä½¿ç”¨ Tagged Pointer ã€‚é€šè¿‡ä¸€ä¸ªç®€å•åˆå·§å¦™çš„æŸ¥æ‰¾è¡¨æ–¹å¼åœ¨æœ‰é™çš„ç©ºé—´å†…å­˜å‚¨å°½é‡çš„æ•°æ®ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="weak"><a class="header" href="#weak">weak</a></h1>
<h2 id="å®ç°-1"><a class="header" href="#å®ç°-1">å®ç°</a></h2>
<p><a href="https://triplecc.github.io/2019/03/20/objective-c-weak-implement/">Objective-C weak å¼±å¼•ç”¨å®ç°</a></p>
<p>ä½œè€…åœ¨æ–‡ä¸­æä¾›äº†ä¸€ä¸ªç®€å•ç‰ˆçš„ <code>weak</code> å®ç°ï¼š</p>
<pre><code class="language-objectivec">// { å¯¹è±¡åœ°å€ : [ å¯¹è±¡æŒ‡é’ˆåœ°å€1ã€ å¯¹è±¡æŒ‡é’ˆåœ°å€1] }
static NSMutableDictionary *weakTable;
@interface A : NSObject
@end
@implementation A
- (void)dealloc {
    // è·å–æŒ‡å‘æ­¤å¯¹è±¡çš„æ‰€æœ‰æŒ‡é’ˆå˜é‡åœ°å€
    for (NSNumber *ptrPtrNumber in weakTable[@((uintptr_t)self)]) {
        // æ ¹æ®æŒ‡é’ˆå˜é‡åœ°å€ï¼Œå°†æŒ‡é’ˆå˜é‡ç½®ä¸º nil
        // è¿™é‡Œå°±æ˜¯ w1 ç½® nil
        uintptr_t **ptrPtr = (uintptr_t **)[ptrPtrNumber unsignedLongValue];
        *ptrPtr = nil;
    }
    // ç§»é™¤å’Œæ­¤å¯¹è±¡ç›¸å…³çš„æ•°æ®
    [weakTable removeObjectForKey:@((uintptr_t)self)];
}
@end
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        weakTable = @{}.mutableCopy;
        __unsafe_unretained NSObject *w1;
        @autoreleasepool {
            NSObject *obj = [A new];
            uintptr_t objAddr = (uintptr_t)obj;

            w1 = obj;
            // å°†å¯¹è±¡åœ°å€å’Œéœ€è¦è‡ªåŠ¨ç½® nil çš„æŒ‡é’ˆå˜é‡çš„åœ°å€ä¿å­˜è‡³ map ä¸­
            // ä½¿ç”¨å¯å˜æ•°ç»„æ–¹ä¾¿å¤„ç†å¤šä¸ªéœ€è¦ç½® nil çš„å˜é‡æŒ‡å‘ obj
            weakTable[@(objAddr)] = @[@((uintptr_t)&amp;w1)].mutableCopy;
            // å³å°†èµ°å‡º w1 æ‰€åœ¨ä½œç”¨åŸŸï¼Œå°† w1 çš„åœ°å€ä» map ä¸­æ¸…é™¤
            [weakTable[@((uintptr_t)w1)] removeObject:@((uintptr_t)&amp;w1)];
        }
        NSLog(@&quot;%@&quot;, w1);
    }
    return 0;
}

</code></pre>
<p>ç³»ç»Ÿçš„ <code>weak</code> å®ç°æ€»ç»“å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>è®¾ç½® <code>__weak</code> ä¿®é¥°çš„å˜é‡æ—¶ï¼Œ runtime ä¼šç”Ÿæˆå¯¹åº”çš„ <code>entry</code> ç»“æ„æ”¾å…¥ <code>weak hash table</code> ä¸­ï¼Œä»¥èµ‹å€¼å¯¹è±¡åœ°å€ç”Ÿæˆçš„ <code>hash</code> å€¼ä¸º <code>key</code> ï¼Œä»¥åŒ…è£… <code>__weak</code> ä¿®é¥°çš„æŒ‡é’ˆå˜é‡åœ°å€çš„ <code>entry</code> ä¸º <code>value</code> ï¼Œå½“èµ‹å€¼å¯¹è±¡é‡Šæ”¾æ—¶ï¼Œ runtime ä¼šåœ¨ç›®æ ‡å¯¹è±¡çš„ <code>dealloc</code> å¤„ç†è¿‡ç¨‹ä¸­ï¼Œä»¥å¯¹è±¡åœ°å€ï¼ˆ <code>self</code> ï¼‰ä¸º <code>key</code> å» <code>weak hash table</code> æŸ¥æ‰¾ <code>entry</code> ï¼Œç½®ç©º <code>entry</code> æŒ‡å‘çš„çš„æ‰€æœ‰å¯¹è±¡æŒ‡é’ˆã€‚
å®é™…ä¸Š <code>entry</code> ä½¿ç”¨æ•°ç»„ä¿å­˜æŒ‡é’ˆå˜é‡åœ°å€ï¼Œå½“åœ°å€æ•°é‡ä¸å¤§äº 4 æ—¶ï¼Œè¿™ä¸ªæ•°ç»„å°±æ˜¯ä¸ªæ™®é€šçš„å†…ç½®æ•°ç»„ï¼Œåœ¨åœ°å€æ•°é‡å¤§äº 4 æ—¶ï¼Œè¿™ä¸ªæ•°ç»„å°±ä¼šæ‰©å……æˆä¸€ä¸ª <code>hash table</code> ã€‚
ç³»ç»Ÿä¼šæä¾›ä¸€ä¸ª <code>SideTable</code> æ¥å…³è”å¯¹è±¡å¼•ç”¨å’Œå¼±å¼•ç”¨è¡¨ï¼Œå¯¹äºä¸€ä¸ªå¯¹è±¡æ¥è¯´è¿™ä¸ªç»“æ„å®ä¾‹æ˜¯å”¯ä¸€çš„ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œobjc 2.0 çš„å¯¹è±¡å¼•ç”¨è®¡æ•°éƒ½ä¼šä¼˜å…ˆä¿å­˜åœ¨ <code>isa</code> çš„ <code>extra_rc</code> ä½æ®µä¸­ï¼Œåªæœ‰è¶…å‡ºäº†å­˜å‚¨çš„é™åˆ¶æ‰ä¼šå°†è¶…å‡ºéƒ¨åˆ†ä¿å­˜åˆ°å¯¹åº”çš„ <code>SideTable</code> ä¸­ï¼Œ <code>isa</code> ä½¿ç”¨ <code>has_sidetable_rc</code> æ ‡è®°æ˜¯å¦è¶…å‡ºé™åˆ¶ã€‚
ç³»ç»Ÿçš„å®ç°éœ€è¦é’ˆå¯¹ <code>TaggedPointer</code> è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚
<code>weak_entry_t</code> ä½¿ç”¨ <code>union</code> æ¥è¿›è¡Œè®°å½•ï¼Œåœ¨ <code>wea</code> æŒ‡é’ˆæ•°é‡å°äº 4 ä¸ªæ—¶å¯ä»¥å¿«é€Ÿè®¿é—®ã€‚</p>
</blockquote>
<p>æ–‡ç« ä¸ç®—å¾ˆé•¿ï¼Œä½†æ˜¯æŠŠåˆ›å»ºå’Œé”€æ¯æµç¨‹è®²å¾—éå¸¸æ¸…æ™°ã€‚ä¸»è¦é‡ç‚¹åœ¨ <code>weak_entry_t</code> çš„å¤„ç†ï¼Œ <code>hash</code> çš„è®¡ç®—ã€‚</p>
<h2 id="weak-å¼±å¼•ç”¨çš„å®ç°æ–¹å¼"><a class="header" href="#weak-å¼±å¼•ç”¨çš„å®ç°æ–¹å¼">weak å¼±å¼•ç”¨çš„å®ç°æ–¹å¼</a></h2>
<p><a href="https://www.desgard.com/objective-c/2016/09/10/weak.html">weak å¼±å¼•ç”¨çš„å®ç°æ–¹å¼</a></p>
<p>æ•´ä½“æµç¨‹è¯´å¾—æ¯”è¾ƒæ¸…æ™°ï¼Œä»£ç æ³¨é‡Šå’Œè§£é‡Šä¹Ÿæ¯”è¾ƒè¯¦ç»†</p>
<p><img src="programming-languages/Objective-C/media/16295391694403.jpg" alt="" /></p>
<h2 id="å¼•ç”¨è®¡æ•°ä¸-weak"><a class="header" href="#å¼•ç”¨è®¡æ•°ä¸-weak">å¼•ç”¨è®¡æ•°ä¸ weak</a></h2>
<p><a href="https://wenghengcong.com/posts/7162dd05/">å†…å­˜ç®¡ç†ï¼ˆå››ï¼‰å¼•ç”¨è®¡æ•°ä¸weak</a></p>
<p><img src="programming-languages/Objective-C/media/16295391908761.jpg" alt="" /></p>
<p><img src="programming-languages/Objective-C/media/16295392026961.jpg" alt="" /></p>
<h2 id="åº”ç”¨-1"><a class="header" href="#åº”ç”¨-1">åº”ç”¨</a></h2>
<p><a href="https://zhuanlan.zhihu.com/p/27832890">iOS weak å…³é”®å­—æ¼«è°ˆ</a></p>
<p><code>weak singleton</code> ï¼Œå½“æ‰€æœ‰æŒæœ‰å•ä¾‹çš„å¯¹è±¡éƒ½é‡Šæ”¾åï¼Œå•ä¾‹ä¹Ÿä¼šè¢«é‡Šæ”¾æ‰ï¼Œå‡å°‘å†…å­˜æµªè´¹ï¼š</p>
<pre><code class="language-objectivec">- (void)setContext:(CDDContext*)object {
    id __weak weakObject = object;
    id (^block)() = ^{ return weakObject; };
    objc_setAssociatedObject(self, @selector(context), block, OBJC_ASSOCIATION_COPY);
}

- (CDDContext*)context {
    id (^block)() = objc_getAssociatedObject(self, @selector(context));
    id curContext = (block ? block() : nil);
    return curContext;
}
</code></pre>
<p><code>weak associated object</code> ï¼Œ<code>associated object</code> æœ¬èº«å¹¶ä¸æ”¯æŒæ·»åŠ å…·å¤‡ <code>weak</code> ç‰¹æ€§çš„ <code>property</code> ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªå°æŠ€å·§æ¥å®Œæˆï¼š</p>
<pre><code class="language-objectivec">- (void)setContext:(CDDContext*)object {
    id __weak weakObject = object;
    id (^block)() = ^{ return weakObject; };
    objc_setAssociatedObject(self, @selector(context), block, OBJC_ASSOCIATION_COPY);
}

- (CDDContext*)context {
    id (^block)() = objc_getAssociatedObject(self, @selector(context));
    id curContext = (block ? block() : nil);
    return curContext;
}
</code></pre>
<p>æ–‡ç« æœ€åä¸€æ®µè¯å†™å¾—å¾ˆå¥½ï¼š</p>
<blockquote>
<p>ç¼–ç¨‹è¯­è¨€ä¸€ç›´å¤„äºè¿›åŒ–å½“ä¸­ï¼Œè¯­è¨€çš„è®¾è®¡è€…ä¼šç«™åœ¨å®è§‚çš„è§’åº¦ï¼Œç»“åˆè¡Œä¸šçš„éœ€è¦ï¼Œæ·»åŠ æ›´å¤šçš„æ–¹ä¾¿ç‰¹æ€§ï¼Œå¦‚æœåªæ˜¯è®°ä½å®˜æ–¹æ–‡æ¡£é‡Œçš„å‡ ä¸ªåº”ç”¨åœºæ™¯ï¼Œè€Œä¸å»æ€è€ƒèƒŒåçš„è®¾è®¡æ€è·¯ï¼Œåˆ™å¾ˆéš¾å†™å‡ºæœ‰æƒ³è±¡åŠ›çš„ä»£ç ã€‚</p>
</blockquote>
<h2 id="ç®€æ˜“ç‰ˆå®ç°"><a class="header" href="#ç®€æ˜“ç‰ˆå®ç°">ç®€æ˜“ç‰ˆå®ç°</a></h2>
<p><a href="http://samwei12.com/2016/03/09/Objective-C/%E5%A6%82%E4%BD%95%E6%A8%A1%E6%8B%9Fruntime%E4%B8%ADweak%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%9F/">å¦‚ä½•å®ç°ARCä¸­weakåŠŸèƒ½ï¼Ÿ</a></p>
<p><code>weak</code> çš„ç®€æ˜“ç‰ˆå®ç°ã€‚å€Ÿç”¨ <code>block</code> å’Œ <code>unsafe_unretained</code> å®ç° <code>weak</code> ï¼Œåœ¨å¯¹è±¡ <code>dealloc</code> æ—¶è°ƒç”¨ <code>block</code> ï¼Œè€Œ <code>block</code> ä¼šå°† <code>unsafe_unretained</code> æŒ‡é’ˆæŒ‡å‘ <code>nil</code> ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="object"><a class="header" href="#object">Object</a></h1>
<h2 id="objective-c-ä¸­çš„å¯¹è±¡"><a class="header" href="#objective-c-ä¸­çš„å¯¹è±¡">Objective-C ä¸­çš„å¯¹è±¡</a></h2>
<p><a href="https://kingcos.me//posts/2019/objects_in_obj-c/">Obj-C ä¸­çš„å¯¹è±¡</a></p>
<p><img src="https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ae81bfb2-aecc-49ba-97d3-44117f694791/Untitled.png" alt="https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ae81bfb2-aecc-49ba-97d3-44117f694791/Untitled.png" /></p>
<p><code>NSObject</code> å®šäº† <code>isa</code> æŒ‡é’ˆï¼Œç”¨äºæŒ‡å‘ <code>Class</code> ï¼Œè€Œ <code>Class</code> æœ¬è´¨ä¸Šåˆ™æ˜¯æŒ‡å‘ <code>objc_class</code> ç»“æ„ä½“çš„æŒ‡é’ˆï¼š</p>
<pre><code class="language-objectivec">// NSObject.h

@interface NSObject &lt;NSObject&gt; {
#pragma clang diagnostic push
#pragma clang diagnostic ignored &quot;-Wobjc-interface-ivars&quot;
    Class isa  OBJC_ISA_AVAILABILITY;
#pragma clang diagnostic pop
}
</code></pre>
<p>è€Œ <code>Class</code> çš„æœ¬è´¨åˆ™æ˜¯æŒ‡å‘ <code>objc_class</code> ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œå­˜æ”¾äº† <code>isa</code> ã€ <code>superclass</code> ã€æ–¹æ³•ç¼“å­˜ç­‰ã€‚</p>
<pre><code class="language-c">typedef struct objc_class *Class;

// objc-runtime-new.h
struct objc_class : objc_object {
    // Class ISA;
    // çˆ¶ç±»æŒ‡é’ˆ
    Class superclass;
    // æ–¹æ³•ç¼“å­˜
    cache_t cache;             // formerly cache pointer and vtable
    // å¯è¯»å¯å†™è¡¨ï¼ˆclass_rw_tï¼‰ç­‰
    class_data_bits_t bits;    // class_rw_t * plus custom rr/alloc flags

    // ...
};

// objc-private.h
struct objc_object {
private:
    // isa æŒ‡é’ˆ
    isa_t isa;

// ...
}

struct class_data_bits_t {
    // Values are the FAST_ flags above.
    uintptr_t bits;

    class_rw_t* data() {
        return (class_rw_t *)(bits &amp; FAST_DATA_MASK);
    }

    // ...
}
</code></pre>
<p><code>bits</code> æ ‡å¿—ä½ä½œç”¨ï¼š</p>
<ul>
<li>0 - 1 ï¼Œ <code>FAST_IS_SWIFT_LEGACY</code> ï¼Œæ˜¯å¦æ¥è‡ª ABI é¢„ç¨³å®šç‰ˆæœ¬çš„ Swift ï¼›</li>
<li>1 - 2 ï¼Œ <code>FAST_IS_SWIFT_STABLE</code> ï¼Œæ˜¯å¦æ¥è‡ª ABI ç¨³å®šç‰ˆæœ¬çš„ Swift ï¼›</li>
<li>2 - 3 ï¼Œ <code>FAST_HAS_DEFAULT_RR</code> ï¼Œç±»æˆ–çˆ¶ç±»å«æœ‰é»˜è®¤çš„æŒæœ‰æˆ–å¼•ç”¨ï¼›</li>
<li>3 - 47 ï¼Œ <code>FAST_DATA_MASK</code> ï¼ŒæŒ‡å‘ <code>class_rw_t</code> ç»“æ„ä½“çš„æŒ‡é’ˆï¼›</li>
<li>47 - 63 ï¼Œå­—èŠ‚å¯¹é½ï¼Œå¡« 0 ã€‚</li>
</ul>
<p><code>class_rw_t</code> æ˜¯å¯è¯»å¯å†™ï¼Œ Read-Write ï¼Œåœ¨è¿è¡Œæ—¶ä¼šè¿›è¡Œè°ƒæ•´ï¼Œè€Œ <code>class_ro_t</code> æ˜¯åªè¯»çš„ï¼Œåœ¨ç¼–è¯‘æœŸå·²ç»ç¡®å®šï¼Œæ— æ³•è°ƒæ•´ã€‚</p>
<pre><code class="language-c">struct class_rw_t {
    // Be warned that Symbolication knows the layout of this structure.
    uint32_t flags;
    uint32_t version;

    // åªè¯»è¡¨çš„æŒ‡é’ˆï¼ˆconstï¼šä¸å¯ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘å†…å­˜ç©ºé—´ä¸­çš„æ•°æ®ï¼‰
    const class_ro_t *ro;

    // æ–¹æ³•ã€å±æ€§ã€åè®®ä¿¡æ¯ï¼Œå¯ç”¨äºè¿è¡Œæ—¶åŠ¨æ€æ·»åŠ 
    method_array_t methods;
    property_array_t properties;
    protocol_array_t protocols;

    // ...
};
</code></pre>
<p><code>class_ro_t</code> åœ¨ç¼–è¯‘æ—¶ä¼šè¢«åŠ¨æ€æ›¿æ¢ä¸º <code>class_rw_t</code> ï¼Œè€Œ <code>class_rw_t</code> åˆ™ä¼šé€šè¿‡æŒ‡é’ˆæŒ‡å‘ <code>class_ro_t</code> ï¼š</p>
<pre><code class="language-c">struct class_ro_t {
    // æ ‡å¿—ä½
    uint32_t flags;
    uint32_t instanceStart;
    // å®ä¾‹å¤§å°
    uint32_t instanceSize;
#ifdef __LP64__
    uint32_t reserved;
#endif

    const uint8_t * ivarLayout;

    // ç±»å
    const char * name;
    method_list_t * baseMethodList;
    protocol_list_t * baseProtocols;
    // æˆå‘˜å˜é‡
    const ivar_list_t * ivars;

    const uint8_t * weakIvarLayout;
    property_list_t *baseProperties;

    method_list_t *baseMethods() const {
        return baseMethodList;
    }
};
</code></pre>
<p>ä»ä¸Šé¢çš„ <code>class_rw_t</code> å’Œ <code>class_ro_t</code> å¯ä»¥çœ‹å‡ºä¸ºä»€ä¹ˆ Category ä¸æ”¯æŒæ·»åŠ å˜é‡ï¼Œå› ä¸º Category ç›¸å…³æ–¹æ³•å’Œå±æ€§æ˜¯æ·»åŠ åˆ° <code>class_rw_t</code> ä¸­çš„ï¼Œè€Œ <code>class_ro_t</code> è¡¨ç¤ºçš„ç¤ºä¾‹å¤§å°å’Œå±æ€§åœ¨ç¼–è¯‘æ—¶å·²ç»ç¡®å®šäº†ï¼Œä¸æ”¯æŒåœ¨è¿è¡Œæ—¶è¿›è¡Œä¿®æ”¹ã€‚</p>
<p>åŸºç±»ï¼š</p>
<p><img src="programming-languages/Objective-C/media/16295434389166.jpg" alt="" /></p>
<h2 id="isa-æŒ‡é’ˆ"><a class="header" href="#isa-æŒ‡é’ˆ">isa æŒ‡é’ˆ</a></h2>
<p><a href="https://kingcos.me//posts/2019/isa_in_objc/">Obj-C ä¸­çš„ isa æŒ‡é’ˆ</a></p>
<p><img src="programming-languages/Objective-C/media/16295434244296.jpg" alt="" /></p>
<p>å®ä¾‹å¯¹è±¡ä¸­çš„ <code>isa</code> æŒ‡å‘ç±»å¯¹è±¡ï¼Œç±»å¯¹è±¡ä¸­çš„ <code>isa</code> æŒ‡å‘å…ƒç±»å¯¹è±¡ï¼Œå…ƒç±»å¯¹è±¡ä¸­çš„ <code>isa</code> æŒ‡å‘æ ¹å…ƒç±»å¯¹è±¡ï¼ˆåŒ…æ‹¬æ ¹å…ƒç±»å¯¹è±¡ä¹ŸæŒ‡å‘è‡ªå·±ï¼‰ã€‚ <code>isa_t</code> é€šè¿‡ <code>union</code> æ¥å…±äº«å†…å­˜å ç”¨ï¼š</p>
<pre><code class="language-c">struct objc_object {
private:
    isa_t isa;

// ...
}

union isa_t {
    isa_t() { }
    isa_t(uintptr_t value) : bits(value) { }

    Class cls;
    uintptr_t bits;
#if defined(ISA_BITFIELD)
    struct {
        ISA_BITFIELD;  // defined in isa.h
    };
#endif
};

// isa.h
// ARM 64
# if __arm64__
#   define ISA_MASK        0x0000000ffffffff8ULL
#   define ISA_MAGIC_MASK  0x000003f000000001ULL
#   define ISA_MAGIC_VALUE 0x000001a000000001ULL
#   define ISA_BITFIELD                                                      \
      uintptr_t nonpointer        : 1;                                       \
      uintptr_t has_assoc         : 1;                                       \
      uintptr_t has_cxx_dtor      : 1;                                       \
      uintptr_t shiftcls          : 33; /*MACH_VM_MAX_ADDRESS 0x1000000000*/ \
      uintptr_t magic             : 6;                                       \
      uintptr_t weakly_referenced : 1;                                       \
      uintptr_t deallocating      : 1;                                       \
      uintptr_t has_sidetable_rc  : 1;                                       \
      uintptr_t extra_rc          : 19
#   define RC_ONE   (1ULL&lt;&lt;45)
#   define RC_HALF  (1ULL&lt;&lt;18)

// _uintptr_t.h
#ifndef _UINTPTR_T
#define _UINTPTR_T
typedef unsigned long           uintptr_t;
#endif /* _UINTPTR_T */
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
