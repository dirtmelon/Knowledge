<!DOCTYPE HTML>
<html lang="zh-CN" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Block - Knowledge</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../About.html">å…³äº</a></li><li class="chapter-item expanded "><a href="../../programming-languages/programming-languages.html">ç¼–ç¨‹è¯­è¨€</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../programming-languages/Swift/Swift.html">Swift</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Objective-C.html">Objective-C</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Objective-C.html">Runtime</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/associated-objects.html">Associated Objects</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/initialize.html">initialize</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/load.html">load</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Block.html" class="active">Block</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Category.html">Category</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Message-Sending-And-Forwarding.html">Message Sending And Forwarding</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/KVO.html">KVO</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/KVC.html">KVC</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/AutoreleasePool.html">AutoreleasePool</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/dealloc.html">dealloc</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Tagged-Pointer.html">Tagged Pointer</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/weak.html">weak</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Object.html">Object</a></li></ol></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/Objective-C.html">Tips</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/getting-subclasses-of-objective-c-class.html">å¦‚ä½•è·å–æŸä¸ªç±»çš„å…¨éƒ¨å­ç±»</a></li><li class="chapter-item expanded "><a href="../../programming-languages/Objective-C/objective-c-class-properties.html">Objective-C ç±»å±æ€§</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../iDev/iDev.html">iDev</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../iDev/Multithreading/Introduction.html">å¤šçº¿ç¨‹</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../iDev/Multithreading/NSOperation.html">NSOperation</a></li><li class="chapter-item expanded "><a href="../../iDev/Multithreading/Grand-Central-Dispatch.html">Grand Central Dispatch</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../books/books.html">é˜…è¯»</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../books/Homo-Deus-A-Brief-History-of-Tomorrow.html">æœªæ¥ç®€å²</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Knowledge</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/dirtmelon/Knowledge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="block"><a class="header" href="#block">Block</a></h1>
<h2 id="æ·±å…¥ç ”ç©¶-block-æ•è·å¤–éƒ¨å˜é‡å’Œ-__block-å®ç°åŸç†"><a class="header" href="#æ·±å…¥ç ”ç©¶-block-æ•è·å¤–éƒ¨å˜é‡å’Œ-__block-å®ç°åŸç†">æ·±å…¥ç ”ç©¶ Block æ•è·å¤–éƒ¨å˜é‡å’Œ __block å®ç°åŸç†</a></h2>
<p><a href="https://halfrost.com/ios_block/">æ·±å…¥ç ”ç©¶ Block æ•è·å¤–éƒ¨å˜é‡å’Œ __block å®ç°åŸç†</a></p>
<p>é‡Œé¢æœ‰æåˆ°ä½œç”¨åŸŸï¼š</p>
<p><img src="media/16295345348106.jpg" alt="" /></p>
<ul>
<li><code>_NSConcreteStackBlock</code> ï¼šåªç”¨åˆ°å¤–éƒ¨å±€éƒ¨å˜é‡ã€æˆå‘˜å±æ€§å˜é‡ï¼Œä¸”æ²¡æœ‰å¼ºæŒ‡é’ˆå¼•ç”¨çš„ <code>block</code> éƒ½æ˜¯ <code>StackBlock</code> ã€‚ <code>StackBlock</code> çš„ç”Ÿå‘½å‘¨æœŸç”±ç³»ç»Ÿæ§åˆ¶çš„ï¼Œä¸€æ—¦è¿”å›ä¹‹åï¼Œå°±è¢«ç³»ç»Ÿé”€æ¯äº†ã€‚</li>
<li><code>_NSConcreteMallocBlock</code> ï¼šæœ‰å¼ºæŒ‡é’ˆå¼•ç”¨æˆ– <code>copy</code> ä¿®é¥°çš„æˆå‘˜å±æ€§å¼•ç”¨çš„ <code>block</code> ä¼šè¢«å¤åˆ¶ä¸€ä»½åˆ°å †ä¸­æˆä¸º <code>MallocBlock</code> ï¼Œæ²¡æœ‰å¼ºæŒ‡é’ˆå¼•ç”¨å³é”€æ¯ï¼Œç”Ÿå‘½å‘¨æœŸç”±ç¨‹åºå‘˜æ§åˆ¶</li>
<li><code>_NSConcreteGlobalBlock</code> ï¼šæ²¡æœ‰ç”¨åˆ°å¤–ç•Œå˜é‡æˆ–åªç”¨åˆ°å…¨å±€å˜é‡ã€é™æ€å˜é‡çš„ <code>block</code> ä¸º <code>_NSConcreteGlobalBlock</code> ï¼Œç”Ÿå‘½å‘¨æœŸä»åˆ›å»ºåˆ°åº”ç”¨ç¨‹åºç»“æŸã€‚</li>
</ul>
<p><code>__block</code> ç»“æ„ä½“ <code>__forwarding</code> ï¼š</p>
<p><img src="media/16295347079014.jpg" alt="" /></p>
<h2 id="block-æŠ€å·§ä¸åº•å±‚è§£æ"><a class="header" href="#block-æŠ€å·§ä¸åº•å±‚è§£æ">Block æŠ€å·§ä¸åº•å±‚è§£æ</a></h2>
<p><a href="https://triplecc.github.io/2015/07/19/2015-08-27-blockji-qiao-yu-di-ceng-jie-xi/">BlockæŠ€å·§ä¸åº•å±‚è§£æ</a></p>
<p>Block çš„å®é™…ç»“æ„ï¼š</p>
<pre><code class="language-objectivec">/* Revised new layout. */
struct Block_descriptor {
    unsigned long int reserved;
    unsigned long int size;
    void (*copy)(void *dst, void *src);
    void (*dispose)(void *);
};

struct Block_layout {
    void *isa;
    int flags;
    int reserved;
    void (*invoke)(void *, ...);
    struct Block_descriptor *descriptor;
    /* Imported variables. */
};
</code></pre>
<p><code>_NSConcreteMallocBlock</code> æ— æ³•ç›´æ¥åˆ›å»ºï¼Œåªèƒ½ <code>_NSConcreteStackBlock</code> æ‹·è´å¾—åˆ°ï¼Œè€Œ Block çš„æ‹·è´æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ <code>_Block_copy_internal</code> å‡½æ•°ï¼Œæ‰€ä»¥ä» <code>_Block_copy_internal</code> å‡½æ•°ä¸­å¯ä»¥å¾—å‡º <code>_NSConcreteMallocBlock</code> æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼š</p>
<pre><code class="language-objectivec">static void *_Block_copy_internal(const void *arg, const int flags) {
    struct Block_layout *aBlock;
	...
    aBlock = (struct Block_layout *)arg;
	...
    // Its a stack block.  Make a copy.
    if (!isGC) {
    	// ç”³è¯·blockçš„å †å†…å­˜
        struct Block_layout *result = malloc(aBlock-&gt;descriptor-&gt;size);
        if (!result) return (void *)0;
        // æ‹·è´æ ˆä¸­blockåˆ°åˆšç”³è¯·çš„å †å†…å­˜ä¸­
        memmove(result, aBlock, aBlock-&gt;descriptor-&gt;size); // bitcopy first
        // reset refcount
        result-&gt;flags &amp;= ~(BLOCK_REFCOUNT_MASK);    // XXX not needed
        result-&gt;flags |= BLOCK_NEEDS_FREE | 1;
        // æ”¹å˜isaæŒ‡å‘_NSConcreteMallocBlockï¼Œå³å †blockç±»å‹
        result-&gt;isa = _NSConcreteMallocBlock;
        if (result-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSE) {
            //printf(&quot;calling block copy helper %p(%p, %p)...\n&quot;, aBlock-&gt;descriptor-&gt;copy, result, aBlock);
            (*aBlock-&gt;descriptor-&gt;copy)(result, aBlock); // do fixup
        }
        return result;
    }
    else {
        ...
    }
}
</code></pre>
<p>å‡½æ•°é€šè¿‡ <code>memmove</code> å°†æ ˆä¸­çš„ Block çš„å†…å®¹æ‹·è´åˆ°äº†å †ä¸­ï¼Œå¹¶ä½¿ <code>isa</code> æŒ‡å‘äº† <code>_NSConcreteMallocBlock</code> ã€‚</p>
<p>Block çš„æ‹·è´ä»£ç åœ¨ <code>_Block_copy_internal</code> å‡½æ•°ä¸­ï¼Œæ ¹æ® Block çš„ç±»å‹ä¸åŒï¼Œæ‹·è´è¿‡ç¨‹ä¸­çš„æ“ä½œä¹Ÿä¸åŒã€‚</p>
<p>æ ˆ Block çš„æ‹·è´ä¸ä»…æ˜¯æ‹·è´äº†å†…å®¹ï¼Œè€Œä¸”ç”±äºä»æ ˆæ‹·è´åˆ°å †ä¸­ï¼Œè¿˜ä¼šè¿›è¡Œä¸€äº›é¢å¤–çš„æ“ä½œï¼š</p>
<ol>
<li>å¾€ <code>flags</code> ä¸­å¹¶å…¥ <code>BLOCK_NEEDS_FREE</code> ï¼Œå¹¶å°†å¼•ç”¨è®¡æ•°è®¾ç½®ä¸º 1ï¼Œè¡¨ç¤º Block éœ€è¦é‡Šæ”¾ï¼Œéœ€è¦è‡ªè¡Œ <code>release</code> ï¼›</li>
<li>å¦‚æœæœ‰è¾…åŠ© copy å‡½æ•° ( <code>BLOCK_HAS_COPY_DISPOSE</code> )ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨è¾…åŠ©  copy å‡½æ•°æ¥æ‹·è´ Block æ•è·çš„å˜é‡ã€‚</li>
</ol>
<pre><code class="language-objectivec">...
struct Block_layout *result = malloc(aBlock-&gt;descriptor-&gt;size);
if (!result) return (void *)0;
memmove(result, aBlock, aBlock-&gt;descriptor-&gt;size); // bitcopy first
// reset refcount
result-&gt;flags &amp;= ~(BLOCK_REFCOUNT_MASK);    // XXX not needed
result-&gt;flags |= BLOCK_NEEDS_FREE | 1;
result-&gt;isa = _NSConcreteMallocBlock;
if (result-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSE) {
    //printf(&quot;calling block copy helper %p(%p, %p)...\n&quot;, aBlock-&gt;descriptor-&gt;copy, result, aBlock);
    (*aBlock-&gt;descriptor-&gt;copy)(result, aBlock); // do fixup
}
return result;
...
</code></pre>
<p>å † Block ç”±äºå·²ç»æ‹·è´è‡³å †ä¸­ï¼Œæ‰€ä»¥å…¶æ‹·è´æ“ä½œæ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆéœ€è¦åˆ¤æ–­æ˜¯å¦æœ‰ <code>BLOCK_FREE</code> ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¡¨ç¤ºæ˜¯å † Block ï¼Œé‚£ä¹ˆåªéœ€è¦æ‰§è¡Œ <code>latching_incr_int</code> æ“ä½œï¼Œå°† Block çš„å¼•ç”¨è®¡æ•°åŠ  1 å³å¯ï¼Œåªéœ€è¦å•çº¯åœ°æ”¹å˜å¼•ç”¨è®¡æ•°ï¼š</p>
<pre><code class="language-objectivec">...
if (aBlock-&gt;flags &amp; BLOCK_NEEDS_FREE) {
      // latches on high
      latching_incr_int(&amp;aBlock-&gt;flags);
      return aBlock;
}
...
</code></pre>
<p>å…¨å±€ Block ä¸éœ€è¦æ‰§è¡Œä»»ä½•æ“ä½œï¼Œåªæ˜¯ç›´æ¥è¿”å›äº†ä¼ å…¥çš„ Block ï¼š</p>
<pre><code class="language-objectivec">...
else if (aBlock-&gt;flags &amp; BLOCK_IS_GLOBAL) {
      return aBlock;
}
...
</code></pre>
<pre><code class="language-objectivec">// flags/_flagsç±»å‹
enum {
        /* See function implementation for a more complete description of these fields and combinations */
        // æ˜¯ä¸€ä¸ªå¯¹è±¡
        BLOCK_FIELD_IS_OBJECT   =  3,  /* id, NSObject, __attribute__((NSObject)), block, ... */
        // æ˜¯ä¸€ä¸ªblock
        BLOCK_FIELD_IS_BLOCK    =  7,  /* a block variable */
        // è¢«__blockä¿®é¥°çš„å˜é‡
        BLOCK_FIELD_IS_BYREF    =  8,  /* the on stack structure holding the __block variable */
        // è¢«__weakä¿®é¥°çš„å˜é‡ï¼Œåªèƒ½è¢«è¾…åŠ©copyå‡½æ•°ä½¿ç”¨
        BLOCK_FIELD_IS_WEAK     = 16,  /* declared __weak, only used in byref copy helpers */
        // blockè¾…åŠ©å‡½æ•°è°ƒç”¨ï¼ˆå‘Šè¯‰å†…éƒ¨å®ç°ä¸è¦è¿›è¡Œretainæˆ–è€…copyï¼‰
        BLOCK_BYREF_CALLER      = 128  /* called from __block (byref) copy/dispose support routines. */
    };

// è®¾ç½®ä¸åŒå±æ€§å¯¹åº”çš„flags/_flagså€¼
__block id                   128+3
__weak block id              128+3+16
__block (^Block)             128+7
__weak __block (^Block)      128+7+16

struct Block_byref {
    void *isa;
    struct Block_byref *forwarding;
    int flags; /* refcount; */
    int size;
    void (*byref_keep)(struct Block_byref *dst, struct Block_byref *src);
    void (*byref_destroy)(struct Block_byref *);
    /* long shared[0]; */
};

// åšä¸‹å¯¹æ¯”
struct __Block_byref_a_0 {
  void *__isa;
__Block_byref_a_0 *__forwarding;
 int __flags;
 int __size;
 int a;
};
</code></pre>
<p><code>__block</code> å°†åŸæ¥çš„åŸºæœ¬ç±»å‹åŒ…è£…æˆäº†å¯¹è±¡ã€‚å› ä¸ºä»¥ä¸Šä¸¤ä¸ªç»“æ„ä½“çš„å‰ 4 ä¸ªæˆå‘˜çš„ç±»å‹éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå†…å­˜ç©ºé—´æ’åˆ—ä¸€è‡´ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<pre><code class="language-objectivec">// è½¬æ¢æˆC++ä»£ç 
static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) {_Block_object_assign((void*)&amp;dst-&gt;a, (void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);}

// _Block_object_assignæºç 
void _Block_object_assign(void *destAddr, const void *object, const int flags) {
...
    else if ((flags &amp; BLOCK_FIELD_IS_BYREF) == BLOCK_FIELD_IS_BYREF)  {
        // copying a __block reference from the stack Block to the heap
        // flags will indicate if it holds a __weak reference and needs a special isa
        _Block_byref_assign_copy(destAddr, object, flags);
    }
...
}

// _Block_byref_assign_copyæºç 
static void _Block_byref_assign_copy(void *dest, const void *arg, const int flags) {
    // è¿™é‡Œå› ä¸ºå‰é¢4ä¸ªæˆå‘˜çš„å†…å­˜åˆ†å¸ƒä¸€æ ·ï¼Œæ‰€ä»¥ç›´æ¥è½¬æ¢åï¼Œä½¿ç”¨Block_byrefçš„æˆå‘˜å˜é‡åï¼Œèƒ½è®¿é—®åˆ°__Block_byref_a_0çš„å‰é¢4ä¸ªæˆå‘˜
    struct Block_byref **destp = (struct Block_byref **)dest;
    struct Block_byref *src = (struct Block_byref *)arg;
...
    else if ((src-&gt;forwarding-&gt;flags &amp; BLOCK_REFCOUNT_MASK) == 0) {
        // ä»mainå‡½æ•°å¯¹__Block_byref_a_0çš„åˆå§‹åŒ–ï¼Œå¯ä»¥çœ‹åˆ°åˆå§‹åŒ–æ—¶å°†flagsèµ‹å€¼ä¸º0
        // è¿™é‡Œè¡¨ç¤ºç¬¬ä¸€æ¬¡æ‹·è´ï¼Œä¼šè¿›è¡Œå¤åˆ¶æ“ä½œï¼Œå¹¶ä¿®æ”¹åŸæ¥flagsçš„å€¼
        // static int _Byref_flag_initial_value = BLOCK_NEEDS_FREE | 2;
        // å¯ä»¥çœ‹å‡ºï¼Œå¤åˆ¶åï¼Œä¼šå¹¶å…¥BLOCK_NEEDS_FREEï¼Œåé¢çš„2æ˜¯åŒ…è£…å¯¹è±¡çš„åˆå§‹å¼•ç”¨è®¡æ•°ï¼ˆæ ˆä¸ŠæŒæœ‰+å †ä¸ŠæŒæœ‰ï¼‰
        ...
        copy-&gt;flags = src-&gt;flags | _Byref_flag_initial_value;
        ...
    }
    // å·²ç»æ‹·è´åˆ°å †äº†ï¼Œåªå¢åŠ å¼•ç”¨è®¡æ•°
    else if ((src-&gt;forwarding-&gt;flags &amp; BLOCK_NEEDS_FREE) == BLOCK_NEEDS_FREE) {
        latching_incr_int(&amp;src-&gt;forwarding-&gt;flags);
    }
    // æ™®é€šçš„èµ‹å€¼ï¼Œé‡Œé¢æœ€åº•å±‚å°±*destptr = value;è¿™å¥è¡¨è¾¾å¼
    _Block_assign(src-&gt;forwarding, (void **)destp);
}
</code></pre>
<p>å¯¹è±¡çš„è¾…åŠ©å‡½æ•°ï¼š</p>
<p>æ²¡æœ‰ <code>__block</code> ä¿®é¥°ï¼š</p>
<pre><code class="language-objectivec">typedef void(^Block)();
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        NSObject *a = [[NSObject alloc] init];
        Block block = ^ {
            a;
        };
    }
    return 0;
}
</code></pre>
<p>é¦–å…ˆï¼Œåœ¨æ²¡æœ‰ <code>__block</code> ä¿®é¥°æ—¶ï¼Œå¯¹è±¡ç¼–è¯‘è½¬æ¢çš„ç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-objectivec">static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  NSObject *a = __cself-&gt;a; // bound by copy
            a;
        }
static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) {_Block_object_assign((void*)&amp;dst-&gt;a, (void*)src-&gt;a, 3/*BLOCK_FIELD_IS_OBJECT*/);}

static void __main_block_dispose_0(struct __main_block_impl_0*src) {_Block_object_dispose((void*)src-&gt;a, 3/*BLOCK_FIELD_IS_OBJECT*/);}

static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
  void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);
  void (*dispose)(struct __main_block_impl_0*);
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0),
</code></pre>
<p>å¯¹è±¡åœ¨æ²¡æœ‰ <code>__block</code> ä¿®é¥°æ—¶ï¼Œå¹¶æ²¡æœ‰äº§ç”Ÿ <code>__Block_byref_a_0</code> ç»“æ„ä½“ï¼Œåªæ˜¯å°†æ ‡å¿—ä½ä¿®æ”¹ä¸º <code>BLOCK_FIELD_IS_OBJECT</code> ã€‚è€Œåœ¨ <code>_Block_object_assign</code> ä¸­å¯¹åº”çš„åˆ¤æ–­åˆ†æ”¯ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-objectivec"> v...
else if ((flags &amp; BLOCK_FIELD_IS_OBJECT) == BLOCK_FIELD_IS_OBJECT) {
    _Block_retain_object(object);
    _Block_assign((void *)object, destAddr);
}
...
</code></pre>
<p>Block åœ¨æ•è·å¯¹è±¡æ—¶ä¼šè¿›è¡Œ <code>retain</code> æ“ä½œï¼Œå¢åŠ å¼•ç”¨è®¡æ•°ã€‚</p>
<p>åœ¨æœ‰ <code>__block</code> ä¿®é¥°æ—¶ï¼š</p>
<pre><code class="language-objectivec">typedef void(^Block)();
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        __block NSObject *a = [[NSObject alloc] init];
        Block block = ^ {
            a;
        };
    }
    return 0;
}

// è½¬æ¢åï¼š
struct __Block_byref_a_0 {
  void *__isa;
__Block_byref_a_0 *__forwarding;
 int __flags;
 int __size;
 void (*__Block_byref_id_object_copy)(void*, void*);
 void (*__Block_byref_id_object_dispose)(void*);
 NSObject *a;
};
int main(int argc, const char * argv[]) {
    /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool;
attribute__((__blocks__(byref))) __Block_byref_a_0 a = {(void*)0,(__Block_byref_a_0 *)&amp;a, 33554432, sizeof(__Block_byref_a_0), __Block_byref_id_object_copy_131, __Block_byref_id_object_dispose_131,....};
Block block = (void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_a_0 *)&amp;a, 570425344);
}

// ä»¥ä¸‹çš„40è¡¨ç¤º__Block_byref_a_0å¯¹è±¡açš„ä½ç§»ï¼ˆ4ä¸ªæŒ‡é’ˆ(32å­—èŠ‚)ï¼‹2ä¸ªintå˜é‡(8å­—èŠ‚)ï¼40å­—èŠ‚ï¼‰
static void __Block_byref_id_object_copy_131(void *dst, void *src) {
 _Block_object_assign((char*)dst + 40, *(void * *) ((char*)src + 40), 131);
}
static void __Block_byref_id_object_dispose_131(void *src) {
 _Block_object_dispose(*(void * *) ((char*)src + 40), 131);
}
</code></pre>
<p><code>__Block_byref_a_0</code> æ–°å¢ä¸¤ä¸ªå†…å­˜ç®¡ç†çš„è¾…åŠ©å‡½æ•° <code>__Block_byref_id_object_copy</code> å’Œ <code>__Block_byref_id_object_dispose</code> ã€‚æœ€åçš„ <code>131</code> å‚æ•°è¡¨ç¤º <code>BLOCK_BYREF_CALLER|BLOCK_FIELD_IS_OBJECT</code> ï¼Œ <code>BLOCK_BYREF_CALLER</code> ç”¨äºè¡¨æ˜ä¸éœ€è¦å¯¹ <code>__block</code> ä¿®é¥°çš„ <code>a</code> å¯¹è±¡è¿›è¡Œ <code>retain</code> æˆ–è€… <code>copy</code> ï¼š</p>
<pre><code class="language-objectivec">if ((flags &amp; BLOCK_BYREF_CALLER) == BLOCK_BYREF_CALLER) {
	...
    else {
        // do *not* retain or *copy* __block variables whatever they are
        _Block_assign((void *)object, destAddr);
    }
}
</code></pre>
<p><code>_Block_byref_assign_copy</code> å‡½æ•°çš„ä»¥ä¸‹ä»£ç ä¼šå¯¹ä¸Šé¢çš„è¾…åŠ©å‡½æ•° <code>__Block_byref_id_object_copy_131</code> è¿›è¡Œè°ƒç”¨ï¼Œ <code>570425344</code> è¡¨ç¤º <code>BLOCK_HAS_COPY_DISPOSE|BLOCK_HAS_DESCRIPTOR</code> ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œä»¥ä¸‹ç›¸å…³æºç ï¼š</p>
<pre><code class="language-objectivec">if (src-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSE) {
    // Trust copy helper to copy everything of interest
    // If more than one field shows up in a byref block this is wrong XXX
    copy-&gt;byref_keep = src-&gt;byref_keep;
    copy-&gt;byref_destroy = src-&gt;byref_destroy;
    (*src-&gt;byref_keep)(copy, src);
}
</code></pre>
<h2 id="ä¸€é“-block-é¢è¯•é¢˜çš„æ·±å…¥æŒ–æ˜"><a class="header" href="#ä¸€é“-block-é¢è¯•é¢˜çš„æ·±å…¥æŒ–æ˜">ä¸€é“ Block é¢è¯•é¢˜çš„æ·±å…¥æŒ–æ˜</a></h2>
<p><a href="https://juejin.im/post/5eaa2a87e51d454db7436726">ä¸€é“Blocké¢è¯•é¢˜çš„æ·±å…¥æŒ–æ˜</a></p>
<p>å€Ÿç”± <code>NSNotificationCenter</code> å’Œ <code>token</code> è¯´æ˜å®é™…ç¼–ç ä¸­ Block éœ€è¦æ³¨æ„çš„åœ°æ–¹ä»¥åŠåŸç†ã€‚</p>
<h2 id="block-è¯­æ³•å¿«é€ŸæŸ¥è¯¢"><a class="header" href="#block-è¯­æ³•å¿«é€ŸæŸ¥è¯¢">Block è¯­æ³•å¿«é€ŸæŸ¥è¯¢</a></h2>
<p>ç”±äº Objective-C çš„ Block è¯­æ³•å®åœ¨æ˜¯å¤ªéš¾è®°äº†ï¼Œåè§‚ Swift ğŸ˜‚ ï¼Œæ‰€ä»¥æœ‰äº†è¿™ä¹ˆä¸€ä¸ªå¿«é€ŸæŸ¥çœ‹ Block è¯­æ³•çš„ç½‘ç«™ï¼š</p>
<p><a href="http://fuckingblocksyntax.com/">How Do I Declare A Block in Objective-C?</a></p>
<h2 id="obj-c-ä¸­çš„-block"><a class="header" href="#obj-c-ä¸­çš„-block">Obj-C ä¸­çš„ Block</a></h2>
<p><a href="https://kingcos.me/posts/2019/block_in_obj-c/">Obj-C ä¸­çš„ Block</a></p>
<p>Objective-C ä¸­çš„ Block ç›¸å½“äºåŒ¿åå‡½æ•°ã€‚</p>
<p>é€šè¿‡ <code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main.cpp</code> è½¬æ¢ä¸º C++ ä»£ç å¯ä»¥æŸ¥çœ‹ Block çš„ç»“æ„ä½“ã€‚</p>
<p><code>__main_3_block_impl_0</code> ä¸ºå…·ä½“ Block å¯¹åº”çš„ <code>struct</code> ï¼ŒåŒ…å« <code>__block_impl</code> å’Œ <code>__main_3_block_desc_0</code> ã€‚</p>
<pre><code class="language-objectivec">// Block å®ç°çš„ç»“æ„ä½“
struct __block_impl {
  void *isa;     // isa æŒ‡é’ˆï¼Œå³ Block ä¹Ÿæ˜¯ id ç±»å‹ï¼Œå³ Obj-C å¯¹è±¡
  int Flags;     // æ ‡è®°ï¼Œé»˜è®¤ä¼šè¢«åˆå§‹åŒ–ä¸º 0
  int Reserved;  // ä¿ç•™åŸŸï¼ˆABI å…¼å®¹ï¼‰ï¼Œé»˜è®¤ 0
  void *FuncPtr; // Block ä»£ç å—çš„å‡½æ•°æŒ‡é’ˆ
};

// â¡ï¸ Block ç»“æ„ä½“
struct __main_3_block_impl_0 {
  struct __block_impl impl;           // å®ç°ï¼ˆéæŒ‡é’ˆï¼‰
  struct __main_3_block_desc_0* Desc; // æè¿°ä¿¡æ¯ï¼ˆæŒ‡é’ˆï¼‰
  // æ„é€ å‡½æ•°
  __main_3_block_impl_0(void *fp, struct __main_3_block_desc_0 *desc, int flags=0) {
    impl.isa = &amp;_NSConcreteStackBlock; // Block ä½œä¸º Obj-C å¯¹è±¡ï¼Œé‚£ä¹ˆ isa å°†æŒ‡å‘å…¶ç±»å¯¹è±¡ï¼Œå³ _NSConcreteStackBlock
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};

// Block å†…ä»£ç å—å°è£…åœ¨è¯¥ C è¯­è¨€é™æ€å‡½æ•°ä¸­ï¼Œå‡½æ•°å‘½åè§„åˆ™ï¼š__CALLER_METHOD_NAME_block_func_NUMBER
// ç±»ä¼¼ Obj-C å®ä¾‹æ–¹æ³•å‚æ•° self æˆ– C++ å®ä¾‹æ–¹æ³•å‚æ•° thisï¼Œ__cself ä¸ºæŒ‡å‘ Block ç»“æ„ä½“çš„å˜é‡
static void __main_3_block_func_0(struct __main_3_block_impl_0 *__cself) {
  NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_ps_0m9gnvtj0893vpf1cr595djh0000gn_T_main_b9596e_mi_0);
}

// Block æè¿°ä¿¡æ¯çš„ç»“æ„ä½“é™æ€å˜é‡
static struct __main_3_block_desc_0 {
  size_t reserved;   // ä¿ç•™åŸŸï¼Œé»˜è®¤ 0
  size_t Block_size; // Block å¤§å°ï¼Œsizeof æ•´ä¸ª Block ç»“æ„ä½“ â¬‡ï¸
} __main_3_block_desc_0_DATA = { 0, sizeof(struct __main_3_block_impl_0)};

// ä¸»å‡½æ•°
int main_3(int argc, const char * argv[]) {
    // é€šè¿‡ __main_3_block_impl_0 ç»“æ„ä½“çš„æ„é€ å‡½æ•°åˆå§‹åŒ–ï¼Œå‚æ•°ä¸ºé™æ€å‡½æ•°å’Œæè¿°ä¿¡æ¯é™æ€å˜é‡çš„åœ°å€ï¼Œå°†åœ°å€å­˜å‚¨åœ¨ block å˜é‡ä¸­
    // å¿½ç•¥ç±»å‹è½¬æ¢ï¼šblock = &amp;__main_3_block_impl_0(__main_3_block_func_0, &amp;__main_3_block_desc_0_DATA));
    void(*block)(void) = ((void (*)())&amp;__main_3_block_impl_0((void *)__main_3_block_func_0, &amp;__main_3_block_desc_0_DATA));

    // æ‰§è¡Œ Blockï¼ˆå‚æ•° block å³é™æ€å‡½æ•°ä¸­çš„å‚æ•° __cselfï¼‰
    // å¿½ç•¥ç±»å‹è½¬æ¢ï¼šblock-&gt;FuncPtr(block);
    // åœ¨ __main_block_impl_0 ç»“æ„ä½“ä¸­ï¼Œimpl æ˜¯ç¬¬ä¸€ä¸ªå˜é‡ï¼Œå› æ­¤å…¶ä¸ç»“æ„ä½“æœ¬èº«çš„é¦–åœ°å€ä¸€è‡´ï¼Œå› æ­¤å¯ä»¥å¼ºè½¬
    ((void (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);

    return 0;
}
</code></pre>
<p><img src="media/16295350902641.jpg" alt="" /></p>
<p>Block å¯¹äºæ•è·å˜é‡çš„ä¸åŒä¹Ÿä¼šæœ‰ä¸åŒçš„å¤„ç†</p>
<ol>
<li>å±€éƒ¨å˜é‡ï¼Œè¿›è¡Œå€¼æ‹·è´ä¼ é€’ï¼Œä¿®æ”¹åŸæœ‰çš„å€¼ä¸å½±å“ Block æ‰€æ•è·çš„å€¼ï¼›</li>
<li>æ˜¾å¼æˆ–è€…éšå¼æ•è· <code>self</code> ï¼ŒBlock ä¼šæŒæœ‰ <code>self</code> çš„å¼•ç”¨ï¼Œæœ‰å¯èƒ½è§¦å‘æˆ‘ä»¬å¸¸è¯´çš„å¾ªç¯å¼•ç”¨ï¼›</li>
<li>é™æ€å±€éƒ¨å˜é‡ï¼Œ è™½ç„¶ä½œç”¨åŸŸåœ¨ä»£ç å—å†…ï¼Œä½†æ˜¯å…¶ç”Ÿå‘½å‘¨æœŸæ˜¯å…¨å±€çš„ï¼Œæ‰€ä»¥ Block ç›´æ¥æŒæœ‰å¯¹å˜é‡çš„å¼•ç”¨ï¼›</li>
<li>å…¨å±€å˜é‡ï¼ŒBlock ä¸ä¼šæ•è·ï¼Œä½¿ç”¨æ—¶ç›´æ¥è¿›è¡Œè¯»å–ã€‚</li>
</ol>
<p>Block çš„ç±»å‹ï¼š</p>
<p><code>__NSGlobalBlock__</code> ï¼Œä¸æ•è·è‡ªåŠ¨å˜é‡ï¼Œå³è¿è¡Œæ—¶ä¸ä¾èµ–ä¸Šä¸‹æ–‡ï¼Œæ”¾åœ¨å†…å­˜çš„æ•°æ®æ®µ (Data Section) ï¼Œå’Œå…¨å±€å˜é‡åŒä¸€ä¸ª Section ã€‚å¯¹ <code>__NSGlobalBlock__</code> æ‰§è¡Œæ‹·è´åå¾—åˆ°çš„ä»æ˜¯ <code>__NSGlobalBlock__</code> ã€‚</p>
<p><code>__NSStackBlock__</code> ï¼Œå½“ Block æ•è·äº†å¤–ç•Œè‡ªåŠ¨å˜é‡æ—¶ï¼Œåˆ™ä¼šè¢«åˆ†é…åœ¨æ ˆåŒºï¼Œå˜æˆ <code>__NSStackBlock__</code> ï¼Œå¼€å‘è€…æ— éœ€å…³å¿ƒå…¶ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p><code>__NSMallocBlock__</code> ï¼ŒBlock åˆ†é…åœ¨å †åŒºï¼Œéœ€è¦å¼€å‘è€…æ‰‹åŠ¨ç®¡ç†å…¶ç”Ÿå‘½å‘¨æœŸï¼ŒARC ä¸‹ç¼–è¯‘å™¨ä¼šæ ¹æ®æƒ…å†µå°† <code>__NSStackBlock__</code> ç±»å‹çš„ Block è‡ªåŠ¨ copy åˆ°å †ä¸Šï¼Œå°† Block çš„ <code>isa</code> è®¾ç½®ä¸º <code>_NSConcreteMallocBlock</code> ï¼Œä»¥ä¸‹æ“ä½œä¼šå°† Block copy åˆ°å †ä¸Šï¼š</p>
<ol>
<li>å¼ºæŒ‡é’ˆæˆ–è€…å±æ€§æŒ‡å‘çš„ Block ï¼›</li>
<li>Block ä½œä¸ºå‡½æ•°å€¼ä¼šè‡ªåŠ¨æ‹·è´ï¼›</li>
<li>Block ä½œä¸º Cocoa API ä¸­æ–¹æ³•åå«æœ‰ <code>usingBlock</code>  çš„å‚æ•°æ—¶ä¼šè‡ªåŠ¨æ‹·è´ï¼›</li>
<li>Block ä½œä¸º GCD API å‚æ•°æ—¶ä¼šè¢«è‡ªåŠ¨æ‹·è´ï¼›</li>
</ol>
<p><code>__block</code> å£°æ˜çš„å˜é‡ï¼š</p>
<p>Block å†…å¯ä»¥ç›´æ¥ä¿®æ”¹</p>
<p><code>__block</code> å£°æ˜ä¼šå°†å˜é‡å°è£…ä¸ºå¯¹åº”çš„ç»“æ„ä½“ï¼Œè€Œä¸åŒçš„å˜é‡å°±ä¼šç”Ÿæˆä¸åŒçš„ç»“æ„ä½“ã€‚ <code>__block</code> å˜é‡ä»å£°æ˜åï¼Œæ— è®ºåœ¨ Block å†…å¤–å»è®¿é—®å‡æ˜¯é€šè¿‡ç»“æ„ä½“çš„ <code>__forwarding</code> æŒ‡é’ˆå³ <code>blockVar.__forwarding-&gt;blockVar</code> ã€‚å½“ <code>__block</code> å˜é‡åœ¨æ ˆä¸Šæ—¶ï¼Œ <code>blockVar.__forwarding-&gt;blockVar</code> å°±ç­‰åŒäºç›´æ¥é€šè¿‡ <code>blockVar-&gt;blockVar</code> æ¥è®¿é—®çš„ï¼Œå› ä¸ºæ­¤æ—¶ <code>__forwarding</code> å°±æŒ‡å‘æ ˆä¸Šçš„ç»“æ„ä½“æœ¬èº«ï¼›è€Œå½“ Block æ‹·è´åˆ°å †ä¸Šæ—¶ï¼Œ <code>__block</code> å˜é‡ä¹Ÿä¼šè¢«æ‹·è´åˆ°å †ä¸Šï¼Œæ­¤æ—¶æ ˆä¸Šçš„ <code>__forwarding</code> å°†æ›¿æ¢ä¸ºæŒ‡å‘å †ä¸Šçš„ç»“æ„ä½“ï¼Œè€Œå †ä¸Šçš„ç»“æ„ä½“é‡Œçš„ <code>__forwarding</code> å°†æŒ‡å‘å †ä¸Šçš„ç»“æ„ä½“æœ¬èº«ï¼Œä»è€Œä¿è¯åç»­çš„æ•°æ®å˜åŠ¨å‡æ˜¯åœ¨å †ä¸Šã€‚</p>
<p>ä¸Šé¢è¯´åˆ° Block ä¼šç”Ÿæˆä¸åŒçš„ç»“æ„ä½“ï¼Œä¹Ÿå°±è¯´ä½¿ç”¨ Block å®ç°çš„åŠŸèƒ½ä»£ç é‡ä¼šè¾ƒå¤šã€‚</p>
<p><img src="media/16295351225941.jpg" alt="" /></p>
<p>å¾ªç¯å¼•ç”¨ï¼š</p>
<pre><code class="language-objectivec">typedef void(^BlockType_5)(void);

@interface Foo_9 : NSObject
@property (nonatomic, assign) NSUInteger bar;
@property (nonatomic, copy) BlockType_5 block;
@end

@implementation Foo_9
- (void)dealloc
{
#if !__has_feature(objc_arc)
    [super dealloc];
#endifNSLog(@&quot;dealloc&quot;);
}

- (void)foo_1 {
    // Block æ•è·äº† selfï¼Œå…¶å¼ºå¼•ç”¨äº† Blockï¼Œå¯¼è‡´åŒæ–¹éƒ½æ— æ³•é‡Šæ”¾
    self.block = ^{
        // WARNING: Capturing 'self' strongly in this block is likely to lead to a retain cycle
        NSLog(@&quot;%lu&quot;, (unsigned long)self.bar);
        // WARNING: Block implicitly retains 'self'; explicitly mention 'self' to indicate this is intended behavior
        NSLog(@&quot;%lu&quot;, (unsigned long)_bar); // self-&gt;_bar
    };
}
@end

int main_22(int argc, const char * argv[]) {
#if __has_feature(objc_arc)
    Foo_9 *f = [[Foo_9 alloc] init];
    f.bar = 20;

    f.block = ^{
        // Block æ•è·äº† fï¼Œå…¶å¼ºå¼•ç”¨äº† Blockï¼Œå¯¼è‡´åŒæ–¹éƒ½æ— æ³•é‡Šæ”¾
        // WARNING: Capturing 'f' strongly in this block is likely to lead to a retain cycle
        NSLog(@&quot;%lu&quot;, (unsigned long)f.bar);
    };

    f.block();
    [f foo_1];

    // Never call dealloc
#endifreturn 0;
}

// OUTPUT:
// 20
</code></pre>
<p><img src="media/16295351549792.jpg" alt="" /></p>
<h2 id="ç”¨-block-å®ç°-delegate-æ–¹æ³•"><a class="header" href="#ç”¨-block-å®ç°-delegate-æ–¹æ³•">ç”¨ Block å®ç° delegate æ–¹æ³•</a></h2>
<p><a href="https://triplecc.github.io/2017/07/28/2017-07-28-blockhe-nsmethodsignature/">ç”¨ Block å®ç°å§”æ‰˜æ–¹æ³•</a></p>
<p>ä½¿ç”¨ <code>NSInvocation</code> ï¼Œæ¶ˆæ¯è½¬åŒ–æœºåˆ¶å’Œ Block ç»“æ„ä½“è·å– <code>NSMethodSignature</code> ã€‚</p>
<p><code>NSInvocation</code> éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š</p>
<p>æ–¹æ³•çš„è‡ªå®šä¹‰å‚æ•°ä» index 2 å¼€å§‹ï¼Œå‰ä¸¤ä¸ªå‚æ•°æ˜¯æ¥æ”¶æ¶ˆæ¯çš„å¯¹è±¡å’Œæ–¹æ³•çš„ SEL ï¼›</p>
<p><code>-getArgument:atIndex:</code> å’Œ <code>-getReturnvalue:</code> æ–¹æ³•ä¸­è·å–çš„å¯¹è±¡ä¸ä¼šè¿›è¡Œ <code>retain</code> ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ä½¿ç”¨å…·ä½“çš„å¯¹è±¡æŒ‡é’ˆï¼Œåªèƒ½ä½¿ç”¨ <code>vod *</code> ï¼š</p>
<pre><code class="language-objectivec">// é”™è¯¯ä»£ç 
NSString *bar = nil;
[invocation getArgument:&amp;bar atIndex:2];

NSString *result = nil;
[invocation getReturnValue:&amp;result];

// æ­£ç¡®ä»£ç 
void *bar = nil;
//__unsafe_unretained NSString *bar = nil;
//__weak NSString *bar = nil;
[invocation getArgument:&amp;bar atIndex:2];

void *result = nil;
//__unsafe_unretained NSString *result = nil;
//__weak NSString *result = nil;
[invocation getReturnValue:&amp;result];
</code></pre>
<p>å¦‚æœæ˜¯åœ¨ä¸¤ä¸ª <code>NSInvocation</code> å¯¹è±¡é—´ä¼ é€’å‚æ•°/è¿”å›å€¼ï¼Œå¯ä»¥ç›´æ¥ä¼ å…¥æŒ‡é’ˆè·å–å’Œè®¾ç½®ç›®æ ‡åœ°å€ï¼š</p>
<pre><code class="language-objectivec">....
NSInvocation *invocation = [NSInvocation invocationWithMethodSignature:signature];
NSInvocation *shadowInvocation = [NSInvocation invocationWithMethodSignature:signature];
....
void *resultBuffer = malloc(invocation.methodSignature.methodReturnLength);
memset(resultBuffer, 0, invocation.methodSignature.methodReturnLength);

[invocation getReturnValue:resultBuffer];
[shadowInvocation setReturnValue:resultBuffer];
....
free(resultBuffer);
</code></pre>
<p>ä»åè®®ä¸­è·å–æ–¹æ³•ç­¾åï¼Œåˆ©ç”¨ <code>protocol_getMethodDescription</code> å‡½æ•°ï¼Œå¯ä»¥è·å–åˆ°æè¿°ç±»å‹çš„ C å­—ç¬¦ä¸²ï¼Œå†é€šè¿‡è¿™ä¸ªå­—ç¬¦ä¸²æ„é€ æ–¹æ³•ç­¾åã€‚é’ˆå¯¹åè®®ä¸­çš„æ¥å£æœ‰ <code>required</code> å’Œ <code>optional</code> ä¸¤ç§ï¼Œå¹¶ä¸”ä¸å…è®¸é‡å¤è¿™ä¸€ç‰¹ç‚¹ï¼Œå¯ä»¥åˆ›å»ºæ„é€ æ–¹æ³•ç­¾åçš„å‡½æ•°ï¼š</p>
<pre><code class="language-objectivec">static NSMethodSignature *tbv_getProtocolMethodSignature(Protocol *protocol, SEL selector, BOOL isInstanceMethod) {
    struct objc_method_description methodDescription = protocol_getMethodDescription(protocol, selector, YES, isInstanceMethod);
    if (!methodDescription.name) {
        methodDescription = protocol_getMethodDescription(protocol, selector, NO, isInstanceMethod);
    }
    return [NSMethodSignature signatureWithObjCTypes:methodDescription.types];
}
</code></pre>
<p>ç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦ä¸º <code>required</code> ï¼Œå¦‚æœä» <code>required</code> ä¸­è·å–ä¸åˆ°å¯¹åº”çš„ <code>objc_method_description</code> ï¼Œå†ä» <code>optional</code> ä¸­è·å–ï¼š</p>
<p><a href="https://developer.apple.com/documentation/objectivec/1418830-protocol_getmethoddescription">Apple Developer Documentation</a></p>
<p>ä» Block ä¸­è·å–æ–¹æ³•ç­¾åï¼Œè™½ç„¶è‹¹æœæ²¡æœ‰æä¾›å…¬å¼€çš„ API ç»™å¼€å‘è€…è·å–ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ä¸€ä¸ªä¸ Block ç»“æ„ç›¸åŒçš„ <code>struct</code> ï¼Œé€šè¿‡è¿™ä¸ª <code>struct</code> æ¥è·å–æ–¹æ³•ç­¾åï¼š</p>
<pre><code class="language-objectivec">// Block internals.
typedef NS_OPTIONS(int, TBVBlockFlags) {
    TBVBlockFlagsHasCopyDisposeHelpers = (1 &lt;&lt; 25),
    TBVBlockFlagsHasSignature          = (1 &lt;&lt; 30)
};
typedef struct tbv_block {
    __unused Class isa;
    TBVBlockFlags flags;
    __unused int reserved;
    void (__unused *invoke)(struct tbv_block *block, ...);
    struct {
        unsigned long int reserved;
        unsigned long int size;
        // requires TBVBlockFlagsHasCopyDisposeHelpers
        void (*copy)(void *dst, const void *src);
        void (*dispose)(const void *);
        // requires TBVBlockFlagsHasSignature
        const char *signature;
        const char *layout;
    } *descriptor;
    // imported variables
} *TBVBlockRef;

// ä½¿ç”¨è‡ªå®šä¹‰çš„ TBVBlockRef è·å– descriptor
static NSMethodSignature *tbv_signatureForBlock(id block) {
    TBVBlockRef layout = (__bridge TBVBlockRef)(block);
    
    // æ²¡æœ‰ç­¾åï¼Œç›´æ¥è¿”å›ç©º
    if (!(layout-&gt;flags &amp; TBVBlockFlagsHasSignature)) {
        return nil;
    }
    
    // è·å– descriptor æŒ‡é’ˆ
    void *desc = layout-&gt;descriptor;
    
    // è·³è¿‡ reserved å’Œ size æˆå‘˜
    desc += 2 * sizeof(unsigned long int);
    
    // å¦‚æœæœ‰ Helpers å‡½æ•°ï¼Œ è·³è¿‡ copy å’Œ dispose æˆå‘˜
    if (layout-&gt;flags &amp; TBVBlockFlagsHasCopyDisposeHelpers) {
        desc += 2 * sizeof(void *);
    }
    
    // desc ä¸º signature æŒ‡é’ˆçš„åœ°å€ï¼Œè½¬æ¢ä¸‹ç»™ objcTypes
    char *objcTypes = (*(char **)desc);
    
    return [NSMethodSignature signatureWithObjCTypes:objcTypes];
}
</code></pre>
<p>ä¸ºäº†ç¡®ä¿ Block å’Œæ–¹æ³•ä¸¤è€…çš„å‚æ•°æ˜¯ç›¸åŒçš„ï¼Œéœ€è¦å¯¹ä¸¤è€…çš„ç­¾åè¿›è¡ŒåŒ¹é…ï¼Œå³æ£€éªŒè¿”å›å€¼ç±»å‹å’Œå‚æ•°ç±»å‹æ˜¯å¦ç›¸åŒï¼š</p>
<pre><code class="language-objectivec">static BOOL tbv_isCompatibleBlockSignature(NSMethodSignature *blockSignature, NSMethodSignature *methodSignature) {
    NSCParameterAssert(blockSignature);
    NSCParameterAssert(methodSignature);
    
    if ([blockSignature isEqual:methodSignature]) {
        return YES;
    }
    
    // block å‚æ•°ä¸ªæ•°éœ€è¦å°äº method çš„å‚æ•°ä¸ªæ•° (é’ˆå¯¹ block è°ƒç”¨æ›¿æ¢ method è°ƒç”¨)
    // ä¸¤è€…è¿”å›ç±»å‹éœ€è¦ä¸€è‡´
    if (blockSignature.numberOfArguments &gt;= methodSignature.numberOfArguments ||
        blockSignature.methodReturnType[0] != methodSignature.methodReturnType[0]) {
        return NO;
    }
    
    // å‚æ•°ç±»å‹éœ€è¦ä¸€è‡´
    BOOL compatibleSignature = YES;
    
    // è‡ªå®šä¹‰å‚æ•°ä»ç¬¬äºŒä¸ªå¼€å§‹
    for (int idx = 2; idx &lt; blockSignature.numberOfArguments; idx++) {

        // block ç›¸æ¯” method ï¼Œé»˜è®¤å‚æ•°å°‘äº† SEL
        // method: id(@) SEL(:) ....
        // block: block(@?) ....
        const char *methodArgument = [methodSignature getArgumentTypeAtIndex:idx];
        const char *blockArgument = [blockSignature getArgumentTypeAtIndex:idx - 1];
        if (!methodArgument || !blockArgument || methodArgument[0] != blockArgument[0]) {
            compatibleSignature = NO;
            break;
        }
    }
    
    return compatibleSignature;
}
</code></pre>
<p>è°ƒç”¨ Block çš„ <code>NSInvocation</code> ï¼Œç”±äºç›´æ¥è°ƒç”¨çš„æ˜¯ <code>delegate</code> æ–¹æ³•ï¼Œåœ¨è½¬å‘æ—¶æ¥æ”¶åˆ°çš„æ˜¯æ–¹æ³•å¯¹åº”çš„ <code>NSInvocation</code> ï¼Œæ‰€ä»¥éœ€è¦å°†å…¶çš„å‚æ•°å’Œè¿”å›å€¼ä¼ é€’ç»™ Block çš„ <code>NSInvocation</code> ï¼š</p>
<pre><code class="language-objectivec">- (void)invokeWithMethodInvocation:(NSInvocation *)methodInvocation {
    NSParameterAssert(methodInvocation);
    NSAssert([self.methodSignature isEqual:methodInvocation.methodSignature], @&quot;Method invocation's signature is not compatible with block signature&quot;);
    
    NSMethodSignature *methodSignature = methodInvocation.methodSignature;
    NSInvocation *blockInvocation = [NSInvocation invocationWithMethodSignature:self.blockSignature];
    
    void *argumentBuffer = NULL;
    for (int idx = 2; idx &lt; methodSignature.numberOfArguments; idx++) {
        
        // è·å–å‚æ•°ç±»å‹
        const char *type = [methodSignature getArgumentTypeAtIndex:idx];
        NSUInteger size = 0;
        
        // è·å–å‚æ•°å¤§å°
        NSGetSizeAndAlignment(type, &amp;size, NULL);
        
        // å‚æ•°ç¼“å­˜
        if (!(argumentBuffer = reallocf(argumentBuffer, size))) {
            return;
        }
        
        // æŠŠ method çš„å‚æ•°ä¼ é€’ç»™ block
        [methodInvocation getArgument:argumentBuffer atIndex:idx];
        [blockInvocation setArgument:argumentBuffer atIndex:idx - 1];
    }
    
    // è°ƒç”¨ block
    [blockInvocation invokeWithTarget:self.block];
    
    // è¿”å›å€¼ç¼“å­˜
    if (methodSignature.methodReturnLength &amp;&amp;
        (argumentBuffer = reallocf(argumentBuffer, methodSignature.methodReturnLength))) {
        
        // æŠŠ block çš„è¿”å›å€¼ä¼ é€’ç»™ method
        [blockInvocation getReturnValue:argumentBuffer];
        [methodInvocation setReturnValue:argumentBuffer];
    }
    
    // é‡Šæ”¾ç¼“å­˜
    free(argumentBuffer);
}

// reallocf å‡½æ•°æ˜¯ realloc å‡½æ•°çš„å¢å¼ºç‰ˆï¼Œå®ƒå¯ä»¥åœ¨åè€…æ— æ³•ç”³è¯·åˆ°å †ç©ºé—´æ—¶ï¼Œé‡Šæ”¾æ—§çš„å †ç©ºé—´ï¼š
void *reallocf(void *p, size_t s) {
    void *tmp = realloc(p, s);
    if(tmp) return tmp;
    free(p);
    return NULL;
}
</code></pre>
<p>æœ€åæ˜¯é€šè¿‡æ¶ˆæ¯è½¬å‘çš„ <code>forwardInvocaion:</code> æ–¹æ³•è¿›è¡Œè½¬å‘ï¼š</p>
<pre><code class="language-objectivec">- (void)forwardInvocation:(NSInvocation *)invocation {
    TBVBlockInvocation *blockInvocation = self.selectorInvocationMap[NSStringFromSelector(invocation.selector)];
    [blockInvocation invokeWithMethodInvocation:invocation];
}

- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel {
    return self.selectorInvocationMap[NSStringFromSelector(sel)].methodSignature;
}

- (BOOL)respondsToSelector:(SEL)aSelector {
    return !!self.selectorInvocationMap[NSStringFromSelector(aSelector)];
}
</code></pre>
<h2 id="å¦‚ä½•è·å–-block-æ•è·çš„å¯¹è±¡"><a class="header" href="#å¦‚ä½•è·å–-block-æ•è·çš„å¯¹è±¡">å¦‚ä½•è·å– Block æ•è·çš„å¯¹è±¡</a></h2>
<p><a href="https://triplecc.github.io/2019/08/15/%E8%81%8A%E8%81%8A%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E7%9A%84%E6%A3%80%E6%B5%8B/">èŠèŠå¾ªç¯å¼•ç”¨çš„æ£€æµ‹</a></p>
<p>ç”±äº Objective-C ä½¿ç”¨å¼•ç”¨è®¡æ•°ä½œä¸ºå†…å­˜ç®¡ç†æ–¹æ³•ï¼Œä¸” Block ä¼šå¼ºå¼•ç”¨æ‰€æ•è·çš„å¯¹è±¡ï¼Œæ‰€ä»¥ Block ç»å¸¸ä¼šé€ æˆå¼•ç”¨å¾ªç¯ã€‚æœ¬æ–‡è®²è¿°äº†å¦‚ä½•é€šè¿‡ Block çš„å¸ƒå±€ï¼Œæ•è·å˜é‡æ’åºæ¥è·å– Block å¼ºå¼•ç”¨çš„å¯¹è±¡ã€‚</p>
<p>Block æ•è·çš„å¯¹è±¡ä¼šç»Ÿä¸€æ”¾åœ¨ layout çš„ <code>descriptor</code> åé¢ï¼Œå³ <code>sr_block_layout</code> ç»“æ„ä½“çš„ <code>imported variables</code> éƒ¨åˆ†ï¼Œè¿™ç§æ“ä½œå¯ä»¥çœ‹ä½œåœ¨ <code>sr_block_layout</code> å°¾éƒ¨å®šä¹‰äº†ä¸€ä¸ª 0 é•¿æ•°ç»„ï¼Œå¯ä»¥æ ¹æ®å®é™…æ•è·å˜é‡çš„å¤§å°ï¼Œç»™æ•è·åŒºåŸŸç”³è¯·å¯¹åº”çš„å†…å­˜ç©ºé—´ï¼Œåªä¸è¿‡è¿™ä¸€æ“ä½œç”±ç¼–è¯‘å™¨å®Œæˆ :</p>
<pre><code class="language-objectivec">struct sr_block_layout {
    void *isa;
    int flags;
    int reserved;
    void (*invoke)(void *, ...);
    struct sr_block_descriptor *descriptor;
    char captured[0];
};

// æ ‡å¿—ä½ä¸ä¸€æ ·ï¼Œè¿™ä¸ªç»“æ„çš„å®é™…å¸ƒå±€ä¹Ÿä¼šæœ‰å·®åˆ«ï¼Œè¿™é‡Œç®€å•åœ°æ”¾åœ¨ä¸€èµ·å¥½é˜…è¯»
struct sr_block_descriptor {
    unsigned long reserved; // Block_descriptor_1
    unsigned long size; // Block_descriptor_1
    void (*)(void *dst, void *src);  // Block_descriptor_2 BLOCK_HAS_COPY_DISPOSE
    void (*dispose)(void *); // Block_descriptor_2
    const char *signature; // Block_descriptor_3 BLOCK_HAS_SIGNATURE
    const char *layout; // Block_descriptor_3 contents depend on BLOCK_HAS_EXTENDED_LAYOUT
};
</code></pre>
<p>Block çš„æ•è·åŒºåŸŸå¸ƒå±€æœ‰ç‰¹å®šçš„æ’åºè§„åˆ™ï¼š</p>
<p><a href="https://github.com/llvm-mirror/clang/blob/e870496ea61feb01aa0eb4dc599be0ddf2d03878/lib/CodeGen/CGBlocks.cpp#L366-L384">llvm-mirror/clang</a></p>
<p>åœ¨å¯¹é½å­—èŠ‚æ•° ( <code>alignment</code> ) ä¸ç›¸ç­‰æ—¶ï¼Œæ•è·çš„å®ä½“æŒ‰ç…§ <code>alignment</code> é™åºæ’åº ( C ç»“æ„ä½“æ¯”è¾ƒç‰¹æ®Šï¼Œå³ä½¿æ•´ä½“å ç”¨ç©ºé—´æ¯”æŒ‡é’ˆå˜é‡å¤§ï¼Œä¹Ÿæ’åœ¨å¯¹è±¡æŒ‡é’ˆåé¢)ï¼Œå¦åˆ™æŒ‰ç…§ä»¥ä¸‹ç±»å‹æ’åºï¼š</p>
<ol>
<li><code>__strong</code>Â ä¿®é¥°å¯¹è±¡æŒ‡é’ˆå˜é‡</li>
<li><code>__block</code>Â ä¿®é¥°å¯¹è±¡æŒ‡é’ˆå˜é‡</li>
<li><code>__weak</code>Â ä¿®é¥°å¯¹è±¡æŒ‡é’ˆå˜é‡</li>
<li>å…¶ä»–å˜é‡</li>
</ol>
<p>ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre><code class="language-objectivec">NSObject *o1 = [NSObject new];
__weak NSObject *o2 = o1;
__block NSObject *o3 = o1;
unsigned long long j = 4;
int i = 3;
char c = 'a';
void (^blk)(void) = ^{
    i;
    c;
    o1;
    o2;
    o3;
    j;
};
</code></pre>
<p>è¾“å‡ºï¼š</p>
<pre><code class="language-objectivec">(lldb) x/69bx layout
0x10200d940: 0x70 0x21 0x7b 0xa6 0xff 0x7f 0x00 0x00
0x10200d948: 0x02 0x00 0x00 0xc3 0x00 0x00 0x00 0x00
0x10200d950: 0xf0 0x1b 0x00 0x00 0x01 0x00 0x00 0x00
0x10200d958: 0xf8 0x20 0x00 0x00 0x01 0x00 0x00 0x00
0x10200d960: 0xa0 0xf6 0x00 0x02 0x01 0x00 0x00 0x00  // o1
0x10200d968: 0x90 0xd9 0x00 0x02 0x01 0x00 0x00 0x00  // o3
0x10200d970: 0xa0 0xf6 0x00 0x02 0x01 0x00 0x00 0x00  // o2
0x10200d978: 0x04 0x00 0x00 0x00 0x00 0x00 0x00 0x00  // j
0x10200d980: 0x03 0x00 0x00 0x00 0x61                 // i c
(lldb) p o1
(NSObject *) $1 = 0x000000010200f6a0
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå°ç«¯æ¨¡å¼ä¸‹ï¼Œæ•è·çš„ o1 å’Œ o2 æŒ‡é’ˆå˜é‡å€¼ä¸º <code>0x10200f6a0</code> ï¼Œå¯¹åº”å†…å­˜åœ°å€ä¸º <code>0x10200d960</code> å’Œ <code>0x10200d970</code> ï¼Œè€Œ o3 å› ä¸ºè¢« <code>__block</code> ä¿®é¥°ï¼Œç¼–è¯‘å™¨ä¸º o3 æ•è·å˜é‡åŒ…è£…äº†ä¸€å±‚ <code>byref</code> ç»“æ„ï¼Œæ‰€ä»¥å…¶å€¼ä¸º <code>byref</code> ç»“æ„çš„åœ°å€ 0x102000d990 ï¼Œè€Œä¸æ˜¯ 0x10200f6a0 ï¼Œæ•è·çš„ j å˜é‡åœ°å€ä¸º 0x10200d978ï¼Œi å˜é‡åœ°å€ä¸º 0x10200d980ï¼Œc å­—ç¬¦å˜é‡ç´§éšå…¶åã€‚</p>
<p>é€šè¿‡åˆ†æ <code>descriptor</code> çš„ <code>layout</code> ä¿¡æ¯åˆ™å¯ä»¥è·å–æ•è·åˆ°çš„å¯¹è±¡ä¸ªæ•°ã€‚</p>
<p><a href="https://github.com/tripleCC/Laboratory/blob/d5d98d343a918d3883a2d5274da212cd44f50414/AppleSources/libclosure-73/Block_private.h#L283-L314">tripleCC/Laboratory</a></p>
<p><a href="https://github.com/llvm-mirror/clang/blob/e5d2fdc902b0fb4e0a8f5a7d549728e1f2a648ad/lib/CodeGen/CGObjCMac.cpp#L2614-L2865">llvm-mirror/clang</a></p>
<pre><code class="language-objectivec">// block
// Extended layout encoding.

// Values for Block_descriptor_3-&gt;layout with BLOCK_HAS_EXTENDED_LAYOUT
// and for Block_byref_3-&gt;layout with BLOCK_BYREF_LAYOUT_EXTENDED

// If the layout field is less than 0x1000, then it is a compact encoding 
// of the form 0xXYZ: X strong pointers, then Y byref pointers, 
// then Z weak pointers.

// If the layout field is 0x1000 or greater, it points to a 
// string of layout bytes. Each byte is of the form 0xPN.
// Operator P is from the list below. Value N is a parameter for the operator.

enum {
    ...
    BLOCK_LAYOUT_NON_OBJECT_BYTES = 1,    // N bytes non-objects
    BLOCK_LAYOUT_NON_OBJECT_WORDS = 2,    // N words non-objects
    BLOCK_LAYOUT_STRONG           = 3,    // N words strong pointers
    BLOCK_LAYOUT_BYREF            = 4,    // N words byref pointers
    BLOCK_LAYOUT_WEAK             = 5,    // N words weak pointers
    ...
};

// clang 
/// InlineLayoutInstruction - This routine produce an inline instruction for the
/// block variable layout if it can. If not, it returns 0. Rules are as follow:
/// If ((uintptr_t) layout) &lt; (1 &lt;&lt; 12), the layout is inline. In the 64bit world,
/// an inline layout of value 0x0000000000000xyz is interpreted as follows:
/// x captured object pointers of BLOCK_LAYOUT_STRONG. Followed by
/// y captured object of BLOCK_LAYOUT_BYREF. Followed by
/// z captured object of BLOCK_LAYOUT_WEAK. If any of the above is missing, zero
/// replaces it. For example, 0x00000x00 means x BLOCK_LAYOUT_STRONG and no
/// BLOCK_LAYOUT_BYREF and no BLOCK_LAYOUT_WEAK objects are captured.`
</code></pre>
<p><code>descriptor-&gt;layout</code> ä¼šåŒ…å«æ•è·çš„å¯¹è±¡ä¸ªæ•°ï¼Œä¸”ä¼šæ ¹æ® <code>__strong</code> ï¼Œ <code>__block</code> å’Œ <code>__weak</code> è¿›è¡ŒåŒºåˆ†ã€‚</p>
<pre><code class="language-objectivec">NSObject *o1 = [NSObject new];
__block NSObject *o3 = o1;
__weak NSObject *o2 = o1;
NSObject *o4 = o1;
... // 5 - 18
NSObject *o19 = o1;
void (^blk)(void) = ^{
    o1;
    o2;
    o3;
    o4;
    ... // 5 - 18
    o19;
};
</code></pre>
<pre><code class="language-objectivec">(lldb) p/x (long)layout-&gt;descriptor-&gt;layout
(long) $0 = 0x0000000100002f44
(lldb) x/8bx layout-&gt;descriptor-&gt;layout
0x100002f44: 0x3f 0x30 0x40 0x50 0x00 0x76 0x31 0x36
</code></pre>
<p>ç”±äºç»“æ„ä½“çš„å¸ƒå±€é¡ºåºåœ¨ç”Ÿå‘½æ—¶å°±ç¡®å®šäº†ï¼Œæ— æ³•åƒ Block é‚£æ ·åœ¨ç¼–è¯‘æ—¶å†æ ¹æ®å˜é‡ç±»å‹ï¼Œä¿®é¥°ç¬¦è¿›è¡Œè°ƒæ•´ï¼Œæ‰€ä»¥å¦‚æœç»“æ„ä½“ä¸­æœ‰ç±»å‹ä¸ºå¯¹è±¡æŒ‡é’ˆçš„å­—æ®µï¼Œå°±éœ€è¦é¢å¤–çš„ä¿¡æ¯æ¥è¿›è¡Œè®°å½•ï¼Œè¿™ä¹Ÿä¼šå½±å“ <code>layout</code> ã€‚</p>
<p>ä½¿ç”¨ <code>__block</code> ä¿®é¥°çš„æ•è·å˜é‡é¦–å…ˆä¼šè½¬æ¢æˆ <code>byref</code> ç»“æ„ï¼Œç„¶åå†ç”±è¿™ä¸ªç»“æ„å»æŒæœ‰å®é™…çš„å˜é‡ï¼Œ Block åªè´Ÿè´£ç®¡ç† <code>byref</code> ï¼š</p>
<pre><code class="language-objectivec">struct sr_block_byref {
    void *isa;
    struct sr_block_byref *forwarding;
    volatile int32_t flags; // contains ref count
    uint32_t size;
    // requires BLOCK_BYREF_HAS_COPY_DISPOSE
    void (*byref_keep)(struct sr_block_byref *dst, struct sr_block_byref *src);
    void (*byref_destroy)(struct sr_block_byref *);
    // requires BLOCK_BYREF_LAYOUT_EXTENDED
    const char *layout;
};
</code></pre>
<p>è¿™é‡Œä½¿ç”¨ <code>layout</code> çš„åŸå› æ˜¯éœ€è¦æ ¹æ®ä¸åŒçš„æ•è·å˜é‡è®°å½•ä¸åŒçš„ä¿¡æ¯ï¼Œå…·ä½“çš„å®ç°å¯ä»¥æŸ¥çœ‹åŸæ–‡ã€‚</p>
<p>äº†è§£å®Œ Block çš„æ•è·åŒºåŸŸçš„å†…å­˜å¸ƒå±€åï¼Œå°±å¯ä»¥é€šè¿‡å†…å­˜å¸ƒå±€æ¥è·å–å¼ºå¼•ç”¨å¯¹è±¡äº†ï¼š</p>
<ol>
<li>è¢« Block å¼ºå¼•ç”¨</li>
<li>è¢« byref ç»“æ„å¼ºå¼•ç”¨</li>
</ol>
<p>å®Œæ•´çš„ä»£ç åœ¨è¿™é‡Œï¼š</p>
<p><a href="https://github.com/tripleCC/Laboratory/blob/9982b333c6b8d1cd7cb9ed17430906afebf1f8bb/BlockStrongReferenceObject/BlockStrongReferenceObject/SRBlockStrongReferenceCollector.m">tripleCC/Laboratory</a></p>
<h2 id="å¦ä¸€ç§è·å–-block-å¼ºå¼•ç”¨å¯¹è±¡çš„æ–¹å¼"><a class="header" href="#å¦ä¸€ç§è·å–-block-å¼ºå¼•ç”¨å¯¹è±¡çš„æ–¹å¼">å¦ä¸€ç§è·å– Block å¼ºå¼•ç”¨å¯¹è±¡çš„æ–¹å¼</a></h2>
<p><a href="https://github.com/draveness/analyze/blob/master/contents/FBRetainCycleDetector/iOS%20%E4%B8%AD%E7%9A%84%20block%20%E6%98%AF%E5%A6%82%E4%BD%95%E6%8C%81%E6%9C%89%E5%AF%B9%E8%B1%A1%E7%9A%84.md">draveness/analyze</a></p>
<p><a href="https://github.com/facebook/FBRetainCycleDetector/blob/ecd369ed1e03eb22178199091fecdba6c9964189/FBRetainCycleDetector/Layout/Blocks/FBBlockStrongLayout.m#L29-L102">facebook/FBRetainCycleDetector</a></p>
<p>FBRetainCycleDetector ä¹Ÿæä¾›äº†è·å– Block å¼ºå¼•ç”¨å¯¹è±¡çš„åŠŸèƒ½ï¼Œä¸ä¸Šé¢çš„åˆ†æ Block æ•è·åŒºåŸŸçš„å†…å­˜å¸ƒå±€æ–¹å¼ä¸åŒï¼Œä½¿ç”¨äº†ä¸€ç§æ¯”è¾ƒå–å·§çš„æ–¹å¼ã€‚</p>
<p>è·å– <code>dispose_helper</code> ï¼Œ <code>dispose_helper</code> ä½œä¸º Block çš„è¾…åŠ©å‡½æ•°ï¼Œåœ¨ Block ææ„æ—¶ä¼šè°ƒç”¨ï¼Œç„¶åç»™å¼ºå¼•ç”¨å¯¹è±¡å‘é€ <code>release</code> æ¶ˆæ¯ï¼Œå€Ÿç”¨è¿™ä¸ªç‰¹æ€§è¿›è¡Œå¤„ç†ã€‚</p>
<pre><code class="language-objectivec">struct BlockDescriptor {
	unsigned long int reserved;                // NULL
	unsigned long int size;
	// optional helper functions
	void (*copy_helper)(void *dst, void *src); // IFF (1&lt;&lt;25)
	void (*dispose_helper)(void *src);         // IFF (1&lt;&lt;25)
	const char *signature;                     // IFF (1&lt;&lt;30)
};
</code></pre>
<p>å¦å¤–ä¸€ä¸ªè¾…åŠ©ç±»å°±æ˜¯ <code>FBBlockStrongRelationDetector</code> ï¼Œ <code>FBBlockStrongRelationDetector</code> é‡å†™äº† <code>release</code> æ–¹æ³•å’Œæ–°å¢äº†ä¸€ä¸ª <code>trueRelease</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-objectivec">- (oneway void)release
{
  _strong = YES;
}

- (oneway void)trueRelease
{
  [super release];
}
</code></pre>
<p><code>FBBlockStrongRelationDetector</code> åŒæ—¶ä¹Ÿå¯ä»¥è¢«å½“ä½œ Block æ¥å¤„ç†ï¼Œå½“ Block  ä¸­åˆå¼•ç”¨äº† Block æ—¶ï¼Œå®ƒä¼šå°è¯•è°ƒç”¨ <code>byref_dispose</code> ï¼Œæ‰€ä»¥ <code>FBBlockStrongRelationDetector</code> ä¹Ÿå®šä¹‰äº†å’Œ Block ç›¸åŒçš„å˜é‡å¸ƒå±€ï¼š</p>
<pre><code class="language-objectivec">struct _block_byref_block;
@interface FBBlockStrongRelationDetector : NSObject
{
  // __block fakery
  void *forwarding;
  int flags;   //refcount;
  int size;
  void (*byref_keep)(struct _block_byref_block *dst, struct _block_byref_block *src);
  void (*byref_dispose)(struct _block_byref_block *);
  void *captured[16];
}
</code></pre>
<p>åœ¨è·å–å¼ºå¼•ç”¨å¯¹è±¡ç´¢å¼•çš„å®ç°ä¸­ï¼Œä¼šåœ¨è‡ªåŠ¨é‡Šæ”¾è¿Ÿä¸­æ‰§è¡Œ <code>dispose_helper(obj)</code> æ–¹æ³•ï¼Œç»™æ¯ä¸ª å¼ºå¼•ç”¨å¯¹è±¡å¯¹åº”çš„ <code>FBBlockStrongRelationDetector</code> å‘é€ <code>release</code> æ¶ˆæ¯ï¼Œè¿™æ ·å°±å¯ä»¥æ‹¿åˆ°å®ƒä»¬çš„ç´¢å¼•å€¼ï¼Œä»è€Œè·å–å¯¹åº”çš„å¯¹è±¡ã€‚</p>
<pre><code class="language-objectivec">static NSIndexSet *_GetBlockStrongLayout(void *block) {
	...
	void (*dispose_helper)(void *src) = blockLiteral-&gt;descriptor-&gt;dispose_helper;
	const size_t ptrSize = sizeof(void *);	
	const size_t elements = (blockLiteral-&gt;descriptor-&gt;size + ptrSize - 1) / ptrSize;
	
	void *obj[elements];
	void *detectors[elements];
	
	for (size_t i = 0; i &lt; elements; ++i) {
		FBBlockStrongRelationDetector *detector = [FBBlockStrongRelationDetector new];
		obj[i] = detectors[i] = detector;
	}
	
	@autoreleasepool {
		dispose_helper(obj);
	}
	NSMutableIndexSet *layout = [NSMutableIndexSet indexSet];
	
	for (size_t i = 0; i &lt; elements; ++i) {
		FBBlockStrongRelationDetector *detector = (FBBlockStrongRelationDetector *)(detectors[i]);
		if (detector.isStrong) {
			[layout addIndex:i];
		}
		
		[detector trueRelease];
	}
	
	return layout;
}
</code></pre>
<h2 id="llvm-å…³äº-block-çš„æ–‡æ¡£"><a class="header" href="#llvm-å…³äº-block-çš„æ–‡æ¡£">LLVM å…³äº Block çš„æ–‡æ¡£</a></h2>
<p><a href="https://clang.llvm.org/docs/Block-ABI-Apple.html">Clang 12 documentation</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../programming-languages/Objective-C/load.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../programming-languages/Objective-C/Category.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../programming-languages/Objective-C/load.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../programming-languages/Objective-C/Category.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
